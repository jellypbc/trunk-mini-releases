(()=>{"use strict";var e=[,(e,t,n)=>{let i;n.r(t),n.d(t,{DatadogLogSink:()=>Pe,Replicache:()=>zr,TEST_LICENSE_KEY:()=>Hr,TeeLogSink:()=>u,TransactionClosedError:()=>gt,consoleLogSink:()=>c,createReflectServer:()=>Fe,filterAsyncIterable:()=>ts,isScanIndexOptions:()=>wt,makeIDBName:()=>qr,makeScanResult:()=>bn,mergeAsyncIterables:()=>Xr,version:()=>m}),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}()),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/objectWithoutProperties'");throw e.code="MODULE_NOT_FOUND",e}()),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}()),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}());const r=["message"];function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e){var t,n,i,r=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,i=Symbol.iterator);r--;){if(n&&null!=(t=e[n]))return t.call(e);if(i&&null!=(t=e[i]))return new l(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function l(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return l=function(e){this.s=e,this.n=e.next},l.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new l(e)}var u=class{constructor(e){this._sinks=e}log(e,...t){for(let n of this._sinks)n.log(e,...t)}async flush(){await Promise.all(this._sinks.map((e=>{var t;return null===(t=e.flush)||void 0===t?void 0:t.call(e)})))}},c={log(e,...t){console[e](...t)}},h=class extends class{constructor(e,t="info"){this.debug=void 0,this.info=void 0,this.error=void 0;let n=t=>(...n)=>e.log(t,...n);switch(t){case"debug":this.debug=n("debug");case"info":this.info=n("info");case"error":this.error=n("error")}}}{constructor(e="info",t=c){super(t,e),this._level=e,this._logSink=t}addContext(e,t){let n=void 0===t?e:`${e}=${t}`,i={log:(e,...t)=>{this._logSink.log(e,n,...t)}};return new h(this._level,i)}};function d(){return Math.random().toString(36).substring(2)}var f={name:"@rocicorp/reflect-server",description:"Multiplayer server for Replicache",version:"0.11.0",repository:"github:rocicorp/reflect-server",license:"SEE LICENSE IN https://roci.dev/terms.html",main:"out/reflect-server.js",module:"out/reflect-server.js",types:"out/reflect-server.d.ts",type:"module",scripts:{format:"prettier --write 'src/**/*.{js,jsx,json,ts,tsx,html,css,md}' '*.{cjs,js,jsx,json,ts,tsx,html,css,md}'","check-format":"prettier --check '**/*.{js,jsx,json,ts,tsx,html,css,md}' '*.{cjs,js,jsx,json,ts,tsx,html,css,md}'",lint:"eslint --ext .ts,.tsx,.js,.jsx src/",build:"rm -rf out && npm run build-dts && node build.js","build-dts":"rm -rf out/.dts/ && tsc --emitDeclarationOnly --outDir out/.dts/ && rollup --config rollup.config.js && rm -rf out/.dts",dev:"miniflare --live-reload --debug",test:"npm run build && node --experimental-vm-modules node_modules/jest/bin/jest.js","types:check":"tsc --noEmit",prepack:"npm run lint && npm run test && npm run build"},engines:{node:">=16.14.0 || >=17.1"},devDependencies:{"@cloudflare/workers-types":"^3.8.0","@rocicorp/lock":"^1.0.1","@rocicorp/logger":"^2.2.0","@types/jest":"^27.5.0","@typescript-eslint/eslint-plugin":"^5.22.0","@typescript-eslint/parser":"^5.22.0",esbuild:"^0.14.38",eslint:"^8.14.0",jest:"^28.0.3","jest-environment-miniflare":"^2.4.0",miniflare:"^2.4.0",prettier:"^2.6.2",replicache:"^10.0.0",rollup:"^2.71.1","rollup-plugin-dts":"^4.2.1",superstruct:"^0.15.4","ts-jest":"^28.0.1",typescript:"^4.6.4"},files:["out/reflect-server.d.ts","out/reflect-server.js"]},{version:m}=f,p="x-reflect-user-data",w=class extends TypeError{constructor(e,t){let n,{message:i}=e,s=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/objectWithoutProperties'");throw e.code="MODULE_NOT_FOUND",e}())(e,r),{path:a}=e;super(0===a.length?i:"At path: "+a.join(".")+" -- "+i),this.value=void 0,this.key=void 0,this.type=void 0,this.refinement=void 0,this.path=void 0,this.branch=void 0,this.failures=void 0,Object.assign(this,s),this.name=this.constructor.name,this.failures=()=>{var i;return null!=(i=n)?i:n=[e,...t()]}}};function y(e){return"object"==typeof e&&null!=e}function v(e){return"string"==typeof e?JSON.stringify(e):""+e}function g(e,t,n,i){if(!0===e)return;!1===e?e={}:"string"==typeof e&&(e={message:e});let{path:r,branch:s}=t,{type:o}=n,{refinement:l,message:u="Expected a value of type `"+o+"`"+(l?" with refinement `"+l+"`":"")+", but received: `"+v(i)+"`"}=e;return a(a({value:i,type:o,refinement:l,key:r[r.length-1],path:r,branch:s},e),{},{message:u})}function*b(e,t,n,i){(function(e){return y(e)&&"function"==typeof e[Symbol.iterator]})(e)||(e=[e]);for(let r of e){let e=g(r,t,n,i);e&&(yield e)}}function*O(e,t,n={}){let{path:i=[],branch:r=[e],coerce:s=!1,mask:a=!1}=n,o={path:i,branch:r};if(s&&(e=t.coercer(e,o),a&&"type"!==t.type&&y(t.schema)&&y(e)&&!Array.isArray(e)))for(let n in e)void 0===t.schema[n]&&delete e[n];let l=!0;for(let n of t.validator(e,o))l=!1,yield[n,void 0];for(let[n,u,c]of t.entries(e,o)){let t=O(u,c,{path:void 0===n?i:[...i,n],branch:void 0===n?r:[...r,u],coerce:s,mask:a});for(let i of t)i[0]?(l=!1,yield[i[0],void 0]):s&&(u=i[1],void 0===n?e=u:e instanceof Map?e.set(n,u):e instanceof Set?e.add(u):y(e)&&(e[n]=u))}if(l)for(let n of t.refiner(e,o))l=!1,yield[n,void 0];l&&(yield[void 0,e])}var D=class{constructor(e){this.TYPE=void 0,this.type=void 0,this.schema=void 0,this.coercer=void 0,this.validator=void 0,this.refiner=void 0,this.entries=void 0;let{type:t,schema:n,validator:i,refiner:r,coercer:s=(e=>e),entries:a=function*(){}}=e;this.type=t,this.schema=n,this.entries=a,this.coercer=s,this.validator=i?(e,t)=>b(i(e,t),t,this,e):()=>[],this.refiner=r?(e,t)=>b(r(e,t),t,this,e):()=>[]}assert(e){return _(e,this)}create(e){return function(e,t){let n=k(e,t,{coerce:!0});if(n[0])throw n[0];return n[1]}(e,this)}is(e){return function(e,t){return!k(e,t)[0]}(e,this)}mask(e){return function(e,t){let n=k(e,t,{coerce:!0,mask:!0});if(n[0])throw n[0];return n[1]}(e,this)}validate(e,t={}){return k(e,this,t)}};function _(e,t){let n=k(e,t);if(n[0])throw n[0]}function k(e,t,n={}){let i=O(e,t,n),r=function(e){let{done:t,value:n}=e.next();return t?void 0:n}(i);if(r[0])return[new w(r[0],(function*(){for(let e of i)e[0]&&(yield e[0])})),void 0];return[void 0,r[1]]}function E(e,t){return new D({type:e,schema:null,validator:t})}function U(e){return new D({type:"array",schema:e,*entries(t){if(e&&Array.isArray(t))for(let[n,i]of t.entries())yield[n,i,e]},coercer:e=>Array.isArray(e)?e.slice():e,validator:e=>Array.isArray(e)||"Expected an array value, but received: "+v(e)})}function x(){return E("boolean",(e=>"boolean"==typeof e))}function N(e){let t=v(e),n=typeof e;return new D({type:"literal",schema:"string"===n||"number"===n||"boolean"===n?e:null,validator:n=>n===e||"Expected the literal `"+t+"`, but received: "+v(n)})}function C(){return E("number",(e=>"number"==typeof e&&!isNaN(e)||"Expected a number, but received: "+v(e)))}function I(){return E("string",(e=>"string"==typeof e||"Expected a string, but received: "+v(e)))}function M(e){let t=E("never",(()=>!1));return new D({type:"tuple",schema:null,*entries(n){if(Array.isArray(n)){let i=Math.max(e.length,n.length);for(let r=0;r<i;r++)yield[r,n[r],e[r]||t]}},validator:e=>Array.isArray(e)||"Expected an array, but received: "+v(e)})}function S(e){let t=Object.keys(e);return new D({type:"type",schema:e,*entries(n){if(y(n))for(let i of t)yield[i,n[i],e[i]]},validator:e=>y(e)||"Expected an object, but received: "+v(e)})}function L(e){let t=e.map((e=>e.type)).join(" | ");return new D({type:"union",schema:null,coercer:(t,n)=>(e.find((e=>{let[n]=e.validate(t,{coerce:!0});return!n}))||E("unknown",(()=>!0))).coercer(t,n),validator(n,i){let r=[];for(let t of e){let[...e]=O(n,t,i),[s]=e;if(!s[0])return[];for(let[t]of e)t&&r.push(t)}return["Expected the value to satisfy a union of `"+t+"`, but received: "+v(n),...r]}})}var T=S({userID:I()}),j=S({roomID:I()}),A=U(S({userID:I(),clientID:I()})),R="/connect",F="/api/auth/v0/invalidateForUser",P="/api/auth/v0/invalidateForRoom",H="/api/auth/v0/invalidateAll",$="/api/auth/v0/revalidateConnections",G="/api/auth/v0/connections";function W(e="Bad Request"){return new Response(e,{status:400})}function q(e,t,n,i){var r;let s=new URL(e.url);async function a(r,s,a,o){var l,u;if(!a)return W("Unsupported path.");if("authApiKey"===o&&(void 0===n||e.headers.get("x-reflect-auth-api-key")!==n))return function(e="Unauthorized"){return new Response(e,{status:401})}();if(e.method.toLowerCase()!==r.toLowerCase())return null!==(l=t.debug)&&void 0!==l&&l.call(t,`Unsupported method ${e.method.toLowerCase()}`),Promise.resolve(new Response(`Method not allowed. Use "${r}".`,{status:405}));let c=await s(e);return c.errorResponse?c.errorResponse:(null!==(u=t.debug)&&void 0!==u&&u.call(t,"Calling handler"),a.call(i,t,e,c.value))}switch(null===(r=t.debug)||void 0===r||r.call(t,"Dispatching path",s.pathname),s.pathname){case R:return a("get",V,i.connect);case F:return a("post",(e=>B(e,T)),i.authInvalidateForUser,"authApiKey");case P:return a("post",(e=>B(e,j)),i.authInvalidateForRoom,"authApiKey");case H:return a("post",V,i.authInvalidateAll,"authApiKey");case $:return a("post",V,i.authRevalidateConnections,"authApiKey");case G:return a("get",V,i.authConnections,"authApiKey");default:return Promise.resolve(W("Unsupported path."))}}var V=()=>Promise.resolve({value:void 0,errorResponse:void 0});async function B(e,t){let n;try{n=await e.clone().json()}catch(e){return{errorResponse:new Response("Body must be valid json.",{status:400}),value:void 0}}let i=k(n,t);return i[0]?{errorResponse:W("Body schema error. "+i[0].message),value:void 0}:{value:i[1],errorResponse:void 0}}function K(){let e,t;return{promise:new Promise(((n,i)=>{e=n,t=i})),resolve:e,reject:t}}var z=class{constructor(){this._lockP=null}async lock(){let e=this._lockP,{promise:t,resolve:n}=K();return this._lockP=t,await e,n}withLock(e){return J(this.lock(),e)}};async function J(e,t){let n=await e;try{return await t()}finally{n()}}function Y(e){let t=new Headers;return t.set("x-reflect-auth-api-key",e),t}var Q="connection/";function Z(e){return`${Q}${encodeURIComponent(e.userID)}/${encodeURIComponent(e.roomID)}/${encodeURIComponent(e.clientID)}/`}function X(e){if(!e.startsWith(Q))return;let t=e.split("/");return 5===t.length&&""===t[4]?{userID:decodeURIComponent(t[1]),roomID:decodeURIComponent(t[2]),clientID:decodeURIComponent(t[3])}:void 0}function ee(e="Unauthorized"){return new Response(e,{status:401})}function te(e,t="Unexpected undefined value"){if(void 0===e)throw new Error(t);return e}function ne(e,t){typeof MINIFLARE<"u"&&_(e,t)}var ie=L([I(),C(),x(),N(null)]),re=function(e){let t;return new D({type:"lazy",schema:null,*entries(n,i){null!=t||(t=e()),yield*t.entries(n,i)},validator:(n,i)=>(null!=t||(t=e()),t.validator(n,i)),coercer:(n,i)=>(null!=t||(t=e()),t.coercer(n,i)),refiner:(n,i)=>(null!=t||(t=e()),t.refiner(n,i))})}((()=>{return L([ie,U(re),(e=I(),t=re,new D({type:"record",schema:null,*entries(n){if(y(n))for(let i in n){let r=n[i];yield[i,i,e],yield[i,r,t]}},validator:e=>y(e)||"Expected an object, but received: "+v(e)}))]);var e,t})),se=C(),ae=L([se,N(null)]),oe="version";async function le(e,t){await t.put(oe,e)}async function ue(e){return await e.get(oe,se)}var ce=S({version:se,deleted:x(),value:re}),he="user/";function de(e){return`user/${e}`}async function fe(e,t){let n=await e.list({prefix:he,allowConcurrency:!0}),i=[];for(let[e,r]of n){ne(r,ce);let n=r;if(n.version<=t)continue;let s=e.substring(he.length),a=n.value;n.deleted?i.push({op:"del",key:s}):i.push({op:"put",key:s,value:a})}return i}var me={allowConcurrency:!0,allowUnconfirmed:!0};var pe=class{constructor(e){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_durable",void 0),this._durable=e}async put(e,t){return async function(e,t,n){await e.put(t,n,me)}(this._durable,e,t)}async del(e){return async function(e,t){await e.delete(t,me)}(this._durable,e)}async get(e,t){return await async function(e,t,n){let i=await e.get(t,me);if(void 0!==i)return ne(i,n),i}(this._durable,e,t)}},we=class{constructor(e){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_storage",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_cache",new Map),this._storage=e}async put(e,t){this._cache.set(e,{value:t,dirty:!0})}async del(e){this._cache.set(e,{value:void 0,dirty:!0})}async get(e,t){let n=this._cache.get(e);if(n)return n.value;let i=await this._storage.get(e,t);return this._cache.set(e,{value:i,dirty:!1}),i}pending(){let e=[];for(let[t,{value:n,dirty:i}]of this._cache.entries())i&&(void 0===n?e.push({op:"del",key:t}):e.push({op:"put",key:t,value:n}));return e}async flush(){await Promise.all([...this._cache.entries()].filter((([,{dirty:e}])=>e)).map((([e,{value:t}])=>void 0===t?this._storage.del(e):this._storage.put(e,t))))}},ye=S({lastMutationID:C(),baseCookie:ae});function ve(e){return`client/${e}`}async function ge(e,t){return await t.get(ve(e),ye)}async function be(e,t,n){return await n.put(ve(e),t)}var Oe=(i=Symbol.iterator,class{constructor(e){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_peeked",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_iter",void 0),this._iter=e}[i](){return this}next(){if(void 0!==this._peeked){let e=this._peeked;return this._peeked=void 0,e}return this._iter.next()}peek(){return void 0!==this._peeked?this._peeked:this._peeked=this._iter.next()}});async function De(e,t,n,i,r){let s=Date.now();try{var a,o;null===(a=e.debug)||void 0===a||a.call(e,"processing mutation",JSON.stringify(t),"version",r);let{clientID:f}=t,m=new we(i),p=await ge(f,m);if(!p)throw null!==(o=e.info)&&void 0!==o&&o.call(e,"client not found"),new Error(`Client ${f} not found`);let w=p.lastMutationID+1;var l,u;if(t.id<w)return void(null===(l=e.debug)||void 0===l||l.call(e,"skipping duplicate mutation",JSON.stringify(t)));if(t.id>w)return void(null===(u=e.info)||void 0===u||u.call(e,"skipping out of order mutation",JSON.stringify(t)));let y=new class{get clientID(){return this._clientID}constructor(e,t,n){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_clientID",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_inner",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_version",void 0),this._inner=e,this._clientID=t,this._version=n}async put(e,t){let n={deleted:!1,version:this._version,value:t};await this._inner.put(de(e),n)}async del(e){let t=await this.get(e);if(void 0===t)return!1;let n={deleted:!0,version:this._version,value:t};return await this._inner.put(de(e),n),void 0!==t}async get(e){let t=await this._inner.get(de(e),ce);if(void 0!==t)return t.deleted?void 0:t.value}async has(e){return void 0!==await this.get(e)}async isEmpty(){throw new Error("not implemented")}scan(e){throw new Error("Method not implemented.")}}(m,f,r);try{var c;let i=n.get(t.name);i?await i(y,t.args):null===(c=e.info)||void 0===c||c.call(e,"skipping unknown mutator",JSON.stringify(t))}catch(n){var h;null===(h=e.info)||void 0===h||h.call(e,"skipping mutation because error",JSON.stringify(t),n)}p.lastMutationID=w,await be(f,p,m),await le(r,m),await m.flush()}finally{var d;null===(d=e.debug)||void 0===d||d.call(e,`processMutation took ${Date.now()-s} ms`)}}async function _e(e,t,n,i,r,s){var a,o,l;null===(a=e.debug)||void 0===a||a.call(e,"processing frame - clients",i);let u=new we(r),c=te(await ue(u)),h=(null!=c?c:0)+1;null===(o=e.debug)||void 0===o||o.call(e,"prevVersion",c,"nextVersion",h);for(let i of t)await De(e,i,n,u,h);if(te(await ue(u))===c)return null!==(l=e.debug)&&void 0!==l&&l.call(e,"no change in frame, skipping poke"),[];let d=function(e){return e.filter((e=>e.key.startsWith(he))).map((e=>{let{key:t,op:n}=e,i=t.substring(he.length);if("put"===n){let t=e.value;return t.deleted?{op:"del",key:i}:{op:"put",key:i,value:t.value}}throw new Error(`unexpected op: ${n}`)}))}(u.pending()),f=[];for(let e of i){let t=await ge(e,u);t.baseCookie=h,await be(e,t,u);let n={clientID:e,poke:{baseCookie:c,cookie:h,lastMutationID:t.lastMutationID,patch:d,timestamp:s}};f.push(n)}return await u.flush(),f}async function ke(e,t,n,i,r){var s,o,l;let u=new pe(i),c=new we(u),h=[...t.keys()];null===(s=e.debug)||void 0===s||s.call(e,"processing room","clientIDs",h);let d=await ue(c);void 0===d&&(d=0,await le(d,c)),null===(o=e.debug)||void 0===o||o.call(e,"currentVersion",d);let f=await async function(e,t,n,i,r){let s=new Map(await Promise.all(e.map((async e=>[e,await t(e)])))),a=new Set([...s.values()].map((e=>e.baseCookie)));a.delete(n);let o=new Map(await Promise.all([...a].map((async e=>[e,await fe(i,null!=e?e:0)])))),l=[];for(let t of e){let e=te(s.get(t));if(e.baseCookie===n)continue;let i=te(o.get(e.baseCookie)),a={clientID:t,poke:{baseCookie:e.baseCookie,cookie:n,lastMutationID:e.lastMutationID,timestamp:r,patch:i}};l.push(a)}return l}(h,(async e=>te(await ge(e,c),`Client record not found: ${e}`)),d,i,r);null===(l=e.debug)||void 0===l||l.call(e,"pokes from fastforward",JSON.stringify(f));for(let e of f){let t=te(await ge(e.clientID,c));t.baseCookie=e.poke.cookie,await be(e.clientID,t,c)}let m=function*(e){let t=[],n=e=>{let{value:n,done:i}=e.peek();if(i)return;let r=t.findIndex((e=>e.peek().value.timestamp>n.timestamp));t.splice(-1===r?t.length:r,0,e)};for(let[t,i]of e){let e=i.pending.map((e=>a({clientID:t},e)));n(new Oe(e.values()))}for(;;){let e=t.shift();if(!e)break;let{value:i,done:r}=e.peek();if(r)throw new Error("unexpected state");yield i,e.next(),n(e)}}(t);return f.push(...await _e(e,m,n,h,c,r)),await c.flush(),f}async function Ee(e,t,n,i,r){var s;null===(s=e.debug)||void 0===s||s.call(e,"process pending");let a=Date.now();try{let s=await ke(e,n,i,t,r);(function(e,t,n){for(let r of t){var i;let t=te(n.get(r.clientID)),s=["poke",r.poke];null!==(i=e.debug)&&void 0!==i&&i.call(e,"sending client",r.clientID,"poke",r.poke),t.socket.send(JSON.stringify(s))}})(e,s,n),function(e,t,n){var i;null===(i=e.debug)||void 0===i||i.call(e,"clearing pending mutations");for(let e of t){let t=te(n.get(e.clientID)),i=t.pending.findIndex((t=>t.id>e.poke.lastMutationID));t.pending.splice(0,i>-1?i:t.pending.length)}}(e,s,n)}finally{var o;null===(o=e.debug)||void 0===o||o.call(e,`processPending took ${Date.now()-a} ms`)}}async function Ue(e,t,n,i,r,s,o,l){var u,c,h,d,f,m,w,y,v,g,b;let O=n=>{var i,r;null!==(i=(r=e).info)&&void 0!==i&&i.call(r,"invalid connection request",n),t.send(JSON.stringify(["error",n])),t.close()},D=function(e,t){let n=(t,n)=>{let i=e.searchParams.get(t);if(""===i||null===i){if(n)throw new Error(`invalid querystring - missing ${t}`);return null}return i},i=(t,i)=>{let r=n(t,i);if(null===r)return null;let s=parseInt(r);if(isNaN(s))throw new Error(`invalid querystring parameter ${t}, url: ${e}, got: ${r}`);return s},r=e=>{let t,n=e.get(p);if(!n)throw new Error("missing user-data");try{t=JSON.parse(function(e){return decodeURIComponent(e)}(n))}catch(e){throw new Error("invalid user-data - failed to decode/parse")}if(!t.userID)throw new Error("invalid user-data - missing userID");return t};try{let e=n("clientID",!0),s=i("baseCookie",!1),a=i("ts",!0),o=i("lmid",!0);return{result:{clientID:e,userData:r(t),baseCookie:s,timestamp:a,lmid:o},error:null}}catch(e){return{result:null,error:String(e)}}}(i,r),{result:_}=D;if(null===_){let{error:e}=D;return void O(e)}null===(u=(c=e=e.addContext("client",_.clientID)).info)||void 0===u||u.call(c,"parsed request",a(a({},_),{},{userData:"redacted"}));let{clientID:k,baseCookie:E}=_,U=new pe(n),x=await ge(k,U);null===(h=(d=e).debug)||void 0===h||h.call(d,"Existing client record",x);let N=null!==(f=null==x?void 0:x.lastMutationID)&&void 0!==f?f:0;var C,I;if(_.lmid>N)return null!==(C=(I=e).info)&&void 0!==C&&C.call(I,"Unexepted lmid when connecting. Got",_.lmid,"old lastMutationID",N),void O("Unexpected lmid");let M={baseCookie:E,lastMutationID:N};await U.put(ve(k),M),null===(m=(w=e).debug)||void 0===m||m.call(w,"Put client record",M);let S=s.get(k);S&&(null!==(y=(v=e).debug)&&void 0!==y&&y.call(v,"Closing old socket"),S.socket.close()),t.addEventListener("message",(e=>o(k,e.data.toString(),t))),t.addEventListener("close",(()=>l(k,t)));let L={socket:t,userData:_.userData,clockBehindByMs:void 0,pending:[]};null!==(g=(b=e).debug)&&void 0!==g&&g.call(b,"Setting client map entry",k,L),s.set(k,L);t.send(JSON.stringify(["connected",{}]))}var xe=S({}),Ne=M([N("ping"),xe]),Ce=S({id:C(),name:I(),args:re,timestamp:C()}),Ie=S({clientID:I(),mutations:U(Ce),pushVersion:C(),schemaVersion:I(),timestamp:C()}),Me=L([M([N("push"),Ie]),Ne]);function Se(e,t){let n=["error",t];e.send(JSON.stringify(n))}function Le(e,t,n,i,r,s){let a;try{a=function(e){let t=JSON.parse(e);return ne(t,Me),t}(i)}catch(t){var o;return null!==(o=e.info)&&void 0!==o&&o.call(e,"invalid message",t),void Se(r,String(t))}let l=t.get(n);var u;if(!l)return null!==(u=e.error)&&void 0!==u&&u.call(e,"client not found, closing socket"),Se(r,`no such client: ${n}`),void r.close();switch(a[0]){case"ping":!function(e,t){var n;null===(n=e.debug)||void 0===n||n.call(e,"handling ping"),t.send(JSON.stringify(["pong",{}]))}(e,r);break;case"push":!function(e,t,n,i,r){var s,a;null!==(s=e.debug)&&void 0!==s&&s.call(e,"handling push",JSON.stringify(n)),void 0===t.clockBehindByMs&&(t.clockBehindByMs=i()-n.timestamp,null===(a=e.debug)||void 0===a||a.call(e,"initializing clock offset: clock behind by",t.clockBehindByMs));for(let i of n.mutations){var o;let n=t.pending.findIndex((e=>e.id>=i.id));if(-1===n)n=t.pending.length;else if(t.pending[n].id===i.id){var l;null===(l=e.debug)||void 0===l||l.call(e,"mutation already been queued",i.id);continue}i.timestamp+=t.clockBehindByMs,t.pending.splice(n,0,i),null===(o=e.debug)||void 0===o||o.call(e,"inserted mutation, pending is now",JSON.stringify(t.pending))}r()}(e,l,a[1],(()=>Date.now()),s);break;default:throw new Error(`Unknown message type: ${a[0]}`)}}function Te(e){let{getLogSink:t,getLogLevel:n}=e;return{fetch:async(e,i,r)=>je(i,r,t,n,(t=>async function(e,t,n){var i,r;n=n.addContext("req",d()),null===(i=(r=n).debug)||void 0===i||i.call(r,"Handling request:",e.url);try{var s,a;let i=await async function(e,t,n){let i=(e,t)=>Ae(n,t);return q(e,t,n.REFLECT_AUTH_API_KEY,{connect:i,authInvalidateForUser:i,authInvalidateForRoom:i,authInvalidateAll:i})}(e,n,t);return null!==(s=(a=n).debug)&&void 0!==s&&s.call(a,`Returning response: ${i.status} ${i.statusText}`),i}catch(e){var o,l;throw null!==(o=(l=n).info)&&void 0!==o&&o.call(l,"Unhandled exception",e),e}}(e,i,t))),scheduled:async(e,i,r)=>je(i,r,t,n,(e=>async function(e,t){var n,i,r,s,a,o;if(t=t.addContext("scheduled",d()),null!==(n=(i=t).info)&&void 0!==n&&n.call(i,"Handling scheduled event"),!e.REFLECT_AUTH_API_KEY){var l,u;return void(null===(l=(u=t).debug)||void 0===l||l.call(u,"Returning early because REFLECT_AUTH_API_KEY is not defined in env."))}null===(r=(s=t).info)||void 0===r||r.call(s,`Sending ${$} request to AuthDO`);let c=await Ae(e,new Request(`https://unused-reflect-auth-do.dev${$}`,{headers:Y(e.REFLECT_AUTH_API_KEY),method:"POST"}));null===(a=(o=t).info)||void 0===a||a.call(o,`Response: ${c.status} ${c.statusText}`)}(i,e)))}}async function je(e,t,n,i,r){let s=n(e),a=new h(i(e),s).addContext("Worker");try{return await r(a)}finally{s.flush&&t.waitUntil(s.flush())}}function Ae(e,t){let{authDO:n}=e,i=n.idFromName("auth");return n.get(i).fetch(t)}function Re(e){return 1===e.length?e[0]:new u(e)}function Fe(e){let{authHandler:t,getLogSinks:n=(e=>[c]),getLogLevel:i=(e=>"debug")}=e;return{worker:Te({getLogSink:e=>Re(n(e)),getLogLevel:i}),RoomDO:class extends class{constructor(e){var t,n,i,r;Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_clients",new Map),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_lock",new z),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_mutators",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_lc",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_state",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_authApiKey",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_turnTimerID",0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_handleMessage",(async(e,t,n)=>{var i;let r=this._lc.addContext("req",d()).addContext("client",e);null!==(i=r.debug)&&void 0!==i&&i.call(r,"handling message",t,"waiting for lock"),await this._lock.withLock((async()=>{var i;null!==(i=r.debug)&&void 0!==i&&i.call(r,"received lock"),Le(r,this._clients,e,t,n,(()=>this._processUntilDone()))}))})),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_handleClose",(async(e,t)=>{var n;let i=this._lc.addContext("req",d()).addContext("client",e);null!==(n=i.debug)&&void 0!==n&&n.call(i,"handling close - waiting for lock"),await this._lock.withLock((async()=>{var n;null!==(n=i.debug)&&void 0!==n&&n.call(i,"received lock"),function(e,t,n,i){var r,s;(null===(r=t.get(n))||void 0===r?void 0:r.socket)===i&&(null!==(s=e.debug)&&void 0!==s&&s.call(e,"on socket close deleting client map entry for",n),t.delete(n))}(i,this._clients,e,t)}))}));let{mutators:s,state:a,authApiKey:o,logSink:l,logLevel:u}=e;this._mutators=new Map([...Object.entries(s)]),this._state=a,this._authApiKey=o,this._lc=new h(u,l).addContext("RoomDO"),null!==(t=(n=this._lc).info)&&void 0!==t&&t.call(n,"Starting server"),null===(i=(r=this._lc).info)||void 0===i||i.call(r,"Version:",m)}async fetch(e){return q(e,this._lc.addContext("req",d()),this._authApiKey,this)}async connect(e,t){var n;if("websocket"!==t.headers.get("Upgrade"))return new Response("expected websocket",{status:400});let i=new WebSocketPair,r=i[1],s=new URL(t.url);return null!==(n=e.debug)&&void 0!==n&&n.call(e,"connection request",s.toString(),"waiting for lock"),r.accept(),this._lock.withLock((async()=>{var n;null!==(n=e.debug)&&void 0!==n&&n.call(e,"received lock"),await Ue(e,r,this._state.storage,s,t.headers,this._clients,this._handleMessage,this._handleClose)})),new Response(null,{status:101,webSocket:i[0]})}async authInvalidateForUser(e,t,{userID:n}){var i;return null!==(i=e.debug)&&void 0!==i&&i.call(e,`Closing user ${n}'s connections fulfilling auth api invalidateForUser request.`),await this._closeConnections((e=>e.userData.userID===n)),new Response("Success",{status:200})}async authInvalidateForRoom(e){var t;return null!==(t=e.info)&&void 0!==t&&t.call(e,"Closing all connections fulfilling auth api invalidateForRoom request."),await this._closeConnections((e=>!0)),new Response("Success",{status:200})}async authInvalidateAll(e){var t;return null!==(t=e.info)&&void 0!==t&&t.call(e,"Closing all connections fulfilling auth api invalidateAll request."),await this._closeConnections((e=>!0)),new Response("Success",{status:200})}async authConnections(){return new Response(JSON.stringify(function(e){let t=[];for(let[n,i]of e)t.push({userID:i.userData.userID,clientID:n});return t}(this._clients)))}_closeConnections(e){return this._lock.withLock((()=>function(e,t){for(let n of e.values())t(n)&&n.socket.close()}(this._clients,e)))}async _processUntilDone(){var e;let t=this._lc.addContext("req",d());var n;null!==(e=t.debug)&&void 0!==e&&e.call(t,"handling processUntilDone"),this._turnTimerID?null===(n=t.debug)||void 0===n||n.call(t,"already processing, nothing to do"):this._turnTimerID=setInterval((()=>{this._processNext(t)}),1e3/60)}async _processNext(e){var t;null!==(t=e.debug)&&void 0!==t&&t.call(e,`processNext - starting turn at ${Date.now()} - waiting for lock`),await this._lock.withLock((async()=>{var t,n;if(null!==(t=e.debug)&&void 0!==t&&t.call(e,`received lock at ${Date.now()}`),!function(e){for(let t of e.values())if(t.pending.length>0)return!0;return!1}(this._clients))return null!==(n=e.debug)&&void 0!==n&&n.call(e,"No pending mutations to process, exiting"),void(this._turnTimerID&&(clearInterval(this._turnTimerID),this._turnTimerID=0));await Ee(e,this._state.storage,this._clients,this._mutators,Date.now())}))}}{constructor(t,r){super({mutators:e.mutators,state:t,authApiKey:r.REFLECT_AUTH_API_KEY,logSink:Re(n(r)),logLevel:i(r)})}},AuthDO:class extends class{constructor(e,t=typeof MINIFLARE<"u"){var n,i,r,s;Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_roomDO",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_state",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_authHandler",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_authApiKey",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_lc",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_isMiniflare",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_lock",void 0);let{roomDO:a,state:o,authHandler:l,authApiKey:u,logSink:c,logLevel:d}=e;this._roomDO=a,this._state=o,this._authHandler=l,this._authApiKey=u,this._lc=new h(d,c).addContext("AuthDO"),this._isMiniflare=t,this._lock=new class{constructor(){this._lock=new z,this._writeP=null,this._readP=[]}read(){return this._lock.withLock((async()=>{await this._writeP;let{promise:e,resolve:t}=K();return this._readP.push(e),t}))}withRead(e){return J(this.read(),e)}async write(){return await this._lock.withLock((async()=>{await this._writeP,await Promise.all(this._readP);let{promise:e,resolve:t}=K();return this._writeP=e,this._readP=[],t}))}withWrite(e){return J(this.write(),e)}},null!==(n=(i=this._lc).info)&&void 0!==n&&n.call(i,"Starting server"),null===(r=(s=this._lc).info)||void 0===r||r.call(s,"Version:",m)}async fetch(e){var t;let n=this._lc.addContext("req",d());null===(t=n.debug)||void 0===t||t.call(n,"Handling request:",e.url);try{var i;let t=await q(e,n,this._authApiKey,this);return null!==(i=n.debug)&&void 0!==i&&i.call(n,`Returning response: ${t.status} ${t.statusText}`),t}catch(e){var r;throw null!==(r=n.info)&&void 0!==r&&r.call(n,"Unhandled exception",e),e}}async connect(e,t){var n,i;let r=new URL(t.url);if("/connect"!==r.pathname)return new Response("unknown route",{status:400});let s=r.searchParams.get("roomID");if(null===s||""===s)return new Response("roomID parameter required",{status:400});let a=r.searchParams.get("clientID");if(!a)return new Response("clientID parameter required",{status:400});e=e.addContext("client",a).addContext("room",s);let o,l=t.headers.get("Sec-WebSocket-Protocol");if(!l)return null!==(n=(i=e).info)&&void 0!==n&&n.call(i,"auth not found in Sec-WebSocket-Protocol header."),ee("auth required");try{o=decodeURIComponent(l)}catch(t){var u,c;return null!==(u=(c=e).info)&&void 0!==u&&u.call(c,"error decoding auth found in Sec-WebSocket-Protocol header."),ee("invalid auth")}let h=o;return this._lock.withRead((async()=>{var n,i,r,o;let u;try{u=await this._authHandler(h,s)}catch(e){return ee()}if(!u||!u.userID)return u?u.userID||null===(n=(i=e).info)||void 0===n||n.call(i,"userData returned by authHandler has no userID."):null===(r=(o=e).info)||void 0===r||r.call(o,"userData returned by authHandler is falsey."),ee();let c=Z({userID:u.userID,roomID:s,clientID:a}),d={connectTimestamp:Date.now()};await this._state.storage.put(c,d);let f=this._roomDO.idFromName(s),m=this._roomDO.get(f),w=new Request(t);var y;w.headers.set(p,(y=JSON.stringify(u),encodeURIComponent(y).replace(/%(3A|3B|2C|2F|22|3F|7B|7D|5B|5D|40|3C|3E|3D|2B|23|24|26|60|7C|5E|20)/g,((e,t)=>String.fromCharCode(parseInt(t,16))))));let v=await m.fetch(w),g=new Headers(v.headers);return this._isMiniflare||g.set("Sec-WebSocket-Protocol",l),new Response(v.body,{status:v.status,statusText:v.statusText,webSocket:v.webSocket,headers:g})}))}async authInvalidateForUser(e,t,{userID:n}){var i;return null!==(i=e.debug)&&void 0!==i&&i.call(e,`authInvalidateForUser ${n} waiting for lock.`),this._lock.withWrite((async()=>{var i;null===(i=e.debug)||void 0===i||i.call(e,"got lock.");let r=(await this._state.storage.list({prefix:(s=n,`${Q}${encodeURIComponent(s)}/`)})).keys();var s;return this._forwardInvalidateRequest(e,"authInvalidateForUser",t,[...r])}))}async authInvalidateForRoom(e,t,{roomID:n}){var i;return null!==(i=e.debug)&&void 0!==i&&i.call(e,`authInvalidateForRoom ${n} waiting for lock.`),this._lock.withWrite((async()=>{var i,r,s;null!==(i=e.debug)&&void 0!==i&&i.call(e,"got lock."),null===(r=e.debug)||void 0===r||r.call(e,`Sending authInvalidateForRoom request to ${n}`);let a=this._roomDO.idFromName(n),o=await this._roomDO.get(a).fetch(t);return o.ok||null!==(s=e.debug)&&void 0!==s&&s.call(e,`Received error response from ${n}. ${o.status} ${await o.text}`),o}))}async authInvalidateAll(e,t){var n;return null!==(n=e.debug)&&void 0!==n&&n.call(e,"authInvalidateAll waiting for lock."),this._lock.withWrite((async()=>{var n;null===(n=e.debug)||void 0===n||n.call(e,"got lock.");let i=(await this._state.storage.list({prefix:Q})).keys();return this._forwardInvalidateRequest(e,"authInvalidateAll",t,[...i])}))}async authRevalidateConnections(e){var t,n,i,r;null===(t=e.info)||void 0===t||t.call(e,"Starting auth revalidation.");let s=this._authApiKey;if(void 0===s)return null!==(n=e.info)&&void 0!==n&&n.call(e,"Returning Unauthorized because REFLECT_AUTH_API_KEY is not defined in env."),new Response("Unauthorized",{status:401});let a=await this._state.storage.list({prefix:Q}),o=new Map;for(let t of a.keys()){let n=X(t);if(!n){var l;null===(l=e.error)||void 0===l||l.call(e,"Failed to parse connection key",t);continue}let{roomID:i}=n,r=o.get(i);r||(r=new Set,o.set(i,r)),r.add(t)}null===(i=e.info)||void 0===i||i.call(e,`Revalidating ${a.size} ConnectionRecords across ${o.size} rooms.`);let u=0;for(let[t,n]of o){var c;null!==(c=e.debug)&&void 0!==c&&c.call(e,`revalidating connections for ${t} waiting for lock.`),await this._lock.withWrite((async()=>{var i;null===(i=e.debug)||void 0===i||i.call(e,"got lock.");let r,a=this._roomDO.idFromName(t),o=await this._roomDO.get(a).fetch(new Request(`https://unused-reflect-room-do.dev${G}`,{headers:Y(s)}));try{let e=await o.json();_(e,A),r=e}catch(t){var l;null===(l=e.error)||void 0===l||l.call(e,`Bad ${G} response from roomDO`,t)}if(r){let i=new Set(r.map((({userID:e,clientID:n})=>Z({roomID:t,userID:e,clientID:n})))),s=[...n].filter((e=>!i.has(e)));try{u+=await this._state.storage.delete(s)}catch(n){var c;null===(c=e.info)||void 0===c||c.call(e,"Failed to delete connections for roomID",t)}}}))}return null!==(r=e.info)&&void 0!==r&&r.call(e,`Revalidated ${a.size} ConnectionRecords, deleted ${u} ConnectionRecords.`),new Response("Complete",{status:200})}async _forwardInvalidateRequest(e,t,n,i){var r;let s=i.map((t=>{var n;let i=X(t);return i||null!==(n=e.error)&&void 0!==n&&n.call(e,"Failed to parse connection key",t),i})),a=new Set;for(let e of s)e&&a.add(e.roomID);let o=[...a],l=[];null===(r=e.debug)||void 0===r||r.call(e,`Sending ${t} requests to ${o.length} rooms`);for(let e of o){let t=this._roomDO.idFromName(e),i=this._roomDO.get(t);l.push(i.fetch(n))}let u=[];for(let t=0;t<l.length;t++){var c;let n=await l[t];n.ok||(u.push(n),null===(c=e.debug)||void 0===c||c.call(e,`Received error response from ${o[t]}. ${n.status} ${await n.text}`))}return 0===u.length?new Response("Success",{status:200}):u[0]}}{constructor(e,r){super({roomDO:r.roomDO,state:e,authHandler:t,authApiKey:r.REFLECT_AUTH_API_KEY,logSink:Re(n(r)),logLevel:i(r)})}}}}var Pe=class{constructor(e){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_messages",[]),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_apiKey",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_service",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_host",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_interval",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_timerID",0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_flushLock",new z),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_signal",void 0);let{apiKey:t,service:n,host:i,interval:r=1e4,signal:s}=e;this._apiKey=t,this._service=n,this._host=i,this._interval=r,this._signal=s,s&&s.addEventListener("abort",(()=>{this._timerID&&clearTimeout(this._timerID)}))}log(e,...t){var n;(null===(n=this._signal)||void 0===n?void 0:n.aborted)||(this._messages.push(function(e,t){let n={date:Date.now(),message:He(e),status:t};return"error"===t&&(n.error={origin:"logger"}),n}(t,e)),"error"===e?this.flush():this._startTimer())}_startTimer(){var e;(null===(e=this._signal)||void 0===e?void 0:e.aborted)||this._timerID||(this._timerID=setTimeout((()=>{this._timerID=0,this.flush()}),this._interval))}flush(){return this._flushLock.withLock((async()=>{var e;if(null!==(e=this._signal)&&void 0!==e&&e.aborted)return;let{length:t}=this._messages;if(0===t)return;let n=this._messages;this._messages=[];let i=n.map((e=>JSON.stringify(e))).join("\n"),r=new URL("https://http-intake.logs.datadoghq.com/api/v2/logs");r.searchParams.set("ddsource","worker"),this._service&&r.searchParams.set("service",this._service),this._host&&r.searchParams.set("host",this._host);let s=!1;try{s=(await fetch(r.toString(),{headers:{"DD-API-KEY":this._apiKey},method:"POST",body:i,signal:this._signal})).ok}catch(e){}s||this._messages.splice(0,0,...n),this._messages.length&&this._startTimer()}))}};function He(e){return Array.isArray(e)&&1===e.length?He(e[0]):e}var $e={log(e,...t){console[e](...t)}},Ge=class extends class{constructor(e,t="info"){this.debug=void 0,this.info=void 0,this.error=void 0;let n=t=>(...n)=>e.log(t,...n);switch(t){case"debug":this.debug=n("debug");case"info":this.info=n("info");case"error":this.error=n("error")}}}{constructor(e="info",t=$e){super(t,e),this.xt=e,this.bt=t}addContext(e,t){let n=void 0===t?e:`${e}=${t}`,i={log:(e,...t)=>{this.bt.log(e,n,...t)}};return new Ge(this.xt,i)}};function We(){let e,t;return{promise:new Promise(((n,i)=>{e=n,t=i})),resolve:e,reject:t}}var qe=class{constructor(){this.He=null}async lock(){let e=this.He,{promise:t,resolve:n}=We();return this.He=t,await e,n}withLock(e){return Be(this.lock(),e)}},Ve=class{constructor(){this.Ne=new qe,this.te=null,this.ne=[]}read(){return this.Ne.withLock((async()=>{await this.te;let{promise:e,resolve:t}=We();return this.ne.push(e),t}))}withRead(e){return Be(this.read(),e)}async write(){return await this.Ne.withLock((async()=>{await this.te,await Promise.all(this.ne);let{promise:e,resolve:t}=We();return this.te=e,this.ne=[],t}))}withWrite(e){return Be(this.write(),e)}};async function Be(e,t){let n=await e;try{return await t()}finally{n()}}function Ke(e,t="Assertion failed"){if(!e)throw new Error(t)}function ze(e){Ye(e,"string")}function Je(e){Ye(e,"number")}function Ye(e,t){typeof e!==t&&Xe(e,t)}function Qe(e){null===e&&Xe(e,"object"),Ye(e,"object")}function Ze(e){Array.isArray(e)||Xe(e,"array")}function Xe(e,t){throw new Error(function(e,t){let n="Invalid type: ";return n+=null==e?e:`${typeof e} \`${e}\``,n+`, expected ${t}`}(e,t))}function et(e){if(void 0===e)throw new Error("Expected non undefined value")}var tt=Object.prototype.hasOwnProperty,nt=Object.hasOwn||((e,t)=>tt.call(e,t));function it(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;switch(typeof e){case"boolean":case"number":case"string":return!1}if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!it(e[n],t[n]))return!1;return!0}if(null===e||null===t||Array.isArray(t))return!1;let n=0;for(let i in e)if(nt(e,i)){if(!it(e[i],t[i]))return!1;n++}let i=0;for(let e in t)nt(t,e)&&i++;return n===i}function rt(e){return st(e,[])}function st(e,t){switch(typeof e){case"boolean":case"number":case"string":case"undefined":return e;case"object":{if(null===e)return null;if(t.includes(e))throw new Error("Cyclic object");if(t.push(e),Array.isArray(e)){let n=e.map((e=>st(e,t)));return t.pop(),n}let n={};for(let i in e)if(nt(e,i)){let r=e[i];void 0!==r&&(n[i]=st(r,t))}return t.pop(),n}default:throw new Error("Invalid type: "+typeof e)}}function at(e){switch(typeof e){case"string":return 5+e.length;case"number":return function(e){return e===(0|e)}(e)?e<=-(2**30)||e>=2**30-1?6:5:9;case"boolean":return 1;case"object":if(null===e)return 1;if(Array.isArray(e)){let t=6;for(let n of e)t+=at(n);return t}{let t=e,n=1;for(let e in t)if(nt(t,e)){let i=t[e];void 0!==i&&(n+=at(e)+at(i))}return n+4+1}}throw new Error("invalid value")}function ot(e){0}async function lt(e){let t=await fetch(e),n=t.status,i=200===n?"":await t.text();return{response:t,httpRequestInfo:{httpStatusCode:n,errorMessage:i}}}var ut=async e=>(await lt(e)).httpRequestInfo,ct=class extends Error{constructor(e){super("Failed to push"),this.name="PushError",this.causedBy=e}};function ht(e){return"object"==typeof e&&null!==e&&"ClientStateNotFound"===e.error}function dt(e){if("object"!=typeof e||null===e)throw new Error("PullResponse must be an object");if(ht(e))return;let t=e;void 0!==t.cookie&&ot(t.cookie),Je(t.lastMutationID),function(e){Ze(e);for(let t of e)mt(t)}(t.patch)}var ft=async e=>{let{httpRequestInfo:t,response:n}=await lt(e);return 200!==t.httpStatusCode?{httpRequestInfo:t}:{response:await n.json(),httpRequestInfo:t}};function mt(e){switch(Qe(e),e.op){case"put":ze(e.key),ot(e.value);break;case"del":ze(e.key);break;case"clear":break;default:throw new Error(`unknown patch op \`${e.op}\`, expected one of \`put\`, \`del\`, \`clear\``)}}var pt=class extends Error{constructor(e){super("Failed to pull"),this.name="PullError",this.causedBy=e}};function wt(e){return void 0!==e.indexName}function yt(e){return"string"==typeof e?[e]:e}function vt(e){if(!e)return{};let t,n,i,r;return e.start&&(({key:t,exclusive:n}=e.start),e.indexName?"string"==typeof t?r=t:(r=t[0],i=t[1]):i=t),{prefix:e.prefix,startSecondaryKey:r,startKey:i,startExclusive:n,limit:e.limit,indexName:e.indexName}}var gt=class extends Error{constructor(){super("Transaction is closed")}};function bt(e){if(e.closed)throw new gt}async function Ot(e){let t=[];var n,i=!1,r=!1;try{for(var s,a=o(e);i=!(s=await a.next()).done;i=!1){let e=s.value;t.push(e)}}catch(e){r=!0,n=e}finally{try{i&&null!=a.return&&await a.return()}finally{if(r)throw n}}return t}var Dt=new TextEncoder;new TextDecoder;var _t=/^[0-9a-v]{32}$/,kt=/^t\/[0-9a-v]{30}$/;async function Et(e){let t=function(e){return Dt.encode(e)}(JSON.stringify(e)),n=await crypto.subtle.digest("SHA-512",t);return function(e){let t=0,n=0,i=0,r="",{length:s}=e;for(;t<s;){let a=e[t];n>3?(i=a&255>>n,n=(n+5)%8,i=i<<n|(t+1<s?e[t+1]:0)>>8-n,t++):(i=a>>8-(n+5)&31,n=(n+5)%8,0===n&&t++),r+="0123456789abcdefghijklmnopqrstuv"[i]}return r}(new Uint8Array(n,0,20))}var Ut="00000000000000000000000000000000",xt=function(e){let t=0;return()=>e+(t++).toString().padStart(32-e.length,"0")}("t/");function Nt(e){return"string"==typeof e&&kt.test(e)}function Ct(e){if(kt.test(e))throw new Error("Unexpected temp hash")}function It(e){if(!function(e){return"string"==typeof e&&(_t.test(e)||kt.test(e))}(e))throw new Error(`Invalid hash: '${e}'`)}function Mt(e,t){let n=0;for(;n<e;){let i=n+(e-n>>1);t(i)?e=i:n=i+1}return n}function St(e){return At(e)?e[1].map((e=>e[1])):[]}async function Lt(e,t,n){let i=await n.getNode(t);if(Wt(i))return i;let{entries:r}=i,s=Tt(e,r);return s===r.length&&s--,Lt(e,r[s][1],n)}function Tt(e,t){return Mt(t.length,(n=>e<=t[n][0]))}function jt(e,t,n){return e!==t.length&&t[e][0]===n}function At(e){return e[0]>0}var Rt=class{constructor(e,t,n){this.entries=e,this.hash=t,this.isMutable=n}maxKey(){return this.entries[this.entries.length-1][0]}toChunkData(){return[this.level,this.entries]}},Ft=class extends Rt{constructor(){super(...arguments),this.level=0}async set(e,t,n){let i,r=Tt(e,this.entries);return i=jt(r,this.entries,e)?1:0,this.De(n,r,i,[e,t])}De(e,t,n,...i){if(this.isMutable)return this.entries.splice(t,n,...i),e.updateNode(this),this;let r=Pt(this.entries,t,n,...i);return e.newDataNodeImpl(r)}async del(e,t){let n=Tt(e,this.entries);return jt(n,this.entries,e)?this.De(t,n,1):this}keys(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){for(let e of t.entries)yield e[0]}))()}entriesIter(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){for(let e of t.entries)yield e}))()}};function Pt(e,t,n,...i){let r=e.slice(0,t);for(let e=0;e<i.length;e++)r.push(i[e]);for(let i=t+n;i<e.length;i++)r.push(e[i]);return r}function*Ht(...e){for(let t of e)yield*t}var $t=class extends Rt{constructor(e,t,n,i){super(e,t,i),this.level=n}async set(e,t,n){let i=Tt(e,this.entries);i===this.entries.length&&i--;let r=this.entries[i][1],s=await(await n.getNode(r)).set(e,t,n),a=n.childNodeSize(s);return a>n.maxSize||a<n.minSize?this.ke(n,i,s):this.Pe(n,i,[s.maxKey(),s.hash])}async ke(e,t,n){let i,r,s,a=this.level-1,o=this.entries;if(t>0){let a=o[t-1][1];i=Ht((await e.getNode(a)).entries,n.entries),r=t-1,s=2}else if(t<o.length-1){let a=o[t+1][1],l=await e.getNode(a);i=Ht(n.entries,l.entries),r=t,s=2}else i=n.entries,r=t,s=1;let l=qt(i,e.getEntrySize,e.minSize-e.chunkHeaderSize,e.maxSize-e.chunkHeaderSize),u=[];for(let t of l){let n=e.newNodeImpl(t,a);u.push([n.maxKey(),n.hash])}if(this.isMutable)return this.entries.splice(r,s,...u),e.updateNode(this),this;let c=Pt(o,r,s,...u);return e.newInternalNodeImpl(c,this.level)}Pe(e,t,n){if(this.isMutable)return this.entries.splice(t,1,n),e.updateNode(this),this;let i=Pt(this.entries,t,1,n);return e.newInternalNodeImpl(i,this.level)}async del(e,t){let n=Tt(e,this.entries);if(n===this.entries.length)return this;let i=this.entries[n][1],r=await t.getNode(i),s=r.hash,a=await r.del(e,t);if(a.hash===s)return this;if(0===a.entries.length){let e=Pt(this.entries,n,1);return t.newInternalNodeImpl(e,this.level)}return 0===n&&1===this.entries.length?a:t.childNodeSize(a)>t.minSize?this.Pe(t,n,[a.maxKey(),a.hash]):this.ke(t,n,a)}keys(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){for(let n of t.entries)yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o((yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getNode(n[1]))).keys(e)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}entriesIter(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){for(let n of t.entries)yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o((yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getNode(n[1]))).entriesIter(e)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}async getChildren(e,t,n){let i=[];for(let r=e;r<t&&r<this.entries.length;r++)i.push(n.getNode(this.entries[r][1]));return Promise.all(i)}async getCompositeChildren(e,t,n){let{level:i}=this;if(0===t)return new $t([],xt(),i-1,!0);let r=await this.getChildren(e,e+t,n);if(i>1){let e=[];for(let t of r)e.push(...t.entries);return new $t(e,xt(),i-1,!0)}Ke(1===i);let s=[];for(let e of r)s.push(...e.entries);return new Ft(s,xt(),!0)}};function Gt(e,t,n,i){return 0===n?new Ft(e,t,i):new $t(e,t,n,i)}function Wt(e){return 0===e.level}function qt(e,t,n,i){let r=[],s=[],a=0,o=[];for(let l of e){let e=t(l);e>=i?(o.length>0&&(r.push(o),s.push(a)),r.push([l]),s.push(e),a=0,o=[]):a+e>=n?(o.push(l),r.push(o),s.push(a+e),a=0,o=[]):(a+=e,o.push(l))}return a>0&&(s.length>0&&a+s[s.length-1]<=i?r[r.length-1].push(...o):r.push(o)),r}var Vt=[0,[]],Bt=new Ft([],Ut,!1);function*Kt(e,t){let n,i=0,r=0;function s(e,t){-1===e[3]&&(e[3]=t)}function a(){return[i,0,0,-1]}for(;i<e.length&&r<t.length;)e[i][0]===t[r][0]?(it(e[i][1],t[r][1])?n&&(s(n,0),yield n,n=void 0):(n||(n=a()),n[2]++,n[1]++,s(n,r)),i++,r++):e[i][0]<t[r][0]?(n||(n=a()),n[1]++,i++):(n||(n=a()),n[2]++,s(n,r),r++);r<t.length&&(n||(n=a()),n[2]+=t.length-r,s(n,r)),i<e.length&&(n||(n=a()),n[1]+=e.length-i),n&&(s(n,0),yield n)}var zt=class{constructor(e,t=Ut,n=at,i=11){this.Ee=new Map,this.rootHash=t,this.p=e,this.getEntrySize=n,this.chunkHeaderSize=i}async getNode(e){if(e===Ut)return Bt;let t=this.Ee.get(e);if(t)return t;let{data:n}=await this.p.mustGetChunk(e),i=Gt(n[1],e,n[0],!1);return this.Ee.set(e,i),i}async get(e){let t=await Lt(e,this.rootHash,this),n=Tt(e,t.entries);if(jt(n,t.entries,e))return t.entries[n][1]}async has(e){let t=await Lt(e,this.rootHash,this);return jt(Tt(e,t.entries),t.entries,e)}async isEmpty(){return 0===(await this.getNode(this.rootHash)).entries.length}scan(e){return Zt(this.rootHash,e,(async e=>{let t=await this.getNode(e);if(t)return t.toChunkData();let{data:n}=await this.p.mustGetChunk(e);return n}))}keys(){var e=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o((yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getNode(e.rootHash))).keys(e)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}entries(){var e=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o((yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getNode(e.rootHash))).entriesIter(e)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}[Symbol.asyncIterator](){return this.entries()}diff(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){let[n,i]=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(Promise.all([t.getNode(t.rootHash),e.getNode(e.rootHash)]));yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Jt(i,n,e,t)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}};function Jt(e,t,n,i){return Yt.apply(this,arguments)}function Yt(){return(Yt=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t,n,i){if(e.level>t.level){let r=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getCompositeChildren(0,e.entries.length,n));return void(yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Jt(r,t,n,i)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())))}if(t.level>e.level){let r=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(t.getCompositeChildren(0,t.entries.length,i));return void(yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Jt(e,r,n,i)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())))}if(0===e.level&&0===t.level)return void(yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Qt(e.entries,t.entries)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())));let r=Kt(e.entries,t.entries);for(let s of r){let[r,a]=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(Promise.all([e.getCompositeChildren(s[0],s[1],n),t.getCompositeChildren(s[3],s[2],i)]));yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Jt(r,a,n,i)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}}))).apply(this,arguments)}function*Qt(e,t){let n=e.length,i=t.length,r=0,s=0;for(;r<n&&s<i;){let n=e[r][0],i=t[s][0];n===i?(it(e[r][1],t[s][1])||(yield{op:"change",key:n,oldValue:e[r][1],newValue:t[s][1]}),r++,s++):n<i?(yield{op:"del",key:n,oldValue:e[r][1]},r++):(yield{op:"add",key:i,newValue:t[s][1]},s++)}for(;r<n;r++)yield{op:"del",key:e[r][0],oldValue:e[r][1]};for(;s<i;s++)yield{op:"add",key:t[s][0],newValue:t[s][1]}}function Zt(e,t,n){return Xt.apply(this,arguments)}function Xt(){return(Xt=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t,n){if(e===Ut)return;let i=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(n(e)),r=i[1],s=0;if(t&&(s=Tt(t,r)),At(i))for(;s<r.length;s++)yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Zt(r[s][1],t,n)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())),t="";else for(;s<r.length;s++)yield r[s]}))).apply(this,arguments)}async function en(e,t){let n=[],i="add"===t?e=>({op:"add",key:e[0],newValue:e[1]}):e=>({op:"del",key:e[0],oldValue:e[1]});var r,s=!1,a=!1;try{for(var l,u=o(e.entries());s=!(l=await u.next()).done;s=!1){let e=l.value;n.push(i(e))}}catch(e){a=!0,r=e}finally{try{s&&null!=u.return&&await u.return()}finally{if(a)throw r}}return n}var tn=class extends zt{constructor(e,t=Ut,n=8192,i=16384,r,s){super(e,t,r,s),this.s=new Ve,this.N=new Map,this.minSize=n,this.maxSize=i}async getNode(e){return this.N.get(e)||super.getNode(e)}U(e){Ke(e.isMutable),this.N.set(e.hash,e)}updateNode(e){Ke(e.isMutable),this.N.delete(e.hash),e.hash=xt(),this.U(e)}newInternalNodeImpl(e,t){let n=new $t(e,xt(),t,!0);return this.U(n),n}newDataNodeImpl(e){let t=new Ft(e,xt(),!0);return this.U(t),t}newNodeImpl(e,t){let n=Gt(e,xt(),t,!0);return this.U(n),n}childNodeSize(e){let t=this.chunkHeaderSize;for(let n of e.entries)t+=this.getEntrySize(n);return t}get(e){return this.s.withRead((()=>super.get(e)))}has(e){return this.s.withRead((()=>super.has(e)))}isEmpty(){return this.s.withRead((()=>super.isEmpty()))}scan(e){var t=()=>super.scan,n=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(nn(n.s,t().call(n,e))),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}keys(){var e=()=>super.keys,t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(nn(t.s,e().call(t))),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}entries(){var e=()=>super.entries,t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(nn(t.s,e().call(t))),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}diff(e){var t=()=>super.diff,n=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(nn(n.s,t().call(n,e))),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}put(e,t){return this.s.withWrite((async()=>{let n=await(await this.getNode(this.rootHash)).set(e,t,this);if(this.childNodeSize(n)>this.maxSize){let e=this.chunkHeaderSize,t=qt(n.entries,this.getEntrySize,this.minSize-e,this.maxSize-e),{level:i}=n,r=t.map((e=>{let t=this.newNodeImpl(e,i);return[t.maxKey(),t.hash]})),s=this.newInternalNodeImpl(r,i+1);this.rootHash=s.hash}else this.rootHash=n.hash}))}del(e){return this.s.withWrite((async()=>{let t=await(await this.getNode(this.rootHash)).del(e,this),n=this.rootHash!==t.hash;return n&&(t.level>0&&1===t.entries.length?this.rootHash=t.entries[0][1]:this.rootHash=t.hash),n}))}clear(){return this.s.withWrite((async()=>{this.N.clear(),this.rootHash=Ut}))}flush(){let e=(t,n,i)=>{let r=this.N.get(t);if(void 0===r)return t;if(Wt(r)){let e=i(r.toChunkData(),[]);return n.push(e),e.hash}let s=[];for(let t of r.entries){let r=t[1],a=e(r,n,i);a!==r&&(t[1]=a),s.push(a)}let a=i(r.toChunkData(),s);return n.push(a),a.hash};return this.s.withWrite((async()=>{let t=this.p;if(this.rootHash===Ut){let e=t.createChunk(Vt,[]);return await t.putChunk(e),e.hash}let n=[],i=e(this.rootHash,n,t.createChunk);return await Promise.all(n.map((e=>t.putChunk(e)))),this.N.clear(),this.rootHash=i,i}))}};function nn(e,t){return rn.apply(this,arguments)}function rn(){return(rn=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t){let n=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.read());try{yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(t),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}finally{n()}}))).apply(this,arguments)}async function sn(e,t){return Ot(t.diff(e))}var an=class{constructor(e,t){this.s=new Ve,this.meta=e,this.r=t}async withMap(e,t){return this.r||await this.s.withWrite((async()=>this.r=this.createBTree(e))),this.s.withRead((()=>t(this.r)))}},on=class extends an{constructor(e,t){super(e,t)}createBTree(e){return new zt(e,this.meta.valueHash)}},ln=class extends an{constructor(e,t){super(e,t)}createBTree(e){return new tn(e,this.meta.valueHash)}flush(){return this.s.withWrite((()=>this.r?this.r.flush():this.meta.valueHash))}clear(){return this.s.withWrite((async()=>{var e;await(null==(e=this.r)?void 0:e.clear())}))}};async function un(e,t,n,i,r,s){var a;try{for(let e of function(e,t,n){let i=function(e,t){function n(e){if(!(e.startsWith("+")||e.startsWith("0")&&1!==e.length))return parseInt(e,10)}if(""===t)return e;if(!t.startsWith("/"))return;let i=t.split("/").slice(1).map((e=>e.replace(/~1/g,"/").replace(/~0/g,"~"))),r=e;for(let e of i){let t;if(Array.isArray(r)){let i=n(e);if(void 0===i)return;t=r[i]}else{if(null===r)return;"object"==typeof r&&(t=r[e])}if(void 0===t)return;r=t}return r}(t,n);if(void 0===i)throw new Error(`No value at path: ${n}`);let r=Array.isArray(i)?i:[i],s=[];for(let t of r){if("string"!=typeof t)throw new Error("Unsupported target type");s.push(cn([t,e]))}return s}(i,r,s))switch(n){case mn.Add:await t.put(e,r);break;case mn.Remove:await t.del(e)}}catch(t){null==(a=e.info)||a.call(e,"Not indexing value",r,":",t)}}function cn(e){let t=e[0],n=e[1];if(t.includes("\0"))throw new Error("Secondary key cannot contain null byte");return"\0"+t+"\0"+n}function hn(e,t){let n=cn([e,t||""]);return void 0===t?n.slice(0,n.length-1):n}function dn(e){if("\0"!==e[0])throw new Error("Invalid version");let t="\0".length,n="\0".length,i=e.indexOf("\0",t);if(-1===i)throw new Error("Invalid formatting");return[e.slice(t,i),e.slice(i+n)]}var fn,mn=((fn=mn||{})[fn.Add=0]="Add",fn[fn.Remove=1]="Remove",fn),pn=class{constructor(e,t,n,i){this.Oe=e,this.Me=t,this.K=n,this.Te=i}[Symbol.asyncIterator](){return this.values()}values(){let e=this.K.shouldDeepClone?rt:e=>e;return new wn(this.re((t=>e(t[1]))))}keys(){return new wn(this.re((e=>e[0])))}entries(){let e=this.K.shouldDeepClone?rt:e=>e;return new wn(this.re((t=>e(t))))}toArray(){return this.values().toArray()}re(e){return function(e,t,n,i,r){return yn.apply(this,arguments)}(e,this.Oe,this.Me,this.K,this.Te)}},wn=class{constructor(e){this.q=e}next(){return this.q.next()}[Symbol.asyncIterator](){return this.q[Symbol.asyncIterator]()}toArray(){return Ot(this.q)}};function yn(){return yn=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t,n,i,r){var s;bt(i);let{limit:a=1/0}=n,{prefix:l=""}=n,u=null==(s=n.start)?void 0:s.exclusive,c=wt(n);var h,d=!1,f=!1;try{for(var m,p=o(t);d=!(m=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(p.next())).done;d=!1){let t=m.value,i=t[0];if(!(c?i[0]:i).startsWith(l))return;if(u)if(u=!0,c){if(vn(i,n.start.key))continue}else if(gn(i,n.start.key))continue;if(yield e(t),0==--a&&!c)return void r(i)}}catch(e){f=!0,h=e}finally{try{d&&null!=p.return&&(yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(p.return()))}finally{if(f)throw h}}})),yn.apply(this,arguments)}function vn(e,t){let[n,i]=yt(t),[r,s]=yt(e);return r===n&&(void 0===i||s===i)}function gn(e,t){return e===t}function bn(e,t){if(wt(e)){let[n,i]=function(e){let{prefix:t,start:n}=e,i=[null!=t?t:"",void 0];if(!n)return i;let r=yt(n.key);return r[0]>i[0]||r[0]===i[0]&&void 0!==r[1]?r:i}(e);return new pn(t(e.indexName,n,i),e,{closed:!1,shouldDeepClone:!1},(e=>{}))}let n=mi(e);return new pn(t(n),e,{closed:!1,shouldDeepClone:!1},(e=>{}))}function On(e){let{prefix:t,start:n}=e,i="";if(void 0!==t&&(i=hn(t,void 0)),!n)return i;let{key:r}=n,[s,a]=yt(r),o=hn(s,a);return o>i?o:i}var Dn="main",_n=class{constructor(e){this.chunk=e}get meta(){return this.chunk.data.meta}isLocal(){return 2===this.meta.type}isSnapshot(){return 3===this.meta.type}isIndexChange(){return 1===this.meta.type}get valueHash(){return this.chunk.data.valueHash}get mutationID(){let{meta:e}=this;switch(e.type){case 1:case 3:return e.lastMutationID;case 2:return e.mutationID}}get nextMutationID(){return this.mutationID+1}get indexes(){return this.chunk.data.indexes}};async function kn(e,t){return(await xn(e,t)).filter((e=>e.isLocal()))}async function En(e,t){let n=await Nn(e,t);for(;!n.isSnapshot();){let{meta:e}=n,{basisHash:i}=e;if(null===i)throw new Error(`Commit ${n.chunk.hash} has no basis`);n=await Nn(i,t)}return n}function Un(e){let t=e.meta;return[t.lastMutationID,t.cookieJSON]}async function xn(e,t){let n=await Nn(e,t),i=[];for(;!n.isSnapshot();){let{meta:e}=n,{basisHash:r}=e;if(null===r)throw new Error(`Commit ${n.chunk.hash} has no basis`);i.push(n),n=await Nn(r,t)}return i.push(n),i}async function Nn(e,t){return function(e){return function(e){let{data:t}=e;Sn(t);let n=new Set;for(let e of t.indexes){let{name:t}=e.definition;if(n.has(t))throw new Error(`Duplicate index ${t}`);n.add(t)}}(e),new _n(e)}(await t.mustGetChunk(e))}function Cn(e,t,n,i,r){return{meta:{type:3,basisHash:e,lastMutationID:t,cookieJSON:n},valueHash:i,indexes:r}}function In(e,t){return new _n(e(t,Mn(t)))}function Mn(e){let t=[e.valueHash],{meta:n}=e;switch(n.type){case 1:case 2:n.basisHash&&t.push(n.basisHash)}for(let n of e.indexes)t.push(n.valueHash);return t}function Sn(e){0}var Ln=class{constructor(e,t,n){this.shouldDeepClone=!1,this.p=e,this.map=t,this.indexes=n}has(e){return this.map.has(e)}get(e){return this.map.get(e)}isEmpty(){return this.map.isEmpty()}async getMapForIndex(e){let t=this.indexes.get(e);if(void 0===t)throw new Error(`Unknown index name: ${e}`);return t.withMap(this.p,(e=>e))}get closed(){return this.p.closed}close(){this.p.close()}};function Tn(e){return{type:0,name:e}}function jn(e){return{type:1,hash:e}}function An(e){return async function(e,t){let[,n,i]=await async function(e,t){let[n,i]=await Rn(e,t);return[n,i,new zt(t,i.valueHash)]}(e,t),r=Pn(n);return new Ln(t,i,r)}(Tn(Dn),e)}async function Rn(e,t){let n;switch(e.type){case 1:n=e.hash;break;case 0:{let i=await t.getHead(e.name);if(void 0===i)throw new Error(`Unknown head: ${e.name}`);n=i;break}}return[n,await Nn(n,t)]}async function Fn(e,t){let[n,i]=await Rn(e,t);return[n,i,new tn(t,i.valueHash)]}function Pn(e){let t=new Map;for(let n of e.indexes)t.set(n.definition.name,new on(n,void 0));return t}function Hn(e){let t;return()=>(void 0===t&&(t=e()),t)}var $n=class extends Ln{constructor(e,t,n,i,r){super(e,t,r),this.shouldDeepClone=!0,this.i=e,this.m=n,this.y=i}static async newLocal(e,t,n,i,r,s){let[,a,o]=await Fn(e,r),l=a.nextMutationID,u=Wn(a);return new $n(r,o,a,{type:1,mutatorName:t,mutatorArgs:n,mutationID:l,originalHash:i,timestamp:s},u)}static async newSnapshot(e,t,n,i,r){let[,s,a]=await Fn(e,i);return new $n(i,a,s,{type:2,lastMutationID:t,cookie:n},r)}static async newIndexChange(e,t){let[,n,i]=await Fn(e,t),r=n.mutationID,s=Wn(n);return new $n(t,i,n,{type:0,lastMutationID:r},s)}isRebase(){return 1===this.y.type&&null!==this.y.originalHash}async put(e,t,n){if(0===this.y.type)throw new Error("Not allowed");let i=Hn((()=>this.map.get(t)));await Gn(e,this.indexes,this.i,t,i,n),await this.map.put(t,n)}async del(e,t){if(0===this.y.type)throw new Error("Not allowed");let n=Hn((()=>this.map.get(t)));return void 0!==n&&await Gn(e,this.indexes,this.i,t,n,void 0),this.map.del(t)}async clear(){if(0===this.y.type)throw new Error("Not allowed");await this.map.clear();let e=[];for(let t of this.indexes.values())e.push(t.clear());await Promise.all(e)}async createIndex(e,t,n,i){if(1===this.y.type)throw new Error("Not allowed");let r={name:t,keyPrefix:n,jsonPointer:i},s=this.indexes.get(t);if(s){let e=s.meta.definition;if(e.name===t&&e.keyPrefix===n&&e.jsonPointer===i)return;throw new Error("Index exists with different definition")}let a=new tn(this.i);var l,u=!1,c=!1;try{for(var h,d=o(this.map.scan(n));u=!(h=await d.next()).done;u=!1){let t=h.value;await un(e,a,0,t[0],t[1],i)}}catch(e){c=!0,l=e}finally{try{u&&null!=d.return&&await d.return()}finally{if(c)throw l}}this.indexes.set(t,new ln({definition:r,valueHash:Ut},a))}async dropIndex(e){if(1===this.y.type)throw new Error("Not allowed");if(!this.indexes.delete(e))throw new Error(`No such index: ${e}`)}async commit(e){let[t]=await this.commitWithDiffs(e,!1);return t}async commitWithDiffs(e,t){let n=await this.map.flush(),i=[];if(t&&this.m){let e=new zt(this.i,this.m.valueHash);i=await sn(e,this.map)}let r,s=[],a=new Map;i.length>0&&a.set("",i),r=t&&this.m?Pn(this.m):new Map;for(let[e,n]of this.indexes){let i=await n.flush();if(t){let t=r.get(e),i=await n.withMap(this.i,(async e=>t?t.withMap(this.i,(t=>sn(t,e))):en(e,"add")));i.length>0&&a.set(e,i)}let o={definition:n.meta.definition,valueHash:i};s.push(o)}if(t)for(let[e,t]of r)if(!this.indexes.has(e)){let n=await t.withMap(this.i,(e=>en(e,"del")));n.length>0&&a.set(e,n)}let o,l=this.m?this.m.chunk.hash:null,u=this.y;switch(u.type){case 1:{let{mutationID:e,mutatorName:t,mutatorArgs:i,originalHash:r,timestamp:a}=u;o=function(e,t,n,i,r,s,a,o,l){return In(e,{meta:{type:2,basisHash:t,mutationID:n,mutatorName:i,mutatorArgsJSON:r,originalHash:s,timestamp:l},valueHash:a,indexes:o})}(this.i.createChunk,l,e,t,i,r,n,s,a);break}case 2:{let{lastMutationID:e,cookie:t}=u;o=function(e,t,n,i,r,s){return In(e,Cn(t,n,i,r,s))}(this.i.createChunk,l,e,t,n,s);break}case 0:{let{lastMutationID:e}=u;if(void 0!==this.m){if(this.m.mutationID!==e)throw new Error("Index change must not change mutationID");if(this.m.valueHash!==n)throw new Error("Index change must not change valueHash")}o=function(e,t,n,i,r){return In(e,{meta:{type:1,basisHash:t,lastMutationID:n},valueHash:i,indexes:r})}(this.i.createChunk,l,e,n,s);break}}return await Promise.all([this.i.putChunk(o.chunk),this.i.setHead(e,o.chunk.hash)]),await this.i.commit(),[o.chunk.hash,a]}close(){this.i.close()}};async function Gn(e,t,n,i,r,s){let a=[];for(let o of t.values())if(i.startsWith(o.meta.definition.keyPrefix)){let t=await r();await o.withMap(n,(async n=>{void 0!==t&&a.push(un(e,n,1,i,t,o.meta.definition.jsonPointer)),void 0!==s&&a.push(un(e,n,0,i,s,o.meta.definition.jsonPointer))}))}await Promise.all(a)}function Wn(e){let t=new Map;for(let n of e.indexes)t.set(n.definition.name,new ln(n,void 0));return t}var qn=class extends Error{constructor(e){super(`Chunk not found ${e}`),this.name="ChunkNotFoundError",this.hash=e}};async function Vn(e,t){let n=await e.getChunk(t);if(n)return n;throw new qn(t)}var Bn=class{constructor(){this.Ve=new Map,this.Ae=new Map}get mappings(){return this.Ae}Le(e,t){let n=this.Ve.get(e);if(void 0!==n)return n;let i=t();return this.Ve.set(e,i),i}_e(e,t=1){return this.Le(e,(()=>this.transformCommit(e,t)))}async transformCommit(e,t=1){if(this.shouldSkip(e))return e;let n=await this.getChunk(e);if(!n){if(0===t)return e;throw new Error(`Chunk ${e} not found`)}let{data:i}=n;Sn();let r=await this.Dt(i);return this.Fe(e,r,i,Mn)}shouldSkip(e){return!1}shouldForceWrite(e){return!1}async mustGetChunk(e){return Vn(this,e)}async Fe(e,t,n,i){if(t!==n||this.shouldForceWrite(e)){let n=await this.writeChunk(e,t,i);return this.Ae.set(e,n),n}return e}async Dt(e){let[t,n,i]=await Promise.all([this.kt(e.meta),this.Pt(e.valueHash),this.Et(e.indexes)]);return t===e.meta&&n===e.valueHash&&i===e.indexes?e:{meta:t,valueHash:n,indexes:i}}kt(e){switch(e.type){case 1:return this.Ot(e);case 2:return this.Mt(e);case 3:return this.Tt(e)}}ae(e,t){return null!==e?this._e(e,t):null}async Tt(e){let t=await this.ae(e.basisHash,0);return t===e.basisHash?e:{basisHash:t,type:e.type,lastMutationID:e.lastMutationID,cookieJSON:e.cookieJSON}}async Mt(e){let t=this.ae(e.basisHash,1),n=e.originalHash&&this._e(e.originalHash,0),i=await t,r=await n;return i===e.basisHash&&r===e.originalHash?e:{basisHash:i,type:e.type,mutationID:e.mutationID,mutatorName:e.mutatorName,mutatorArgsJSON:e.mutatorArgsJSON,originalHash:r,timestamp:e.timestamp}}async Ot(e){let t=await this.ae(e.basisHash,1);return t===e.basisHash?e:{basisHash:t,type:e.type,lastMutationID:e.lastMutationID}}Pt(e){return this.oe(e)}oe(e){return this.Le(e,(()=>this.transformBTreeNode(e)))}async transformBTreeNode(e){if(this.shouldSkip(e))return e;let{data:t}=await this.mustGetChunk(e),n=await this.transformBTreeNodeData(t);return this.Fe(e,n,t,St)}async transformBTreeNodeData(e){let t,n=e[0],i=e[1];return t=At(e)?await this.Vt(i):await this.At(i),t===i?e:[n,t]}async transformBTreeDataEntry(e){return e}async At(e){return this.ie(e,(e=>this.transformBTreeDataEntry(e)))}async transformBTreeInternalEntry(e){let t=await this.oe(e[1]);return t===e[1]?e:[e[0],t]}async Vt(e){return this.ie(e,(e=>this.transformBTreeInternalEntry(e)))}async ie(e,t){let n=await Promise.all(e.map(t));for(let t=0;t<n.length;t++)if(e[t]!==n[t])return n;return e}Et(e){return this.ie(e,(e=>this.transformIndexRecord(e)))}async transformIndexRecord(e){let t=await this.oe(e.valueHash);return t===e.valueHash?e:{definition:e.definition,valueHash:t}}},Kn=class extends Bn{constructor(e){super(),this.dagWrite=e}getChunk(e){return this.dagWrite.getChunk(e)}async writeChunk(e,t,n){let{dagWrite:i}=this,r=i.createChunk(t,n(t));return await i.putChunk(r),r.hash}};function zn(){let e=new Uint8Array(36);return crypto.getRandomValues(e),function(e){return Jn.map(((t,n)=>{switch(t){case 0:return(15&e[n]).toString(16);case 1:return(8+(3&e[n])).toString(16);case 3:return"4";case 2:return"-"}})).join("")}(e)}var Jn=[0,0,0,0,0,0,0,0,2,0,0,0,0,2,3,0,0,0,2,1,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0];function Yn(e){Qe(e),Je(e.httpStatusCode),ze(e.errorMessage)}function Qn(e,t,n,i,r){let s={headers:{"Content-type":"application/json",Authorization:i,"X-Replicache-RequestID":r},body:JSON.stringify(n),method:"POST"};return e(new Request(t,s))}var Zn="sync";function Xn(e){return e instanceof Error?e:new Error(String(e))}async function ei(e,t,n,i,r,s,a,o=!0){var l,u;let{pullURL:c,pullAuth:h,schemaVersion:d}=n,f=await s.withRead((async e=>{let t=await e.getHead(Dn);if(!t)throw new Error("Internal no main head found");return await En(t,e)})),[,m]=Un(f),p={profileID:e,clientID:t,cookie:m,lastMutationID:f.mutationID,pullVersion:0,schemaVersion:d};null==(l=a.debug)||l.call(a,"Starting pull...");let w=Date.now(),{response:y,httpRequestInfo:v}=await async function(e,t,n,i,r){try{let s=await Qn(e,t,n,i,r);return function(e){if("object"!=typeof e||null===e)throw new Error("Expected result to be an object");void 0!==e.response&&dt(e.response),Yn(e.httpRequestInfo)}(s),s}catch(e){throw new pt(Xn(e))}}(i,c,p,h,r);if(null==(u=a.debug)||u.call(a,`...Pull ${y?"complete":"failed"} in `,Date.now()-w,"ms"),!y)return{httpRequestInfo:v,syncHead:Ut};if(!o||ht(y))return{httpRequestInfo:v,pullResponse:y,syncHead:Ut};let g=await ti(a,s,m,y);if(null===g)throw new Error("Overlapping sync JsLogInfo");return{httpRequestInfo:v,pullResponse:y,syncHead:g}}async function ti(e,t,n,i){return await t.withWrite((async t=>{var r,s;let a=t,l=await a.getHead(Dn);if(void 0===l)throw new Error("Main head disappeared");let u=await En(l,a),[c,h]=Un(u);if(!it(n,h))return null;if(i.lastMutationID<c)throw new Error(`Received lastMutationID ${i.lastMutationID} is < than last snapshot lastMutationID ${c}; ignoring client view`);if(0===i.patch.length&&i.lastMutationID===c&&(null!=(r=i.cookie)?r:null)===h)return Ut;let d=(await xn(l,a)).find((e=>e.mutationID<=i.lastMutationID));if(!d)throw new Error("Internal invalid chain");let f=await $n.newSnapshot(jn(u.chunk.hash),i.lastMutationID,null!=(s=i.cookie)?s:null,t,Wn(d));await async function(e,t,n){for(let i of n)switch(i.op){case"put":await t.put(e,i.key,i.value);break;case"del":await t.del(e,i.key);break;case"clear":await t.clear()}}(e,f,i.patch);let m=new zt(a,d.valueHash);var p,w=!1,y=!1;try{for(var v,g=o(f.map.diff(m));w=!(v=await g.next()).done;w=!1){let n=v.value;await Gn(e,f.indexes,t,n.key,(()=>Promise.resolve(n.oldValue)),n.newValue)}}catch(e){y=!0,p=e}finally{try{w&&null!=g.return&&await g.return()}finally{if(y)throw p}}return await f.commit(Zn)}))}async function ni(e,t,n){return await e.withWrite((async e=>{var i;let r=e,s=await r.getHead(Zn);if(void 0===s)throw new Error("Missing sync head");if(s!==n)throw null==(i=t.error)||i.call(t,"maybeEndPull, Wrong sync head. Expecting:",n,"got:",s),new Error("Wrong sync head");let a=await En(s,r),o=await r.getHead(Dn);if(void 0===o)throw new Error("Missing main head");let l=await En(o,r),{meta:u}=a,c=u.basisHash;if(null===a)throw new Error("Sync snapshot with no basis");if(c!==l.chunk.hash)throw new Error("Overlapping syncs");let h=await kn(o,r),d=await Nn(s,r);h=h.filter((e=>e.mutationID>d.mutationID)),h.reverse();let f=new Map;if(h.length>0){let e=[];for(let t of h){let n,i,r;if(!t.isLocal())throw new Error("pending mutation is not local");{let e=t.meta;n=e.mutatorName,i=e.mutatorArgsJSON,r=e.timestamp}e.push({id:t.mutationID,name:n,args:rt(i),original:t.chunk.hash,timestamp:r})}return{syncHead:s,replayMutations:e,diffs:f}}let m=await Nn(o,r),p=new zt(r,m.valueHash),w=new zt(r,d.valueHash),y=await sn(p,w);if(y.length>0&&f.set("",y),await async function(e,t,n,i){let r=Pn(e),s=Pn(t);for(let[e,t]of r)await t.withMap(n,(async t=>{let r=s.get(e);if(void 0!==r){let a=await r.withMap(n,(async e=>sn(t,e)));s.delete(e),a.length>0&&i.set(e,a)}else{let n=await en(t,"del");n.length>0&&i.set(e,n)}}));for(let[e,t]of s)await t.withMap(n,(async t=>{let n=await en(t,"add");n.length>0&&i.set(e,n)}))}(m,d,r,f),await Promise.all([e.setHead(Dn,s),e.removeHead(Zn)]),await e.commit(),t.debug){let[e,n]=Un(l),[i,r]=Un(a);t.debug("Successfully pulled new snapshot w/last_mutation_id:",i,"(prev:",e,"), cookie: ",r,"(prev:",n,"), sync head hash:",s,", main head hash:",o,", value_hash:",d.valueHash,"(prev:",l.valueHash)}return{syncHead:s,replayMutations:[],diffs:f}}))}function ii(e){return{id:e.mutationID,name:e.mutatorName,args:e.mutatorArgsJSON,timestamp:e.timestamp}}async function ri(e,t,n,i,r,s,a,o,l){var u,c;let h,d=await t.withRead((async e=>{let t=await e.getHead(Dn);if(!t)throw new Error("Internal no main head");return await kn(t,e)}));if(d.reverse(),d.length>0){let t=[];for(let e of d){if(!e.isLocal())throw new Error("Internal non local pending commit");t.push(ii(e.meta))}let f={profileID:i,clientID:r,mutations:t,pushVersion:0,schemaVersion:l};null==(u=n.debug)||u.call(n,"Starting push...");let m=Date.now();h=await async function(e,t,n,i,r){try{let s=await Qn(e,t,n,i,r);return Yn(s),s}catch(e){throw new ct(Xn(e))}}(s,a,f,o,e),null==(c=n.debug)||c.call(n,"...Push complete in ",Date.now()-m,"ms")}return h}var si="";var ai=new Map;function oi(e){let t=ai.get(e);return t?(t++,ai.set(e,t)):(ai.set(e,0),t=0),`${e}-${function(){if(""===si){let e=new Uint8Array(4);crypto.getRandomValues(e),si=Array.from(e,(e=>e.toString(16))).join("")}return si}()}-${t}`}var li=0,ui=class{constructor(e,t,n,i="openReadTransaction"){this.clientID=e,this.dbtx=t,this.e=n.addContext(i).addContext("txid",li++)}async get(e){return bt(this.dbtx),this.dbtx.get(e)}async has(e){return bt(this.dbtx),this.dbtx.has(e)}async isEmpty(){return bt(this.dbtx),this.dbtx.isEmpty()}scan(e){return hi(e,this.dbtx,ci)}};function ci(e){}function hi(e,t,n){let i=function(e,t){return t&&wt(t)?function(e,t){return pi.apply(this,arguments)}(e,t):e.map.scan(mi(t))}(t,e);return function(e,t,n,i){return new pn(e,t,n,i)}(i,null!=e?e:{},t,n)}var di=class extends ui{constructor(e,t,n,i="openWriteTransaction"){super(e,t,n,i)}async put(e,t){bt(this.dbtx),await this.dbtx.put(this.e,e,rt(t))}async del(e){return bt(this.dbtx),await this.dbtx.del(this.e,e)}async commit(e){let t=this.dbtx;bt(t);let n=t.isRebase()?Zn:Dn;return await t.commitWithDiffs(n,e)}},fi=class extends di{constructor(e,t,n){super(e,t,n,"openIndexTransaction")}async createIndex(e){var t;bt(this.dbtx),await this.dbtx.createIndex(this.e,e.name,null!=(t=e.prefix)?t:"",e.jsonPointer)}async dropIndex(e){bt(this.dbtx),await this.dbtx.dropIndex(e)}};function mi(e){if(!e)return"";let{prefix:t="",start:n}=e;return n&&n.key>t?n.key:t}function pi(){return pi=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t){let n=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getMapForIndex(t.indexName));var i,r=!1,s=!1;try{for(var a,l=o(n.scan(On(t)));r=!(a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(l.next())).done;r=!1){let e=a.value;yield[dn(e[0]),e[1]]}}catch(e){s=!0,i=e}finally{try{r&&null!=l.return&&(yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(l.return()))}finally{if(s)throw i}}})),pi.apply(this,arguments)}var wi=class extends Error{constructor(e){super(e),this.name="AbortError"}};function yi(e,t){return 0===e?Promise.resolve():new Promise(((n,i)=>{let r=setTimeout((()=>{n()}),e);t&&t.addEventListener("abort",(()=>{r&&clearTimeout(r),i(new wi("Aborted"))}))}))}var vi=30,gi=6e4,bi=class{constructor(e){this.$=We(),this.t=!1,this.G=void 0,this.de=e,this.run()}close(){this.t=!0}send(){var e,t;null==(t=(e=this.de).debug)||t.call(e,"send"),this.$.resolve()}async run(){let e,t=[],n=We(),i=0,r=this.de,{debug:s}=r,a=0;for(null==s||s("Starting connection loop");!this.t;){null==s||s(Di(t)?"Last request failed. Trying again":"Waiting for a send");let o=[this.$.promise],l=r.watchdogTimer;if(null!==l&&o.push(yi(l)),await Promise.race(o),this.t||(null!=s&&s("Waiting for debounce"),await yi(r.debounceDelay),this.t))break;if(null!=s&&s("debounced"),this.$=We(),i>=r.maxConnections){if(null!=s&&s("Too many request in flight. Waiting until one finishes..."),await this.Lt(),this.t)break;null==s||s("...finished")}i>0||Di(t)?(a=Oi(a,r,t),null==s||s(Di(t)?"Last connection errored. Sleeping for":"More than one outstanding connection ("+i+"). Sleeping for",a,"ms")):a=0;let u=Math.min(r.maxDelayMs,Math.max(r.minDelayMs,a));if(void 0!==e){let t=Date.now()-e;if(u>t&&(await Promise.race([yi(u-t),n.promise]),this.t))break}i++,(async()=>{let a,o=Date.now();try{e=o,null!=s&&s("Sending request"),a=await r.invokeSend(),null==s||s("Send returned",a)}catch(e){null!=s&&s("Send failed",e),a=!1}this.t?null==s||s("Closed after invokeSend"):(null!=s&&s("Request done",{duration:Date.now()-o,ok:a}),t.push({duration:Date.now()-o,ok:a}),_i(t)&&(n.resolve(),n=We()),i--,this._t(),a||this.$.resolve())})()}}_t(){if(this.G){let e=this.G;this.G=void 0,e()}}Lt(){let{promise:e,resolve:t}=We();return this.G=t,e}};function Oi(e,t,n){let{length:i}=n;if(0===i)return e;let{ok:r}=n[n.length-1],{maxConnections:s,minDelayMs:a}=t;if(!r)return 0===e?a:2*e;if(i>1){let e=n[n.length-2];for(;n.length>9;)n.shift();if(r&&!e.ok)return a}return function(e){e.sort();let{length:t}=e,n=t>>1;return t%2==1?e[n]:(e[n-1]+e[n])/2}(n.filter((({ok:e})=>e)).map((({duration:e})=>e)))/s|0}function Di(e){return e.length>0&&!e[e.length-1].ok}function _i(e){return e.length>1&&!e[e.length-2].ok&&e[e.length-1].ok}var ki=class{constructor(e,t,n){this.maxConnections=1,this.rep=e,this.invokeSend=t,this.logger=n}get maxDelayMs(){return this.rep.requestOptions.maxDelayMs}get minDelayMs(){return this.rep.requestOptions.minDelayMs}get debug(){return this.logger.debug}},Ei=class extends ki{constructor(){super(...arguments),this.debounceDelay=0}get watchdogTimer(){return this.rep.pullInterval}},Ui=class extends ki{constructor(){super(...arguments),this.watchdogTimer=null}get debounceDelay(){return this.rep.pushDelay}},xi=new Set;function Ni(e,t,n,i){if(""===n)for(let t of i)if(e.has(t.key))return!0;for(let e of t)if(Ci(e,n,i))return!0;return!1}function Ci(e,t,n){for(let i of n)if(Ii(e,t,i.key))return!0;return!1}function Ii(e,t,n){let{indexName:i="",limit:r,prefix:s,startKey:a,startExclusive:o,startSecondaryKey:l}=e.options;if(t!==i)return!1;if(!i)return!(void 0!==r&&r<=0)&&(!s&&!a||!(s&&(!n.startsWith(s)||Mi(e,n))||a&&(o&&n<=a||n<a||Mi(e,n))));if(!s&&!a&&!l)return!0;let[u,c]=dn(n);return!(s&&!u.startsWith(s)||l&&(o&&u<=l||u<l)||a&&(o&&c<=a||c<a))}function Mi(e,t){let{inclusiveLimitKey:n}=e;return void 0!==e.options.limit&&void 0!==n&&t>n}var Si=Symbol(),Li={durability:"relaxed"},Ti="chunks",ji=class{constructor(e){this.t=!1,this.E=function(e){let t=indexedDB.open(e);t.onupgradeneeded=()=>{t.result.createObjectStore(Ti)};let n=Hi(t);return n.then((e=>{e.onversionchange=()=>e.close()})),n}(e)}async read(){return Fi(await this.E)}async withRead(e){let t=Fi(await this.E);try{return await e(t)}finally{t.release()}}async write(){return Ri(await this.E)}async withWrite(e){let t=Ri(await this.E);try{return await e(t)}finally{t.release()}}async close(){(await this.E).close(),this.t=!0}get closed(){return this.t}},Ai=class{constructor(e){this.t=!1,this.n=e}async has(e){return await Hi(Pi(this.n).count(e))>0}get(e){return Hi(Pi(this.n).get(e))}release(){this.t=!0}get closed(){return this.t}};function Ri(e){let t=e.transaction(Ti,"readwrite",Li);return new class extends class{constructor(e){this.f=new Map,this._=e}async has(e){switch(this.f.get(e)){case void 0:return this._.has(e);case Si:return!1;default:return!0}}async get(e){let t=this.f.get(e);switch(t){case Si:return;case void 0:return this._.get(e);default:return t}}async put(e,t){this.f.set(e,t)}async del(e){this.f.set(e,Si)}release(){this._.release()}get closed(){return this._.closed}}{constructor(e){super(new Ai(e)),this.ze=0,this.t=!1,this.n=e,this.Ge=this.Bt()}async Bt(){let e=this.n,t=new Promise(((t,n)=>{e.onabort=()=>t(2),e.oncomplete=()=>t(1),e.onerror=()=>n(e.error)}));this.ze=await t}async commit(){if(0===this.f.size)return;let e=Pi(this.n);if(this.f.forEach(((t,n)=>{t===Si?e.delete(n):e.put(t,n)})),await this.Ge,2===this.ze)throw new Error("Transaction aborted")}release(){this.t=!0}get closed(){return this.t}}(t)}function Fi(e){let t=e.transaction(Ti,"readonly");return new Ai(t)}function Pi(e){return e.objectStore(Ti)}function Hi(e){return new Promise(((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)}))}function $i(e){if(!Array.isArray(e))throw new Error("Meta must be an array");for(let t of e)ze(t)}function Gi(e,t,n){return Wi(n(e),e,t)}function Wi(e,t,n){return Ke(!n.includes(e),"Chunk cannot reference itself"),new class{constructor(e,t,n){this.hash=e,this.data=t,this.meta=n}}(e,t,n)}async function qi(e,t){return Wi(await Et(e),e,t)}function Vi(e){throw new Error("unexpected call to compute chunk hash")}function Bi(e){return`c/${e}/d`}function Ki(e){return`c/${e}/m`}function zi(e){return`c/${e}/r`}function Ji(e){return`h/${e}`}async function Yi(e,t,n){let i=[],r=[];for(let t of e)t.old&&r.push(t.old),t.new&&i.push(t.new);let s=new Map,a=new Map;for(let e of i)await Qi(e,1,s,a,n);for(let e of r)await Qi(e,-1,s,a,n);return await Promise.all(Array.from(t.values(),(e=>Zi(e,s,a,n)))),s}async function Qi(e,t,n,i,r){if(await Zi(e,n,i,r),function(e,t,n){let i=n.get(e);return Je(i),n.set(e,i+t),0===i&&1===t||1===i&&-1===t}(e,t,n)){let s=await r.getRefs(e);if(void 0!==s){let e=s.map((e=>Qi(e,t,n,i,r)));await Promise.all(e)}}}function Zi(e,t,n,i){let r=n.get(e);return void 0===r&&(r=(async()=>{let n=await i.getRefCount(e)||0;return t.set(e,n),n})(),n.set(e,r)),r}var Xi=class{constructor(e,t,n){this.O=e,this.u=t,this.g=n}async read(){return new er(await this.O.read(),this.g)}async withRead(e){return this.O.withRead((t=>e(new er(t,this.g))))}async write(){return new tr(await this.O.write(),this.u,this.g)}async withWrite(e){return this.O.withWrite((t=>e(new tr(t,this.u,this.g))))}async close(){await this.O.close()}},er=class{constructor(e,t){this.n=e,this.assertValidHash=t}async hasChunk(e){return await this.n.has(Bi(e))}async getChunk(e){let t=await this.n.get(Bi(e));if(void 0===t)return;let n,i=await this.n.get(Ki(e));return void 0!==i?($i(i),n=i):n=[],Wi(e,t,n)}async mustGetChunk(e){return Vn(this,e)}async getHead(e){let t=await this.n.get(Ji(e));if(void 0!==t)return It(t),t}close(){this.n.release()}get closed(){return this.n.closed}},tr=class extends er{constructor(e,t,n){super(e,n),this.le=new Set,this.ce=new Map,this.createChunk=(e,t)=>Gi(e,t,this.u),this.u=t}get kvWrite(){return this.n}async putChunk(e){let{hash:t,data:n,meta:i}=e;this.assertValidHash(t);let r,s=Bi(t),a=this.n.put(s,n);if(i.length>0){for(let e of i)this.assertValidHash(e);r=this.n.put(Ki(t),i)}this.le.add(t),await a,await r}setHead(e,t){return this.F(e,t)}removeHead(e){return this.F(e,void 0)}async F(e,t){let n,i=await this.getHead(e),r=Ji(e);n=void 0===t?this.n.del(r):this.n.put(r,t);let s=this.ce.get(e);void 0===s?this.ce.set(e,{new:t,old:i}):s.new=t,await n}async commit(){let e=await Yi(this.ce.values(),this.le,this);await this.Jt(e),await this.n.commit()}async getRefCount(e){let t=await this.n.get(zi(e));if(void 0!==t){if(Je(t),t<0||t>65535||t!==(0|t))throw new Error(`Invalid ref count ${t}. We expect the value to be a Uint16`);return t}}async getRefs(e){let t=await this.n.get(Ki(e));return void 0!==t&&$i(t),t}async Jt(e){let t=[];e.forEach(((e,n)=>{if(0===e)t.push(this.Wt(n));else{let i=zi(n);t.push(this.n.put(i,e))}})),await Promise.all(t)}async Wt(e){await Promise.all([this.n.del(Bi(e)),this.n.del(Ki(e)),this.n.del(zi(e))]),this.le.delete(e)}close(){this.n.release()}},nr=class{constructor(e,t,n,i,r=at){this.s=new Ve,this.v=new Map,this.S=new Map,this.o=new Map,this.w=new sr(t,r,this.o),this.M=e,this.u=n,this.g=i}async read(){let e=await this.s.read();return new ir(this.v,this.S,this.w,this.M,e,this.g)}async withRead(e){let t=await this.read();try{return await e(t)}finally{t.close()}}async write(){let e=await this.s.write();return new rr(this.v,this.S,this.w,this.M,this.o,e,this.u,this.g)}async withWrite(e){let t=await this.write();try{return await e(t)}finally{t.close()}}async close(){}get refCountsSnapshot(){return new Map(this.o)}},ir=class{constructor(e,t,n,i,r,s){this.v=new Map,this.S=new Map,this.z=void 0,this.t=!1,this.v=e,this.S=t,this.w=n,this.M=i,this.R=r,this.assertValidHash=s}async hasChunk(e){return void 0!==await this.getChunk(e)}async getChunk(e){if(Nt(e))return this.S.get(e);let t=this.w.get(e);return void 0===t&&(t=await(await this.Ut()).getChunk(e),void 0!==t&&this.w.put(t)),t}async mustGetChunk(e){return Vn(this,e)}async getHead(e){return this.v.get(e)}close(){var e;this.t||(this.R(),null==(e=this.z)||e.then((e=>e.close())),this.t=!0)}get closed(){return this.t}async Ut(){return this.z||(this.z=this.M.read()),this.z}},rr=class extends ir{constructor(e,t,n,i,r,s,a,o){super(e,t,n,i,s,o),this.T=new Map,this.I=new Map,this.createChunk=(e,t)=>Gi(e,t,this.u),this.o=r,this.u=a}async putChunk(e){let{hash:t,meta:n}=e;if(this.assertValidHash(t),n.length>0)for(let e of n)this.assertValidHash(e);this.I.set(t,e)}async setHead(e,t){await this.F(e,t)}async removeHead(e){await this.F(e,void 0)}async F(e,t){let n=await this.getHead(e),i=this.T.get(e);void 0===i?this.T.set(e,{new:t,old:n}):i.new=t}async hasChunk(e){return this.I.has(e)||super.hasChunk(e)}async getChunk(e){return this.I.get(e)||super.getChunk(e)}async getHead(e){let t=this.T.get(e);return t?t.new:super.getHead(e)}async commit(){let e=await Yi(this.T.values(),new Set(this.I.keys()),this),t=[],n=[];e.forEach(((e,t)=>{0===e?(this.o.delete(t),this.I.delete(t),Nt(t)?this.S.delete(t):n.push(t)):this.o.set(t,e)})),this.I.forEach(((e,n)=>{Nt(n)?this.S.set(n,e):t.push(e)})),this.T.forEach(((e,t)=>{e.new?this.v.set(t,e.new):this.v.delete(t)})),this.w.updateForCommit(t,n),this.I.clear(),this.T.clear(),this.close()}async getRefCount(e){return this.o.get(e)}async getRefs(e){var t,n;let i=this.I.get(e);return i?i.meta:Nt(e)?null==(t=this.S.get(e))?void 0:t.meta:null==(n=this.w.getWithoutUpdatingLRU(e))?void 0:n.meta}},sr=class{constructor(e,t,n){this.a=new Map,this.V=0,this.B=e,this.he=t,this.o=n}get(e){let t=this.a.get(e);return t&&(this.a.delete(e),this.a.set(e,t)),null==t?void 0:t.chunk}getWithoutUpdatingLRU(e){var t;return null==(t=this.a.get(e))?void 0:t.chunk}put(e){let{hash:t}=e,n=this.a.get(t);if(n)return this.a.delete(t),void this.a.set(t,n);let i=this.o.get(t);if(void 0===i||i<1)return;let r=this.he(e.data);r>this.B||(this.V+=r,this.a.set(t,{chunk:e,size:r}),e.meta.forEach((e=>{this.o.set(e,(this.o.get(e)||0)+1)})),this.Ye())}Ye(){if(!(this.V<=this.B))for(let e of this.a){if(this.V<=this.B)break;this.delete(e[1])}}delete(e){let{hash:t}=e.chunk;this.V-=e.size,this.a.delete(t),e.chunk.meta.forEach((t=>{let n=this.o.get(t);et(n),Ke(n>0);let i=n-1;if(0===i){this.o.delete(t);let n=this.a.get(t);n&&(Ke(e.chunk.hash!==t,"Found a chunk that references itself"),this.delete(n))}else this.o.set(t,i)}))}updateForCommit(e,t){let n=[];for(let t of e){let{hash:e}=t,i=this.a.get(e);if(i)this.a.delete(e),this.a.set(e,i);else{let i=this.he(t.data);this.V+=i;let r={chunk:t,size:i};this.a.set(e,r),i>this.B&&n.push(r)}}for(let e of t){let t=this.a.get(e);t&&(this.V-=t.size,this.a.delete(e))}for(let e of n)this.delete(e);this.Ye()}},ar="clients";function or(e){Qe(e);let{heartbeatTimestampMs:t,headHash:n}=e;Je(t),It(n)}async function lr(e){return ur(await e.getHead(ar),e)}async function ur(e,t){if(!e)return new Map;let n=await t.getChunk(e);return function(e){Qe(e);let t=new Map;for(let n in e)if(nt(e,n)){let i=e[n];void 0!==i&&(or(i),t.set(n,i))}return t}(null==n?void 0:n.data)}var cr=class extends Error{constructor(e){super(`Client state not found, id: ${e}`),this.name="ClientStateNotFoundError",this.id=e}};async function hr(e,t){return!!await async function(e,t){return(await lr(t)).get(e)}(e,t)}function dr(e){let t=function(e){return Object.fromEntries(e)}(e);return Et(t)}var fr=Symbol();async function mr(e,t){let[n,i]=await t.withRead((async e=>{let t=await e.getHead(ar);return[await ur(t,e),t]}));return pr(e,n,i,t)}async function pr(e,t,n,i){let r=await e(t);if(r===fr)return t;let{clients:s,chunksToPut:a}=r,o=await dr(s),l=await i.withWrite((async e=>{let t=await e.getHead(ar);if(t!==n)return{updateApplied:!1,clients:await ur(t,e),clientsHash:t};let i=function(e,t){return e.forEach((e=>{t.assertValidHash(e.headHash)})),Object.fromEntries(e)}(s,e),r=Array.from(s.values(),(e=>e.headHash)),l=Wi(o,i,r),u=[];if(a)for(let t of a)u.push(e.putChunk(t));return await Promise.all([...u,e.putChunk(l),e.setHead(ar,l.hash)]),await e.commit(),{updateApplied:!0,clients:s,clientsHash:o}}));return l.updateApplied?l.clients:pr(e,l.clients,l.clientsHash,i)}var wr=class extends Bn{constructor(e,t){super(),this.Ze=new Map,this.C=e,this.Xe=t}get fixedChunks(){return this.Ze}shouldSkip(e){return!this.C.has(e)}shouldForceWrite(e){return this.C.has(e)}async getChunk(e){let t=this.C.get(e);return Ke(void 0!==t),t}async writeChunk(e,t,n){let i=await this.Xe(t),r=Wi(i,t,n(t));return this.Ze.set(i,r),i}},yr=class extends Kn{constructor(e,t){super(e),this.Y=t}shouldSkip(e){return!Nt(e)&&!this.Y.has(e)}shouldForceWrite(e){return this.Y.has(e)}async writeChunk(e,t,n){let i=this.Y.get(e),r=n(t),s=i?Wi(i,t,r):this.dagWrite.createChunk(t,r);return await this.dagWrite.putChunk(s),s.hash}};async function vr(e,t,n,i){if(i())return;let r=n.withRead((t=>async function(e,t){if(!await hr(e,t))throw new cr(e)}(e,t))),[s,a,o,l]=await async function(e){return await e.withRead((async e=>{let t=await e.getHead(Dn);Ke(t);let n=new class extends class{constructor(e){this.j=new Set,this.dagRead=e}async visitCommit(e,t=1){if(this.j.has(e))return;this.j.add(e);let n=await this.dagRead.getChunk(e);if(!n){if(0===t)return;throw new qn(e)}let{data:i}=n;Sn(),await this.visitCommitChunk(n)}async visitCommitChunk(e){let{data:t}=e;await Promise.all([this.Rt(t.meta),this.St(t.valueHash),this.It(t.indexes)])}Rt(e){switch(e.type){case 1:return this.Ct(e);case 2:return this.vt(e);case 3:return this.Ht(e)}}async se(e,t){null!==e&&await this.visitCommit(e,t)}async Ht(e){await this.se(e.basisHash,0)}async vt(e){await this.se(e.basisHash,1),null!==e.originalHash&&await this.visitCommit(e.originalHash,0)}Ct(e){return this.se(e.basisHash,1)}St(e){return this.visitBTreeNode(e)}async visitBTreeNode(e){if(e===Ut||this.j.has(e))return;this.j.add(e);let t=await this.dagRead.mustGetChunk(e),{data:n}=t;await this.visitBTreeNodeChunk(t)}async visitBTreeNodeChunk(e){let{data:t}=e;At(t)&&await this.Nt(e)}async Nt(e){let{data:t}=e;await Promise.all(t[1].map((e=>this.visitBTreeNode(e[1]))))}async It(e){await Promise.all(e.map((async e=>this.visitBTreeNode(e.valueHash))))}}{constructor(){super(...arguments),this.C=new Map}get gatheredChunks(){return this.C}async visitCommit(e,t){if(Nt(e))return super.visitCommit(e,t)}async visitCommitChunk(e){return this.C.set(e.hash,e),super.visitCommitChunk(e)}async visitBTreeNode(e){if(Nt(e))return super.visitBTreeNode(e)}async visitBTreeNodeChunk(e){return this.C.set(e.hash,e),super.visitBTreeNodeChunk(e)}}(e);await n.visitCommit(t);let i=await Nn(t,e),r=await En(t,e);return[n.gatheredChunks,t,i.mutationID,r.meta.lastMutationID]}))}(t);if(0===s.size)return void await r;let u=async function(e,t){let n=new wr(e,Et),i=await n.transformCommit(t),{fixedChunks:r,mappings:s}=n;return[r,s,i]}(s,a);await r;let[c,h,d]=await u;i()||(await async function(e,t,n,i,r,s){let a=t.values();await mr((e=>({clients:new Map(e).set(i,{heartbeatTimestampMs:Date.now(),headHash:n,mutationID:r,lastServerAckdMutationID:s}),chunksToPut:a})),e)}(n,c,d,e,o,l),await async function(e,t){await e.withWrite((async e=>{for(let n of[Dn,Zn]){let i=await e.getHead(n);if(!i){if(n===Zn)break;throw new Error(`No head found for ${n}`)}let r=await new yr(e,t).transformCommit(i);await e.setHead(n,r)}await e.commit()}))}(t,h))}function gr(e,t,n,i,r){var s;if(r.aborted)return;i=i.addContext("bgIntervalProcess",e);let a=setInterval((async()=>{var e,n,s;null==(e=i.debug)||e.call(i,"Running");try{await t()}catch(e){r.aborted?null==(n=i.debug)||n.call(i,"Error running most likely due to close.",e):null==(s=i.error)||s.call(i,"Error running.",e)}}),n);null==(s=(i=i.addContext("intervalID",a)).debug)||s.call(i,"Starting"),r.addEventListener("abort",(()=>{var e;null==(e=i.debug)||e.call(i,"Stopping"),clearInterval(a)}))}var br;function Or(e,t,n,i,r){gr("Heartbeat",(async()=>{br=async function(e,t){let n=await mr((t=>{let n=t.get(e);return n?{clients:new Map(t).set(e,{heartbeatTimestampMs:Date.now(),headHash:n.headHash,mutationID:n.mutationID,lastServerAckdMutationID:n.lastServerAckdMutationID})}:fr}),t);if(void 0===n.get(e))throw new cr(e);return n}(e,t);try{return await br}catch(e){if(e instanceof cr)return void n();throw e}}),6e4,i,r)}var Dr,_r=6048e5;function kr(e,t,n,i){gr("ClientGC",(()=>(Dr=async function(e,t){return mr((t=>{let n=Date.now(),i=Array.from(t).filter((([t,i])=>t===e||n-i.heartbeatTimestampMs<=_r));return i.length===t.size?fr:{clients:new Map(i)}}),t)}(e,t),Dr)),3e5,n,i)}var Er="dbs",Ur="profileId";function xr(e){Qe(e),ze(e.name),ze(e.replicacheName),Je(e.replicacheFormatVersion),ze(e.schemaVersion),void 0!==e.lastOpenedTimestampMS&&Je(e.lastOpenedTimestampMS)}var Nr=2592e6,Cr=3e5;function Ir(e,t,n){(async function(e,t){try{await yi(Cr,t),await Mr(e,t,Date.now(),Nr)}catch(e){if(e instanceof wi)return;throw e}})(e,n),gr("CollectIDBDatabases",(async()=>{await Mr(e,n,Date.now(),Nr)}),432e5,t,n)}async function Mr(e,t,n,i,r=Sr){let s=await e.getDatabases(),a=Object.values(s),o=(await Promise.all(a.map((async e=>[e.name,await Lr(e,n,i,r)])))).filter((e=>e[1])).map((e=>e[0])),l=await Promise.allSettled(o.map((async e=>(await async function(e){await Hi(indexedDB.deleteDatabase(e))}(e),e)))),u=[],c=[];for(let e of l)"fulfilled"===e.status?u.push(e.value):c.push(e.reason);if(u.length&&!t.aborted&&await e.deleteDatabases(u),c.length)throw c[0]}function Sr(e){let t=new ji(e);return new Xi(t,Vi,Ct)}async function Lr(e,t,n,i){if(e.replicacheFormatVersion>Wr)return!1;if(void 0!==e.lastOpenedTimestampMS)return t-e.lastOpenedTimestampMS>=n;let r=i(e.name),s=await r.withRead(lr);return await r.close(),function(e,t,n){for(let i of e.values())if(t-i.heartbeatTimestampMs<n)return!1;return!0}(s,t,n)}parseInt("1.0".split(".")[1],10);function Tr(e){jr(e,"boolean")}function jr(e,t){typeof e!==t&&Rr(e,t)}function Ar(e){null===e&&Rr(e,"object"),jr(e,"object")}function Rr(e,t){throw new Error(function(e,t){let n="Invalid type: ";return n+=null==e?e:`${typeof e} \`${e}\``,n+`, expected ${t}`}(e,t))}new URL("https://replicache-license.herokuapp.com/");async function Fr(e,t,n,i,r){var s,a;r=r.addContext("licenseActive");let o=new URL("/api/1.0/license/active",t),l={licenseKey:n,profileID:i},u=JSON.stringify(l);null==(s=r.debug)||s.call(r,`Sending ${o}`,u);let c=await(await e("post",o.toString(),u,[["Content-Type","application/json"],["Accept","application/json"]])).text();null==(a=r.debug)||a.call(r,`Got ${o}`,c),function(e){Ar(e)}(JSON.parse(c))}async function Pr(e,t,n,i){var r,s;i=i.addContext("getLicenseStatus");let a=new URL("/api/1.0/license/status",t),o={licenseKey:n},l=JSON.stringify(o);null==(r=i.debug)||r.call(i,`Sending ${a}`,l);let u=await(await e("post",a.toString(),l,[["Content-Type","application/json"],["Accept","application/json"]])).text();null==(s=i.debug)||s.call(i,`Got ${a}`,u);let c=JSON.parse(u);return function(e){Ar(e),function(e){jr(e,"string")}(e.status),Tr(e.disable),Tr(e.pleaseUpdate)}(c),c}var Hr="This key only good for automated testing",$r=new URL("https://replicache-license.herokuapp.com/");new URL("https://replicache-license-staging.herokuapp.com/");async function Gr(e,t,n,i){let r=await async function(e,t,n,i){return fetch(t,{method:e,body:n,headers:i})}(e,t,n,i);if(200!==r.status)throw new Error(`Got ${r.status} fetching ${t}: ${await r.text()}`);return r}var Wr=4;function qr(e,t){let n=`rep:${e}:${Wr}`;return t?`${n}:${t}`:n}var Vr=()=>{},Br={type:"NotFoundOnServer"},Kr={type:"NotFoundOnClient"},zr=class{constructor(e){this.t=!1,this.me=!0,this.Z=Promise.resolve(void 0),this.tt=new Map,this.nt=0,this.rt=0,this.J=new class{constructor(e=(e=>new ji(e))){this.H=e("replicache-dbs-v0")}putDatabase(e){return this.Qe(a(a({},e),{},{lastOpenedTimestampMS:Date.now()}))}putDatabaseForTesting(e){return this.Qe(e)}Qe(e){return this.H.withWrite((async t=>{let n=a(a({},await this.pe(t)),{},{[e.name]:e});return await t.put(Er,n),await t.commit(),n}))}clearDatabases(){return this.H.withWrite((async e=>{await e.del(Er),await e.commit()}))}deleteDatabases(e){return this.H.withWrite((async t=>{let n=a({},await this.pe(t));for(let t of e)delete n[t];await t.put(Er,n),await t.commit()}))}getDatabases(){return this.H.withRead((e=>this.pe(e)))}close(){return this.H.close()}async pe(e){let t=await e.get(Er);return t||(t={}),function(e){Qe(e);for(let[t,n]of Object.entries(e))ze(t),xr(n),Ke(t===n.name)}(t),t}async getProfileID(){return this.H.withWrite((async e=>{let t=await e.get(Ur);return void 0===t&&(t=`p${zn().replace(/-/g,"")}`,await e.put(Ur,t),await e.commit()),ze(t),t}))}},this.at=new AbortController,this.ot=new qe,this.ge=!1,this.we=!1,this.onSync=null,this.onClientStateNotFound=Qr,this.getAuth=null,this.ut=async()=>{var e;this.t||"visible"===(null==(e=Yr())?void 0:e.visibilityState)&&await this.lt()},this.onOnlineChange=null,this.L=async e=>{await this.l;let t=await this.c;return this.h.withRead((async n=>{let i=await An(n),r=new ui(t,i,this.e);try{return await e(r)}catch(e){throw await this.yt(e)}}))};let{name:t,logLevel:n="info",logSinks:i=[$e],pullURL:r="",auth:s,pushDelay:l=10,pushURL:u="",schemaVersion:c="",pullInterval:h=6e4,mutators:d={},requestOptions:f={},puller:m=ft,pusher:p=ut,licenseKey:w,experimentalKVStore:y}=e;if(this.auth=null!=s?s:"",this.pullURL=r,this.pushURL=u,void 0===t||""===t)throw new Error("name is required and must be non-empty");this.name=t,this.schemaVersion=c,this.pullInterval=h,this.pushDelay=l,this.puller=m,this.pusher=p;let v=e,{enableLicensing:g=!0,enableMutationRecovery:b=!0}=v;this.xe=g,this.it=b,v.exposeInternalAPI&&v.exposeInternalAPI({persist:()=>this.dt()});let O=1===i.length?i[0]:new class{constructor(e){this.ve=e}log(e,...t){for(let n of this.ve)n.log(e,...t)}async flush(){await Promise.all(this.ve.map((e=>{var t;return null==(t=e.flush)?void 0:t.call(e)})))}}(i);this.e=new Ge(n,O).addContext("name",t),this.d=new class{constructor(e,t){this.d=new Set,this.ue=new Set,this.hasPendingSubscriptionRuns=!1,this.L=e,this.e=t}je(e){return this.d.add(e),this.Ft(e),()=>this.d.delete(e)}addSubscription(e,{onData:t,onError:n,onDone:i}){let r=new class{constructor(e,t,n,i){this.We=!0,this.Ue=void 0,this.D=xi,this.k=[],this.Be=e,this.Je=t,this.onError=n,this.onDone=i}invoke(e,t,n){return this.Be(e)}matches(e){for(let[t,n]of e)if(Ni(this.D,this.k,t,n))return!0;return!1}updateDeps(e,t){this.D=e,this.k=t}onData(e){(this.We||!it(e,this.Ue))&&(this.Ue=e,this.We=!1,this.Je(e))}}(e,t,n,i);return this.je(r)}addWatch(e,t){let n=new class{constructor(e,t){var n,i;this.onError=void 0,this.onDone=void 0,this.Ke=e,this.P=null!=(n=t.prefix)?n:"",this.qe=null!=(i=t.initialValuesInFirstDiff)&&i}onData(e){void 0!==e&&this.Ke(e)}async invoke(e,t,n){let i;if(0===t){if(!this.qe)return;Ke(void 0===n);let t=[];var r,s=!1,a=!1;try{for(var l,u=o(e.scan({prefix:this.P}).entries());s=!(l=await u.next()).done;s=!1){let e=l.value;t.push({op:"add",key:e[0],newValue:e[1]})}}catch(e){a=!0,r=e}finally{try{s&&null!=u.return&&await u.return()}finally{if(a)throw r}}i=t}else{Ke(n);let e=n.get("");if(void 0===e)return[];i=e}if(""===this.P)return i;let c=[],{length:h}=i,d=this.P,f=e=>d<=i[e].key;for(let e=Mt(h,f);e<h&&i[e].key.startsWith(this.P);e++)c.push(i[e]);return c.length>0?c:void 0}matches(e){let t=e.get("");return void 0!==t&&function(e,t){if(""===t)return!0;let n=Mt(e.length,(n=>t<=e[n].key));return n<e.length&&e[n].key.startsWith(t)}(t,this.P)}updateDeps(e,t){}}(e,null!=t?t:{});return this.je(n)}clear(){var e;for(let t of this.d)null==(e=t.onDone)||e.call(t);this.d.clear()}async fire(e){let t=function*(e,t){for(let n of e)n.matches(t)&&(yield n)}(this.d,e);await this.$e(t,1,e)}async $e(e,t,n){var i,r;let s=[...e];if(0===s.length)return;let a=await this.L((e=>Promise.allSettled(s.map((async i=>{let r=new class{constructor(e){this.D=new Set,this.k=[],this.n=e}get clientID(){return this.n.clientID}isEmpty(){return this.k.push({options:{}}),this.n.isEmpty()}get(e){return this.D.add(e),this.n.get(e)}has(e){return this.D.add(e),this.n.has(e)}scan(e){let t={options:vt(e),inclusiveLimitKey:void 0};return this.k.push(t),hi(e,this.n.dbtx,(e=>{t.inclusiveLimitKey=e}))}get keys(){return this.D}get scans(){return this.k}}(e);try{return await i.invoke(r,t,n)}finally{i.updateDeps(r.keys,r.scans)}})))));for(let e=0;e<s.length;e++){let t=s[e],n=a[e];"fulfilled"===n.status?t.onData(n.value):t.onError?t.onError(n.reason):null==(r=(i=this.e).error)||r.call(i,n.reason)}}async Ft(e){if(this.ue.add(e),!this.hasPendingSubscriptionRuns){this.hasPendingSubscriptionRuns=!0,await Promise.resolve(),this.hasPendingSubscriptionRuns=!1;let e=[...this.ue];this.ue.clear(),await this.$e(e,0,void 0)}}}(this.L,this.e);let D=y||new ji(this.idbName);this.b=new Xi(D,Vi,Ct),this.h=new nr(this.b,104857600,this.jt(),It);let _=We();this.l=_.promise,this.x=w;let k=We();this.Kt=k.promise;let E=We();this.qt=E.promise;let{minDelayMs:U=vi,maxDelayMs:x=gi}=f;this.st={maxDelayMs:x,minDelayMs:U},this.ye=new bi(new Ei(this,(()=>this.$t()),this.e.addContext("PULL"))),this.X=new bi(new Ui(this,(()=>this.Gt()),this.e.addContext("PUSH"))),this.mutate=this.zt(d);let N=We();this.fe=N.promise;let C=We();this.c=C.promise,this.Yt(N.resolve,C.resolve,_.resolve,k.resolve,E.resolve)}get idbName(){return qr(this.name,this.schemaVersion)}get et(){return{name:this.idbName,replicacheName:this.name,replicacheFormatVersion:Wr,schemaVersion:this.schemaVersion}}get requestOptions(){return this.st}jt(){return xt}async Yt(e,t,n,i,r){var s;await Jr.get(this.name),await this.J.getProfileID().then(e),await this.J.putDatabase(this.et);let[a,o,l]=await async function(e){let t=zn(),n=await mr((async n=>{let i;for(let e of n.values())(!i||i.heartbeatTimestampMs<e.heartbeatTimestampMs)&&(i=e);let r,s=[];if(i){let t=i;r=await e.withRead((async e=>{let n=await En(t.headHash,e);return Cn(n.meta.basisHash,0,n.meta.cookieJSON,n.valueHash,n.indexes)}))}else{let e=await qi(Vt,[]);s.push(e),r=Cn(null,0,null,e.hash,[])}let a=await qi(r,Mn(r));return s.push(a),{clients:new Map(n).set(t,{heartbeatTimestampMs:Date.now(),headHash:a.hash,mutationID:0,lastServerAckdMutationID:0}),chunksToPut:s}}),e),i=n.get(t);return et(i),[t,i,n]}(this.b);t(a),await this.h.withWrite((async e=>{await e.setHead(Dn,o.headHash),await e.commit()})),n(),this.Z=this.Zt(),await this.Z,await this.Xt(i),this.pull(),this.Qt();let{signal:u}=this.at;Or(a,this.b,(()=>{this.W(a,Kr)}),this.e,u),kr(a,this.b,this.e,u),Ir(this.J,this.e,u),function(e,t,n){let i=setInterval(e,t);n.addEventListener("abort",(()=>{clearInterval(i)}))}((()=>this.be()),3e5,u),this.be(l),null==(s=Yr())||s.addEventListener("visibilitychange",this.ut),await this.en(r,this.e,u)}async lt(){let e=await this.c,t=await this.b.withRead((t=>hr(e,t)));return t||this.W(e,Kr),!t}async Xt(e){var t,n,i,r,s,a,o,l,u,c;if(this.xe)if(this.x){if(null==(n=(t=this.e).info)||n.call(t,`Replicache license key: ${this.x}`),this.x===Hr)return null==(r=(i=this.e).info)||r.call(i,"Skipping license check for TEST_LICENSE_KEY. You may ONLY use this key for automated (e.g., unit/CI) testing. See https://replicache.dev for more information."),void e(!0);try{let t=await Pr(Gr,$r,this.x,this.e);if(t.pleaseUpdate&&(null==(a=(s=this.e).error)||a.call(s,"You are using an old version of Replicache that uses deprecated licensing features. Please update Replicache else it may stop working.")),"VALID"!==t.status)return void await this.ct(this.e,`status: ${t.status}`,t.disable,e);null==(l=(o=this.e).info)||l.call(o,"License is valid.")}catch(e){null==(c=(u=this.e).error)||c.call(u,`Error checking license: ${e}`)}e(!0)}else await this.ct(this.e,"license key ReplicacheOptions.licenseKey is not set",!0,e);else e(!0)}async ct(e,t,n,i){var r,s;null==(r=e.error)||r.call(e,`** REPLICACHE LICENSE NOT VALID ** Replicache license key '${this.x}' is not valid (${t}). Please run 'npx replicache get-license' to get a license key or contact hello@replicache.dev for help.`),n&&(await this.close(),null==(s=e.error)||s.call(e,"** REPLICACHE DISABLED **")),i(!1)}async en(e,t,n){if(!this.xe||!this.x||this.x===Hr)return void e(!1);let i=async()=>{var e,n;try{await Fr(Gr,$r,this.x,await this.profileID,t)}catch(t){null==(n=(e=this.e).info)||n.call(e,`Error sending license active ping: ${t}`)}};await i(),e(!0),gr("LicenseActive",i,864e5,t,n)}get profileID(){return this.fe}get clientID(){return this.c}get online(){return this.me}get closed(){return this.t}async close(){var e;this.t=!0;let{promise:t,resolve:n}=We();Jr.set(this.name,t),this.at.abort(),null==(e=Yr())||e.removeEventListener("visibilitychange",this.ut),await this.l;let i=[this.h.close(),this.b.close(),this.J.close()];this.ye.close(),this.X.close(),this.d.clear(),await Promise.all(i),Jr.delete(this.name),n()}async Zt(){if(!this.t)return await this.l,await function(e,t){return e.withRead((async e=>{let n=await e.getHead(t);if(void 0===n)throw new Error(`No head found for ${t}`);return n}))}(this.h,Dn)}async Re(e,t){let n=await this.Z;void 0!==e&&e!==n&&(this.Z=Promise.resolve(e),await this.d.fire(t))}async createIndex(e){await this.ht((t=>t.createIndex(e)))}async dropIndex(e){await this.ht((t=>t.dropIndex(e)))}async ht(e){await this.l;let t=await this.c;await this.h.withWrite((async n=>{let i=await $n.newIndexChange(Tn(Dn),n),r=new fi(t,i,this.e);await e(r);let[s,a]=await r.commit(!0);Ke(!a.has("")),await this.Re(s,a)}))}async Se(e){if(this.t)return;let{syncHead:t}=e,{requestID:n}=e;await this.l;let i=this.e.addContext("maybeEndPull").addContext("request_id",n),{replayMutations:r,diffs:s}=await ni(this.h,i,t);if(!r||0===r.length)return await this.Re(t,s),void this.pt();for(let e of r)t=await this.tn(t,e.original,e.name,e.args,e.timestamp);await this.Se(a(a({},e),{},{syncHead:t}))}async tn(e,t,n,i,r){var s,a;let o=this.tt.get(n);return o||(null==(a=(s=this.e).error)||a.call(s,`Unknown mutator ${n}`),o=async()=>{}),(await this.mt(n,o,i,r,{basis:e,original:t},!0)).ref}async $t(){return!!this.ft()||this.ot.withLock((()=>this.Q((async()=>{try{this.A(0,1);let e=await this.nn();if(!e.ok)return!1;e.syncHead!==Ut&&await this.Se(e)}finally{this.A(0,-1)}return!0}),"Pull")))}ft(){return""===this.pullURL&&this.puller===ft}async Q(e,t){var n,i,r,s,a;let o=!0;try{return await e()}catch(e){return e instanceof ct||e instanceof pt?(o=!1,null==(i=(n=this.e).info)||i.call(n,`${t} threw:\n`,e,"\nwith cause:\n",e.causedBy)):null==(s=(r=this.e).info)||s.call(r,`${t} threw:\n`,e),!1}finally{this.me!==o&&(this.me=o,null==(a=this.onOnlineChange)||a.call(this,o),o&&this.be())}}async ee(e,t,n,i=Vr,r=Vr){var s,a,o,l;let u,c=0;do{let{httpRequestInfo:o,result:l}=await e();if(u=l,!o)return{result:l,authFailure:!1};let h,{errorMessage:d,httpStatusCode:f}=o;if((d||f>=400)&&(null==(a=(s=this.e).error)||a.call(s,`Got error response from server (${n}) doing ${t}: ${f}`+(d?`: ${d}`:""))),401!==f)return{result:l,authFailure:!1};if(!this.getAuth)return{result:l,authFailure:!0};try{await i(),h=await this.getAuth()}finally{await r()}if(null==h)return{result:l,authFailure:!0};this.auth=h,c++}while(c<8);return null==(l=(o=this.e).info)||l.call(o,"Tried to reauthenticate too many times"),{result:u,authFailure:!0}}Ie(){return""===this.pushURL&&this.pusher===ut}async Gt(){return!!this.Ie()||this.Q((async()=>{let{result:e}=await this.ee((async()=>{await this.l;let e=await this.fe,t=await this.c,n=oi(t),i=this.e.addContext("push").addContext("request_id",n);try{this.A(1,0);let r=await ri(n,this.h,i,e,t,this.pusher,this.pushURL,this.auth,this.schemaVersion);return{result:r,httpRequestInfo:r}}finally{this.A(-1,0)}}),"push",this.pushURL);return void 0===e||200===e.httpStatusCode}),"Push")}Qt(){this.X.send()}pull(){this.ye.send()}async poke(e){await this.l;let t=await this.c,n=oi(t),i=this.e.addContext("handlePullResponse").addContext("request_id",n);if(ht(e.pullResponse))return void this.W(t,Br);let r=await ti(i,this.h,e.baseCookie,e.pullResponse);if(null===r)throw new Error("unexpected base cookie for poke: "+JSON.stringify(e));await this.Se({requestID:n,syncHead:r,ok:!0})}async nn(){let{result:{beginPullResponse:e,requestID:t}}=await this.ee((async()=>{await this.l;let e=await this.profileID,t=await this.c,n=oi(t),i=this.e.addContext("beginPull").addContext("request_id",n),r={pullAuth:this.auth,pullURL:this.pullURL,schemaVersion:this.schemaVersion,puller:this.puller},s=await ei(e,t,r,r.puller,n,this.h,i);return{result:{beginPullResponse:s,requestID:n},httpRequestInfo:s.httpRequestInfo}}),"pull",this.pullURL,(()=>this.A(0,-1)),(()=>this.A(0,1)));if(ht(e.pullResponse)){let e=await this.c;this.W(e,Br)}let{syncHead:n,httpRequestInfo:i}=e;return{requestID:t,syncHead:n,ok:200===i.httpStatusCode}}async dt(){var e,t;if(this.t)return;await this.l;let n=await this.clientID;try{await this.ot.withLock((()=>vr(n,this.h,this.b,(()=>this.closed))))}catch(i){if(i instanceof cr)this.W(n,Kr);else{if(!this.t)throw i;null==(t=(e=this.e).debug)||t.call(e,"Exception persisting during close",i)}}}W(e,t){var n,i,r;null==(i=(n=this.e).error)||i.call(n,`Client state not found, clientID: ${e}`),null==(r=this.onClientStateNotFound)||r.call(this,t)}pt(){this.ge||(this.ge=!0,(async()=>{await function(e){return new Promise((t=>{"function"==typeof requestIdleCallback?requestIdleCallback((()=>t()),{timeout:e}):setTimeout((()=>t()),e)}))}(1e3),await this.dt(),this.ge=!1})())}A(e,t){this.nt+=e,this.rt+=t;let n=e+t,i=this.nt+this.rt;if(1===n&&1===i||0===i){let e=i>0;Promise.resolve().then((()=>{var t;return null==(t=this.onSync)?void 0:t.call(this,e)}))}}subscribe(e,t){return this.d.addSubscription(e,t)}experimentalWatch(e,t){return this.d.addWatch(e,t)}async query(e){return this.L(e)}rn(e,t){return this.tt.set(e,t),async n=>(await this.mt(e,t,n,performance.now(),void 0,!1)).result}zt(e){let t=Object.create(null);for(let n in e)t[n]=this.rn(n,e[n]);return t}async mt(e,t,n,i,r,s){this.d.hasPendingSubscriptionRuns&&await Promise.resolve(),await this.l;let a=await this.c;return await this.h.withWrite((async o=>{let l,u=null;void 0===r?l=Tn(Dn):(await async function(e,t,n,i){let r=await t.getHead(Zn);if(r!==e.basis)throw new Error(`WrongSyncHeadJSLogInfo: sync head is ${r}, transaction basis is ${e.basis}`);let[,s]=await Rn(jn(e.original),t);if(!s.isLocal())throw new Error("Internal programmer error: Commit is not a local commit");{let e=s.meta;if(e.mutatorName!==n)throw new Error(`Inconsistent mutator: original: ${e.mutatorName}, request: ${n}`)}let[,a]=await Rn(jn(e.basis),t);if(a.nextMutationID!==s.mutationID)throw new Error(`Inconsistent mutation ID: original: ${s.mutationID}, next: ${a.nextMutationID}`)}(r,o,e),l=jn(r.basis),u=r.original);let c=await $n.newLocal(l,e,rt(null!=n?n:null),u,o,i),h=new di(a,c,this.e);try{let e=await t(h,n),[i,r]=await h.commit(!s);return s||(this.X.send(),await this.Re(i,r),this.pt()),{result:e,ref:i}}catch(e){throw await this.yt(e)}}))}async yt(e){return e instanceof qn&&await this.lt()?new cr(await this.c):e}async be(e){var t,n,i,r,s,a;if(!this.it||this.we||!this.online||this.closed||this.Ie())return!1;let o="Recovering mutations.";null==(n=(t=this.e).debug)||n.call(t,"Start:",o);try{this.we=!0,await this.l,await this.gt(this.et,this.b,e);for(let e of Object.values(await this.J.getDatabases())){if(this.closed)return null==(r=(i=this.e).debug)||r.call(i,"Exiting early due to close:",o),!0;e.name===this.idbName||e.replicacheName!==this.name||e.replicacheFormatVersion!==Wr||await this.gt(e)}}catch(e){this.Ce(e,o)}finally{null==(a=(s=this.e).debug)||a.call(s,"End:",o),this.we=!1}return!0}async gt(e,t,n){var i,r,s,a,o,l;let u,c=`Recovering mutations from db ${e.name}.`;null==(r=(i=this.e).debug)||r.call(i,"Start:",c);try{if(!t){let n=new ji(e.name);t=u=new Xi(n,Vi,Ct)}let i=n||await t.withRead((e=>lr(e))),r=new Set;for(;i;){let n;for(let[o,l]of i){if(this.closed)return void(null==(a=(s=this.e).debug)||a.call(s,"Exiting early due to close:",c));if(!r.has(o)&&(r.add(o),n=await this.sn(l,o,t,e),n))break}i=n}}catch(e){this.Ce(e,c)}finally{var h;await(null===(h=u)||void 0===h?void 0:h.close()),null==(l=(o=this.e).debug)||l.call(o,"End:",c)}}async sn(e,t,n,i){var r,s,o,l,u,c,h,d,f,m,p,w,y,v,g,b;let O=await this.c;if(O===t||e.lastServerAckdMutationID>=e.mutationID)return;let D,_=`Recovering mutations for ${t}.`;null==(s=(r=this.e).debug)||s.call(r,"Start:",_);try{var k;let r=D=new nr(n,10485760,Vi,It);if(await r.withWrite((async t=>{await t.setHead(Dn,e.headHash),await t.commit()})),this.Ie())return void(null==(l=(o=this.e).debug)||l.call(o,`Cannot recover mutations for client ${t} because push is disabled.`));let{pusher:s,pushURL:U}=this,x=oi(t),N="recoveringMutationsPush",C=this.e.addContext(N).addContext("request_id",x);if(!await this.Q((async()=>{let{result:e}=await this.ee((async()=>{et(r);let e=await ri(x,r,C,await this.profileID,t,s,U,this.auth,i.schemaVersion);return{result:e,httpRequestInfo:e}}),N,this.pushURL);return!!e&&200===e.httpStatusCode}),N))return void(null==(c=(u=this.e).debug)||c.call(u,`Failed to recover mutations for client ${t} due to a push error.`));if(this.ft())return void(null==(d=(h=this.e).debug)||d.call(h,`Cannot confirm mutations were recovered for client ${t} because pull is disabled.`));let I,{puller:M,pullURL:S}=this,L=oi(t),T="recoveringMutationsPull",j=this.e.addContext(T).addContext("request_id",L);return await this.Q((async()=>{let{result:e}=await this.ee((async()=>{let e={pullAuth:this.auth,pullURL:S,schemaVersion:i.schemaVersion,puller:M},n=await ei(await this.profileID,t,e,e.puller,L,r,j,!1);return{result:n,httpRequestInfo:n.httpRequestInfo}}),T,this.pullURL);return I=e.pullResponse,!!I&&200===e.httpRequestInfo.httpStatusCode}),T)?(I&&ht(I)?null==(w=(p=this.e).debug)||w.call(p,`Client ${O} cannot recover mutations for client ${t}. The client no longer exists on the server.`):null==(v=(y=this.e).debug)||v.call(y,`Client ${O} recovered mutations for client ${t}.  Details`,{mutationID:e.mutationID,lastServerAckdMutationID:e.lastServerAckdMutationID,lastMutationID:null===(k=I)||void 0===k?void 0:k.lastMutationID}),await mr((e=>{et(I);let n=e.get(t);if(!n)return fr;if(ht(I)){let n=new Map(e);return n.delete(t),{clients:n}}return n.lastServerAckdMutationID>=I.lastMutationID?fr:{clients:new Map(e).set(t,a(a({},n),{},{lastServerAckdMutationID:I.lastMutationID}))}}),n)):void(null==(m=(f=this.e).debug)||m.call(f,`Failed to recover mutations for client ${t} due to a pull error.`))}catch(e){return void this.Ce(e,_)}finally{var E;await(null===(E=D)||void 0===E?void 0:E.close()),null==(b=(g=this.e).debug)||b.call(g,"End:",_)}}Ce(e,t){var n,i,r,s;this.closed?null==(i=(n=this.e).debug)||i.call(n,`Mutation recovery error likely due to close during:\n${t}\nError:\n`,e):null==(s=(r=this.e).error)||s.call(r,`Mutation recovery error during:\n${t}\nError:\n`,e)}},Jr=new Map;function Yr(){return typeof document<"u"?document:void 0}function Qr(){typeof location<"u"&&location.reload()}function Zr(e){var t;return(null==(t=e[Symbol.asyncIterator])?void 0:t.call(e))||e[Symbol.iterator]()}function Xr(e,t,n){return es.apply(this,arguments)}function es(){return es=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t,n){let i=Zr(e),r=Zr(t),s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(i.next()),a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(r.next());for(;;){if(s.done){if(a.done)return;yield a.value,a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(r.next());continue}if(a.done){yield s.value,s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(i.next());continue}let e=n(s.value,a.value);0===e?(yield a.value,s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(i.next()),a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(r.next())):e<0?(yield s.value,s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(i.next())):(yield a.value,a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(r.next()))}})),es.apply(this,arguments)}function ts(e,t){return ns.apply(this,arguments)}function ns(){return ns=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t){var n,i=!1,r=!1;try{for(var s,a=o(e);i=!(s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(a.next())).done;i=!1){let e=s.value;t(e)&&(yield e)}}catch(e){r=!0,n=e}finally{try{i&&null!=a.return&&(yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(a.return()))}finally{if(r)throw n}}})),ns.apply(this,arguments)}}],t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,n),s.exports}n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{n.r(i),n.d(i,{default:()=>t,RoomDO:()=>r,AuthDO:()=>s});var e=n(1);Object(function(){var e=new Error("Cannot find module '../src/datamodel/mutators.js'");throw e.code="MODULE_NOT_FOUND",e}());const{worker:t,RoomDO:r,AuthDO:s}=(0,e.createReflectServer)({mutators:Object(function(){var e=new Error("Cannot find module '../src/datamodel/mutators.js'");throw e.code="MODULE_NOT_FOUND",e}()),authHandler:async(e,t)=>{const n=JSON.parse(e);if(!n)throw Error("Empty auth");if(n.roomID!==t)throw new Error("incorrect roomID");if(!n.userID||"string"!=typeof n.userID)throw new Error("Missing userID");return{userID:n.userID}},getLogSinks:function(){return[e.consoleLogSink]},getLogLevel:()=>"info"})})()})();