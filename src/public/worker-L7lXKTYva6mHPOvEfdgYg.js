/*! For license information please see worker-L7lXKTYva6mHPOvEfdgYg.js.LICENSE.txt */
(()=>{"use strict";var e=[,(e,t,n)=>{let r;n.r(t),n.d(t,{DatadogLogSink:()=>Fe,Replicache:()=>Ki,TEST_LICENSE_KEY:()=>Hi,TeeLogSink:()=>u,TransactionClosedError:()=>gt,consoleLogSink:()=>c,createReflectServer:()=>Re,filterAsyncIterable:()=>ta,isScanIndexOptions:()=>yt,makeIDBName:()=>Gi,makeScanResult:()=>bn,mergeAsyncIterables:()=>Xi,version:()=>f}),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}()),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/objectWithoutProperties'");throw e.code="MODULE_NOT_FOUND",e}()),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}()),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}());const i=["message"];function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e){var t,n,r,i=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,r=Symbol.iterator);i--;){if(n&&null!=(t=e[n]))return t.call(e);if(r&&null!=(t=e[r]))return new l(t.call(e));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function l(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return l=function(e){this.s=e,this.n=e.next},l.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new l(e)}var u=class{constructor(e){this._sinks=e}log(e,...t){for(let n of this._sinks)n.log(e,...t)}async flush(){await Promise.all(this._sinks.map((e=>{var t;return null===(t=e.flush)||void 0===t?void 0:t.call(e)})))}},c={log(e,...t){console[e](...t)}},d=class extends class{constructor(e,t="info"){this.debug=void 0,this.info=void 0,this.error=void 0;let n=t=>(...n)=>e.log(t,...n);switch(t){case"debug":this.debug=n("debug");case"info":this.info=n("info");case"error":this.error=n("error")}}}{constructor(e="info",t=c){super(t,e),this._level=e,this._logSink=t}addContext(e,t){let n=void 0===t?e:`${e}=${t}`,r={log:(e,...t)=>{this._logSink.log(e,n,...t)}};return new d(this._level,r)}};function h(){return Math.random().toString(36).substring(2)}var p={name:"@rocicorp/reflect-server",description:"Multiplayer server for Replicache",version:"0.11.0",repository:"github:rocicorp/reflect-server",license:"SEE LICENSE IN https://roci.dev/terms.html",main:"out/reflect-server.js",module:"out/reflect-server.js",types:"out/reflect-server.d.ts",type:"module",scripts:{format:"prettier --write 'src/**/*.{js,jsx,json,ts,tsx,html,css,md}' '*.{cjs,js,jsx,json,ts,tsx,html,css,md}'","check-format":"prettier --check '**/*.{js,jsx,json,ts,tsx,html,css,md}' '*.{cjs,js,jsx,json,ts,tsx,html,css,md}'",lint:"eslint --ext .ts,.tsx,.js,.jsx src/",build:"rm -rf out && npm run build-dts && node build.js","build-dts":"rm -rf out/.dts/ && tsc --emitDeclarationOnly --outDir out/.dts/ && rollup --config rollup.config.js && rm -rf out/.dts",dev:"miniflare --live-reload --debug",test:"npm run build && node --experimental-vm-modules node_modules/jest/bin/jest.js","types:check":"tsc --noEmit",prepack:"npm run lint && npm run test && npm run build"},engines:{node:">=16.14.0 || >=17.1"},devDependencies:{"@cloudflare/workers-types":"^3.8.0","@rocicorp/lock":"^1.0.1","@rocicorp/logger":"^2.2.0","@types/jest":"^27.5.0","@typescript-eslint/eslint-plugin":"^5.22.0","@typescript-eslint/parser":"^5.22.0",esbuild:"^0.14.38",eslint:"^8.14.0",jest:"^28.0.3","jest-environment-miniflare":"^2.4.0",miniflare:"^2.4.0",prettier:"^2.6.2",replicache:"^10.0.0",rollup:"^2.71.1","rollup-plugin-dts":"^4.2.1",superstruct:"^0.15.4","ts-jest":"^28.0.1",typescript:"^4.6.4"},files:["out/reflect-server.d.ts","out/reflect-server.js"]},{version:f}=p,m="x-reflect-user-data",y=class extends TypeError{constructor(e,t){let n,{message:r}=e,a=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/objectWithoutProperties'");throw e.code="MODULE_NOT_FOUND",e}())(e,i),{path:s}=e;super(0===s.length?r:"At path: "+s.join(".")+" -- "+r),this.value=void 0,this.key=void 0,this.type=void 0,this.refinement=void 0,this.path=void 0,this.branch=void 0,this.failures=void 0,Object.assign(this,a),this.name=this.constructor.name,this.failures=()=>{var r;return null!=(r=n)?r:n=[e,...t()]}}};function v(e){return"object"==typeof e&&null!=e}function w(e){return"string"==typeof e?JSON.stringify(e):""+e}function g(e,t,n,r){if(!0===e)return;!1===e?e={}:"string"==typeof e&&(e={message:e});let{path:i,branch:a}=t,{type:o}=n,{refinement:l,message:u="Expected a value of type `"+o+"`"+(l?" with refinement `"+l+"`":"")+", but received: `"+w(r)+"`"}=e;return s(s({value:r,type:o,refinement:l,key:i[i.length-1],path:i,branch:a},e),{},{message:u})}function*b(e,t,n,r){(function(e){return v(e)&&"function"==typeof e[Symbol.iterator]})(e)||(e=[e]);for(let i of e){let e=g(i,t,n,r);e&&(yield e)}}function*_(e,t,n={}){let{path:r=[],branch:i=[e],coerce:a=!1,mask:s=!1}=n,o={path:r,branch:i};if(a&&(e=t.coercer(e,o),s&&"type"!==t.type&&v(t.schema)&&v(e)&&!Array.isArray(e)))for(let n in e)void 0===t.schema[n]&&delete e[n];let l=!0;for(let n of t.validator(e,o))l=!1,yield[n,void 0];for(let[n,u,c]of t.entries(e,o)){let t=_(u,c,{path:void 0===n?r:[...r,n],branch:void 0===n?i:[...i,u],coerce:a,mask:s});for(let r of t)r[0]?(l=!1,yield[r[0],void 0]):a&&(u=r[1],void 0===n?e=u:e instanceof Map?e.set(n,u):e instanceof Set?e.add(u):v(e)&&(e[n]=u))}if(l)for(let n of t.refiner(e,o))l=!1,yield[n,void 0];l&&(yield[void 0,e])}var O=class{constructor(e){this.TYPE=void 0,this.type=void 0,this.schema=void 0,this.coercer=void 0,this.validator=void 0,this.refiner=void 0,this.entries=void 0;let{type:t,schema:n,validator:r,refiner:i,coercer:a=(e=>e),entries:s=function*(){}}=e;this.type=t,this.schema=n,this.entries=s,this.coercer=a,this.validator=r?(e,t)=>b(r(e,t),t,this,e):()=>[],this.refiner=i?(e,t)=>b(i(e,t),t,this,e):()=>[]}assert(e){return k(e,this)}create(e){return function(e,t){let n=D(e,t,{coerce:!0});if(n[0])throw n[0];return n[1]}(e,this)}is(e){return function(e,t){return!D(e,t)[0]}(e,this)}mask(e){return function(e,t){let n=D(e,t,{coerce:!0,mask:!0});if(n[0])throw n[0];return n[1]}(e,this)}validate(e,t={}){return D(e,this,t)}};function k(e,t){let n=D(e,t);if(n[0])throw n[0]}function D(e,t,n={}){let r=_(e,t,n),i=function(e){let{done:t,value:n}=e.next();return t?void 0:n}(r);if(i[0])return[new y(i[0],(function*(){for(let e of r)e[0]&&(yield e[0])})),void 0];return[void 0,i[1]]}function x(e,t){return new O({type:e,schema:null,validator:t})}function I(e){return new O({type:"array",schema:e,*entries(t){if(e&&Array.isArray(t))for(let[n,r]of t.entries())yield[n,r,e]},coercer:e=>Array.isArray(e)?e.slice():e,validator:e=>Array.isArray(e)||"Expected an array value, but received: "+w(e)})}function E(){return x("boolean",(e=>"boolean"==typeof e))}function U(e){let t=w(e),n=typeof e;return new O({type:"literal",schema:"string"===n||"number"===n||"boolean"===n?e:null,validator:n=>n===e||"Expected the literal `"+t+"`, but received: "+w(n)})}function N(){return x("number",(e=>"number"==typeof e&&!isNaN(e)||"Expected a number, but received: "+w(e)))}function C(){return x("string",(e=>"string"==typeof e||"Expected a string, but received: "+w(e)))}function S(e){let t=x("never",(()=>!1));return new O({type:"tuple",schema:null,*entries(n){if(Array.isArray(n)){let r=Math.max(e.length,n.length);for(let i=0;i<r;i++)yield[i,n[i],e[i]||t]}},validator:e=>Array.isArray(e)||"Expected an array, but received: "+w(e)})}function j(e){let t=Object.keys(e);return new O({type:"type",schema:e,*entries(n){if(v(n))for(let r of t)yield[r,n[r],e[r]]},validator:e=>v(e)||"Expected an object, but received: "+w(e)})}function M(e){let t=e.map((e=>e.type)).join(" | ");return new O({type:"union",schema:null,coercer:(t,n)=>(e.find((e=>{let[n]=e.validate(t,{coerce:!0});return!n}))||x("unknown",(()=>!0))).coercer(t,n),validator(n,r){let i=[];for(let t of e){let[...e]=_(n,t,r),[a]=e;if(!a[0])return[];for(let[t]of e)t&&i.push(t)}return["Expected the value to satisfy a union of `"+t+"`, but received: "+w(n),...i]}})}var T=j({userID:C()}),P=j({roomID:C()}),A=I(j({userID:C(),clientID:C()})),L="/connect",R="/api/auth/v0/invalidateForUser",F="/api/auth/v0/invalidateForRoom",H="/api/auth/v0/invalidateAll",Z="/api/auth/v0/revalidateConnections",$="/api/auth/v0/connections";function z(e="Bad Request"){return new Response(e,{status:400})}function G(e,t,n,r){var i;let a=new URL(e.url);async function s(i,a,s,o){var l,u;if(!s)return z("Unsupported path.");if("authApiKey"===o&&(void 0===n||e.headers.get("x-reflect-auth-api-key")!==n))return function(e="Unauthorized"){return new Response(e,{status:401})}();if(e.method.toLowerCase()!==i.toLowerCase())return null!==(l=t.debug)&&void 0!==l&&l.call(t,`Unsupported method ${e.method.toLowerCase()}`),Promise.resolve(new Response(`Method not allowed. Use "${i}".`,{status:405}));let c=await a(e);return c.errorResponse?c.errorResponse:(null!==(u=t.debug)&&void 0!==u&&u.call(t,"Calling handler"),s.call(r,t,e,c.value))}switch(null===(i=t.debug)||void 0===i||i.call(t,"Dispatching path",a.pathname),a.pathname){case L:return s("get",q,r.connect);case R:return s("post",(e=>V(e,T)),r.authInvalidateForUser,"authApiKey");case F:return s("post",(e=>V(e,P)),r.authInvalidateForRoom,"authApiKey");case H:return s("post",q,r.authInvalidateAll,"authApiKey");case Z:return s("post",q,r.authRevalidateConnections,"authApiKey");case $:return s("get",q,r.authConnections,"authApiKey");default:return Promise.resolve(z("Unsupported path."))}}var q=()=>Promise.resolve({value:void 0,errorResponse:void 0});async function V(e,t){let n;try{n=await e.clone().json()}catch(e){return{errorResponse:new Response("Body must be valid json.",{status:400}),value:void 0}}let r=D(n,t);return r[0]?{errorResponse:z("Body schema error. "+r[0].message),value:void 0}:{value:r[1],errorResponse:void 0}}function W(){let e,t;return{promise:new Promise(((n,r)=>{e=n,t=r})),resolve:e,reject:t}}var K=class{constructor(){this._lockP=null}async lock(){let e=this._lockP,{promise:t,resolve:n}=W();return this._lockP=t,await e,n}withLock(e){return B(this.lock(),e)}};async function B(e,t){let n=await e;try{return await t()}finally{n()}}function J(e){let t=new Headers;return t.set("x-reflect-auth-api-key",e),t}var Y="connection/";function Q(e){return`${Y}${encodeURIComponent(e.userID)}/${encodeURIComponent(e.roomID)}/${encodeURIComponent(e.clientID)}/`}function X(e){if(!e.startsWith(Y))return;let t=e.split("/");return 5===t.length&&""===t[4]?{userID:decodeURIComponent(t[1]),roomID:decodeURIComponent(t[2]),clientID:decodeURIComponent(t[3])}:void 0}function ee(e="Unauthorized"){return new Response(e,{status:401})}function te(e,t="Unexpected undefined value"){if(void 0===e)throw new Error(t);return e}function ne(e,t){typeof MINIFLARE<"u"&&k(e,t)}var re=M([C(),N(),E(),U(null)]),ie=function(e){let t;return new O({type:"lazy",schema:null,*entries(n,r){null!=t||(t=e()),yield*t.entries(n,r)},validator:(n,r)=>(null!=t||(t=e()),t.validator(n,r)),coercer:(n,r)=>(null!=t||(t=e()),t.coercer(n,r)),refiner:(n,r)=>(null!=t||(t=e()),t.refiner(n,r))})}((()=>{return M([re,I(ie),(e=C(),t=ie,new O({type:"record",schema:null,*entries(n){if(v(n))for(let r in n){let i=n[r];yield[r,r,e],yield[r,i,t]}},validator:e=>v(e)||"Expected an object, but received: "+w(e)}))]);var e,t})),ae=N(),se=M([ae,U(null)]),oe="version";async function le(e,t){await t.put(oe,e)}async function ue(e){return await e.get(oe,ae)}var ce=j({version:ae,deleted:E(),value:ie}),de="user/";function he(e){return`user/${e}`}async function pe(e,t){let n=await e.list({prefix:de,allowConcurrency:!0}),r=[];for(let[e,i]of n){ne(i,ce);let n=i;if(n.version<=t)continue;let a=e.substring(de.length),s=n.value;n.deleted?r.push({op:"del",key:a}):r.push({op:"put",key:a,value:s})}return r}var fe={allowConcurrency:!0,allowUnconfirmed:!0};var me=class{constructor(e){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_durable",void 0),this._durable=e}async put(e,t){return async function(e,t,n){await e.put(t,n,fe)}(this._durable,e,t)}async del(e){return async function(e,t){await e.delete(t,fe)}(this._durable,e)}async get(e,t){return await async function(e,t,n){let r=await e.get(t,fe);if(void 0!==r)return ne(r,n),r}(this._durable,e,t)}},ye=class{constructor(e){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_storage",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_cache",new Map),this._storage=e}async put(e,t){this._cache.set(e,{value:t,dirty:!0})}async del(e){this._cache.set(e,{value:void 0,dirty:!0})}async get(e,t){let n=this._cache.get(e);if(n)return n.value;let r=await this._storage.get(e,t);return this._cache.set(e,{value:r,dirty:!1}),r}pending(){let e=[];for(let[t,{value:n,dirty:r}]of this._cache.entries())r&&(void 0===n?e.push({op:"del",key:t}):e.push({op:"put",key:t,value:n}));return e}async flush(){await Promise.all([...this._cache.entries()].filter((([,{dirty:e}])=>e)).map((([e,{value:t}])=>void 0===t?this._storage.del(e):this._storage.put(e,t))))}},ve=j({lastMutationID:N(),baseCookie:se});function we(e){return`client/${e}`}async function ge(e,t){return await t.get(we(e),ve)}async function be(e,t,n){return await n.put(we(e),t)}var _e=(r=Symbol.iterator,class{constructor(e){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_peeked",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_iter",void 0),this._iter=e}[r](){return this}next(){if(void 0!==this._peeked){let e=this._peeked;return this._peeked=void 0,e}return this._iter.next()}peek(){return void 0!==this._peeked?this._peeked:this._peeked=this._iter.next()}});async function Oe(e,t,n,r,i){let a=Date.now();try{var s,o;null===(s=e.debug)||void 0===s||s.call(e,"processing mutation",JSON.stringify(t),"version",i);let{clientID:p}=t,f=new ye(r),m=await ge(p,f);if(!m)throw null!==(o=e.info)&&void 0!==o&&o.call(e,"client not found"),new Error(`Client ${p} not found`);let y=m.lastMutationID+1;var l,u;if(t.id<y)return void(null===(l=e.debug)||void 0===l||l.call(e,"skipping duplicate mutation",JSON.stringify(t)));if(t.id>y)return void(null===(u=e.info)||void 0===u||u.call(e,"skipping out of order mutation",JSON.stringify(t)));let v=new class{get clientID(){return this._clientID}constructor(e,t,n){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_clientID",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_inner",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_version",void 0),this._inner=e,this._clientID=t,this._version=n}async put(e,t){let n={deleted:!1,version:this._version,value:t};await this._inner.put(he(e),n)}async del(e){let t=await this.get(e);if(void 0===t)return!1;let n={deleted:!0,version:this._version,value:t};return await this._inner.put(he(e),n),void 0!==t}async get(e){let t=await this._inner.get(he(e),ce);if(void 0!==t)return t.deleted?void 0:t.value}async has(e){return void 0!==await this.get(e)}async isEmpty(){throw new Error("not implemented")}scan(e){throw new Error("Method not implemented.")}}(f,p,i);try{var c;let r=n.get(t.name);r?await r(v,t.args):null===(c=e.info)||void 0===c||c.call(e,"skipping unknown mutator",JSON.stringify(t))}catch(n){var d;null===(d=e.info)||void 0===d||d.call(e,"skipping mutation because error",JSON.stringify(t),n)}m.lastMutationID=y,await be(p,m,f),await le(i,f),await f.flush()}finally{var h;null===(h=e.debug)||void 0===h||h.call(e,`processMutation took ${Date.now()-a} ms`)}}async function ke(e,t,n,r,i,a){var s,o,l;null===(s=e.debug)||void 0===s||s.call(e,"processing frame - clients",r);let u=new ye(i),c=te(await ue(u)),d=(null!=c?c:0)+1;null===(o=e.debug)||void 0===o||o.call(e,"prevVersion",c,"nextVersion",d);for(let r of t)await Oe(e,r,n,u,d);if(te(await ue(u))===c)return null!==(l=e.debug)&&void 0!==l&&l.call(e,"no change in frame, skipping poke"),[];let h=function(e){return e.filter((e=>e.key.startsWith(de))).map((e=>{let{key:t,op:n}=e,r=t.substring(de.length);if("put"===n){let t=e.value;return t.deleted?{op:"del",key:r}:{op:"put",key:r,value:t.value}}throw new Error(`unexpected op: ${n}`)}))}(u.pending()),p=[];for(let e of r){let t=await ge(e,u);t.baseCookie=d,await be(e,t,u);let n={clientID:e,poke:{baseCookie:c,cookie:d,lastMutationID:t.lastMutationID,patch:h,timestamp:a}};p.push(n)}return await u.flush(),p}async function De(e,t,n,r,i){var a,o,l;let u=new me(r),c=new ye(u),d=[...t.keys()];null===(a=e.debug)||void 0===a||a.call(e,"processing room","clientIDs",d);let h=await ue(c);void 0===h&&(h=0,await le(h,c)),null===(o=e.debug)||void 0===o||o.call(e,"currentVersion",h);let p=await async function(e,t,n,r,i){let a=new Map(await Promise.all(e.map((async e=>[e,await t(e)])))),s=new Set([...a.values()].map((e=>e.baseCookie)));s.delete(n);let o=new Map(await Promise.all([...s].map((async e=>[e,await pe(r,null!=e?e:0)])))),l=[];for(let t of e){let e=te(a.get(t));if(e.baseCookie===n)continue;let r=te(o.get(e.baseCookie)),s={clientID:t,poke:{baseCookie:e.baseCookie,cookie:n,lastMutationID:e.lastMutationID,timestamp:i,patch:r}};l.push(s)}return l}(d,(async e=>te(await ge(e,c),`Client record not found: ${e}`)),h,r,i);null===(l=e.debug)||void 0===l||l.call(e,"pokes from fastforward",JSON.stringify(p));for(let e of p){let t=te(await ge(e.clientID,c));t.baseCookie=e.poke.cookie,await be(e.clientID,t,c)}let f=function*(e){let t=[],n=e=>{let{value:n,done:r}=e.peek();if(r)return;let i=t.findIndex((e=>e.peek().value.timestamp>n.timestamp));t.splice(-1===i?t.length:i,0,e)};for(let[t,r]of e){let e=r.pending.map((e=>s({clientID:t},e)));n(new _e(e.values()))}for(;;){let e=t.shift();if(!e)break;let{value:r,done:i}=e.peek();if(i)throw new Error("unexpected state");yield r,e.next(),n(e)}}(t);return p.push(...await ke(e,f,n,d,c,i)),await c.flush(),p}async function xe(e,t,n,r,i){var a;null===(a=e.debug)||void 0===a||a.call(e,"process pending");let s=Date.now();try{let a=await De(e,n,r,t,i);(function(e,t,n){for(let i of t){var r;let t=te(n.get(i.clientID)),a=["poke",i.poke];null!==(r=e.debug)&&void 0!==r&&r.call(e,"sending client",i.clientID,"poke",i.poke),t.socket.send(JSON.stringify(a))}})(e,a,n),function(e,t,n){var r;null===(r=e.debug)||void 0===r||r.call(e,"clearing pending mutations");for(let e of t){let t=te(n.get(e.clientID)),r=t.pending.findIndex((t=>t.id>e.poke.lastMutationID));t.pending.splice(0,r>-1?r:t.pending.length)}}(e,a,n)}finally{var o;null===(o=e.debug)||void 0===o||o.call(e,`processPending took ${Date.now()-s} ms`)}}async function Ie(e,t,n,r,i,a,o,l){var u,c,d,h,p,f,y,v,w,g,b;let _=n=>{var r,i;null!==(r=(i=e).info)&&void 0!==r&&r.call(i,"invalid connection request",n),t.send(JSON.stringify(["error",n])),t.close()},O=function(e,t){let n=(t,n)=>{let r=e.searchParams.get(t);if(""===r||null===r){if(n)throw new Error(`invalid querystring - missing ${t}`);return null}return r},r=(t,r)=>{let i=n(t,r);if(null===i)return null;let a=parseInt(i);if(isNaN(a))throw new Error(`invalid querystring parameter ${t}, url: ${e}, got: ${i}`);return a},i=e=>{let t,n=e.get(m);if(!n)throw new Error("missing user-data");try{t=JSON.parse(function(e){return decodeURIComponent(e)}(n))}catch(e){throw new Error("invalid user-data - failed to decode/parse")}if(!t.userID)throw new Error("invalid user-data - missing userID");return t};try{let e=n("clientID",!0),a=r("baseCookie",!1),s=r("ts",!0),o=r("lmid",!0);return{result:{clientID:e,userData:i(t),baseCookie:a,timestamp:s,lmid:o},error:null}}catch(e){return{result:null,error:String(e)}}}(r,i),{result:k}=O;if(null===k){let{error:e}=O;return void _(e)}null===(u=(c=e=e.addContext("client",k.clientID)).info)||void 0===u||u.call(c,"parsed request",s(s({},k),{},{userData:"redacted"}));let{clientID:D,baseCookie:x}=k,I=new me(n),E=await ge(D,I);null===(d=(h=e).debug)||void 0===d||d.call(h,"Existing client record",E);let U=null!==(p=null==E?void 0:E.lastMutationID)&&void 0!==p?p:0;var N,C;if(k.lmid>U)return null!==(N=(C=e).info)&&void 0!==N&&N.call(C,"Unexepted lmid when connecting. Got",k.lmid,"old lastMutationID",U),void _("Unexpected lmid");let S={baseCookie:x,lastMutationID:U};await I.put(we(D),S),null===(f=(y=e).debug)||void 0===f||f.call(y,"Put client record",S);let j=a.get(D);j&&(null!==(v=(w=e).debug)&&void 0!==v&&v.call(w,"Closing old socket"),j.socket.close()),t.addEventListener("message",(e=>o(D,e.data.toString(),t))),t.addEventListener("close",(()=>l(D,t)));let M={socket:t,userData:k.userData,clockBehindByMs:void 0,pending:[]};null!==(g=(b=e).debug)&&void 0!==g&&g.call(b,"Setting client map entry",D,M),a.set(D,M);t.send(JSON.stringify(["connected",{}]))}var Ee=j({}),Ue=S([U("ping"),Ee]),Ne=j({id:N(),name:C(),args:ie,timestamp:N()}),Ce=j({clientID:C(),mutations:I(Ne),pushVersion:N(),schemaVersion:C(),timestamp:N()}),Se=M([S([U("push"),Ce]),Ue]);function je(e,t){let n=["error",t];e.send(JSON.stringify(n))}function Me(e,t,n,r,i,a){let s;try{s=function(e){let t=JSON.parse(e);return ne(t,Se),t}(r)}catch(t){var o;return null!==(o=e.info)&&void 0!==o&&o.call(e,"invalid message",t),void je(i,String(t))}let l=t.get(n);var u;if(!l)return null!==(u=e.error)&&void 0!==u&&u.call(e,"client not found, closing socket"),je(i,`no such client: ${n}`),void i.close();switch(s[0]){case"ping":!function(e,t){var n;null===(n=e.debug)||void 0===n||n.call(e,"handling ping"),t.send(JSON.stringify(["pong",{}]))}(e,i);break;case"push":!function(e,t,n,r,i){var a,s;null!==(a=e.debug)&&void 0!==a&&a.call(e,"handling push",JSON.stringify(n)),void 0===t.clockBehindByMs&&(t.clockBehindByMs=r()-n.timestamp,null===(s=e.debug)||void 0===s||s.call(e,"initializing clock offset: clock behind by",t.clockBehindByMs));for(let r of n.mutations){var o;let n=t.pending.findIndex((e=>e.id>=r.id));if(-1===n)n=t.pending.length;else if(t.pending[n].id===r.id){var l;null===(l=e.debug)||void 0===l||l.call(e,"mutation already been queued",r.id);continue}r.timestamp+=t.clockBehindByMs,t.pending.splice(n,0,r),null===(o=e.debug)||void 0===o||o.call(e,"inserted mutation, pending is now",JSON.stringify(t.pending))}i()}(e,l,s[1],(()=>Date.now()),a);break;default:throw new Error(`Unknown message type: ${s[0]}`)}}function Te(e){let{getLogSink:t,getLogLevel:n}=e;return{fetch:async(e,r,i)=>Pe(r,i,t,n,(t=>async function(e,t,n){var r,i;n=n.addContext("req",h()),null===(r=(i=n).debug)||void 0===r||r.call(i,"Handling request:",e.url);try{var a,s;let r=await async function(e,t,n){let r=(e,t)=>Ae(n,t);return G(e,t,n.REFLECT_AUTH_API_KEY,{connect:r,authInvalidateForUser:r,authInvalidateForRoom:r,authInvalidateAll:r})}(e,n,t);return null!==(a=(s=n).debug)&&void 0!==a&&a.call(s,`Returning response: ${r.status} ${r.statusText}`),r}catch(e){var o,l;throw null!==(o=(l=n).info)&&void 0!==o&&o.call(l,"Unhandled exception",e),e}}(e,r,t))),scheduled:async(e,r,i)=>Pe(r,i,t,n,(e=>async function(e,t){var n,r,i,a,s,o;if(t=t.addContext("scheduled",h()),null!==(n=(r=t).info)&&void 0!==n&&n.call(r,"Handling scheduled event"),!e.REFLECT_AUTH_API_KEY){var l,u;return void(null===(l=(u=t).debug)||void 0===l||l.call(u,"Returning early because REFLECT_AUTH_API_KEY is not defined in env."))}null===(i=(a=t).info)||void 0===i||i.call(a,`Sending ${Z} request to AuthDO`);let c=await Ae(e,new Request(`https://unused-reflect-auth-do.dev${Z}`,{headers:J(e.REFLECT_AUTH_API_KEY),method:"POST"}));null===(s=(o=t).info)||void 0===s||s.call(o,`Response: ${c.status} ${c.statusText}`)}(r,e)))}}async function Pe(e,t,n,r,i){let a=n(e),s=new d(r(e),a).addContext("Worker");try{return await i(s)}finally{a.flush&&t.waitUntil(a.flush())}}function Ae(e,t){let{authDO:n}=e,r=n.idFromName("auth");return n.get(r).fetch(t)}function Le(e){return 1===e.length?e[0]:new u(e)}function Re(e){let{authHandler:t,getLogSinks:n=(e=>[c]),getLogLevel:r=(e=>"debug")}=e;return{worker:Te({getLogSink:e=>Le(n(e)),getLogLevel:r}),RoomDO:class extends class{constructor(e){var t,n,r,i;Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_clients",new Map),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_lock",new K),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_mutators",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_lc",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_state",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_authApiKey",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_turnTimerID",0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_handleMessage",(async(e,t,n)=>{var r;let i=this._lc.addContext("req",h()).addContext("client",e);null!==(r=i.debug)&&void 0!==r&&r.call(i,"handling message",t,"waiting for lock"),await this._lock.withLock((async()=>{var r;null!==(r=i.debug)&&void 0!==r&&r.call(i,"received lock"),Me(i,this._clients,e,t,n,(()=>this._processUntilDone()))}))})),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_handleClose",(async(e,t)=>{var n;let r=this._lc.addContext("req",h()).addContext("client",e);null!==(n=r.debug)&&void 0!==n&&n.call(r,"handling close - waiting for lock"),await this._lock.withLock((async()=>{var n;null!==(n=r.debug)&&void 0!==n&&n.call(r,"received lock"),function(e,t,n,r){var i,a;(null===(i=t.get(n))||void 0===i?void 0:i.socket)===r&&(null!==(a=e.debug)&&void 0!==a&&a.call(e,"on socket close deleting client map entry for",n),t.delete(n))}(r,this._clients,e,t)}))}));let{mutators:a,state:s,authApiKey:o,logSink:l,logLevel:u}=e;this._mutators=new Map([...Object.entries(a)]),this._state=s,this._authApiKey=o,this._lc=new d(u,l).addContext("RoomDO"),null!==(t=(n=this._lc).info)&&void 0!==t&&t.call(n,"Starting server"),null===(r=(i=this._lc).info)||void 0===r||r.call(i,"Version:",f)}async fetch(e){return G(e,this._lc.addContext("req",h()),this._authApiKey,this)}async connect(e,t){var n;if("websocket"!==t.headers.get("Upgrade"))return new Response("expected websocket",{status:400});let r=new WebSocketPair,i=r[1],a=new URL(t.url);return null!==(n=e.debug)&&void 0!==n&&n.call(e,"connection request",a.toString(),"waiting for lock"),i.accept(),this._lock.withLock((async()=>{var n;null!==(n=e.debug)&&void 0!==n&&n.call(e,"received lock"),await Ie(e,i,this._state.storage,a,t.headers,this._clients,this._handleMessage,this._handleClose)})),new Response(null,{status:101,webSocket:r[0]})}async authInvalidateForUser(e,t,{userID:n}){var r;return null!==(r=e.debug)&&void 0!==r&&r.call(e,`Closing user ${n}'s connections fulfilling auth api invalidateForUser request.`),await this._closeConnections((e=>e.userData.userID===n)),new Response("Success",{status:200})}async authInvalidateForRoom(e){var t;return null!==(t=e.info)&&void 0!==t&&t.call(e,"Closing all connections fulfilling auth api invalidateForRoom request."),await this._closeConnections((e=>!0)),new Response("Success",{status:200})}async authInvalidateAll(e){var t;return null!==(t=e.info)&&void 0!==t&&t.call(e,"Closing all connections fulfilling auth api invalidateAll request."),await this._closeConnections((e=>!0)),new Response("Success",{status:200})}async authConnections(){return new Response(JSON.stringify(function(e){let t=[];for(let[n,r]of e)t.push({userID:r.userData.userID,clientID:n});return t}(this._clients)))}_closeConnections(e){return this._lock.withLock((()=>function(e,t){for(let n of e.values())t(n)&&n.socket.close()}(this._clients,e)))}async _processUntilDone(){var e;let t=this._lc.addContext("req",h());var n;null!==(e=t.debug)&&void 0!==e&&e.call(t,"handling processUntilDone"),this._turnTimerID?null===(n=t.debug)||void 0===n||n.call(t,"already processing, nothing to do"):this._turnTimerID=setInterval((()=>{this._processNext(t)}),1e3/60)}async _processNext(e){var t;null!==(t=e.debug)&&void 0!==t&&t.call(e,`processNext - starting turn at ${Date.now()} - waiting for lock`),await this._lock.withLock((async()=>{var t,n;if(null!==(t=e.debug)&&void 0!==t&&t.call(e,`received lock at ${Date.now()}`),!function(e){for(let t of e.values())if(t.pending.length>0)return!0;return!1}(this._clients))return null!==(n=e.debug)&&void 0!==n&&n.call(e,"No pending mutations to process, exiting"),void(this._turnTimerID&&(clearInterval(this._turnTimerID),this._turnTimerID=0));await xe(e,this._state.storage,this._clients,this._mutators,Date.now())}))}}{constructor(t,i){super({mutators:e.mutators,state:t,authApiKey:i.REFLECT_AUTH_API_KEY,logSink:Le(n(i)),logLevel:r(i)})}},AuthDO:class extends class{constructor(e,t=typeof MINIFLARE<"u"){var n,r,i,a;Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_roomDO",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_state",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_authHandler",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_authApiKey",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_lc",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_isMiniflare",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_lock",void 0);let{roomDO:s,state:o,authHandler:l,authApiKey:u,logSink:c,logLevel:h}=e;this._roomDO=s,this._state=o,this._authHandler=l,this._authApiKey=u,this._lc=new d(h,c).addContext("AuthDO"),this._isMiniflare=t,this._lock=new class{constructor(){this._lock=new K,this._writeP=null,this._readP=[]}read(){return this._lock.withLock((async()=>{await this._writeP;let{promise:e,resolve:t}=W();return this._readP.push(e),t}))}withRead(e){return B(this.read(),e)}async write(){return await this._lock.withLock((async()=>{await this._writeP,await Promise.all(this._readP);let{promise:e,resolve:t}=W();return this._writeP=e,this._readP=[],t}))}withWrite(e){return B(this.write(),e)}},null!==(n=(r=this._lc).info)&&void 0!==n&&n.call(r,"Starting server"),null===(i=(a=this._lc).info)||void 0===i||i.call(a,"Version:",f)}async fetch(e){var t;let n=this._lc.addContext("req",h());null===(t=n.debug)||void 0===t||t.call(n,"Handling request:",e.url);try{var r;let t=await G(e,n,this._authApiKey,this);return null!==(r=n.debug)&&void 0!==r&&r.call(n,`Returning response: ${t.status} ${t.statusText}`),t}catch(e){var i;throw null!==(i=n.info)&&void 0!==i&&i.call(n,"Unhandled exception",e),e}}async connect(e,t){var n,r;let i=new URL(t.url);if("/connect"!==i.pathname)return new Response("unknown route",{status:400});let a=i.searchParams.get("roomID");if(null===a||""===a)return new Response("roomID parameter required",{status:400});let s=i.searchParams.get("clientID");if(!s)return new Response("clientID parameter required",{status:400});e=e.addContext("client",s).addContext("room",a);let o,l=t.headers.get("Sec-WebSocket-Protocol");if(!l)return null!==(n=(r=e).info)&&void 0!==n&&n.call(r,"auth not found in Sec-WebSocket-Protocol header."),ee("auth required");try{o=decodeURIComponent(l)}catch(t){var u,c;return null!==(u=(c=e).info)&&void 0!==u&&u.call(c,"error decoding auth found in Sec-WebSocket-Protocol header."),ee("invalid auth")}let d=o;return this._lock.withRead((async()=>{var n,r,i,o;let u;try{u=await this._authHandler(d,a)}catch(e){return ee()}if(!u||!u.userID)return u?u.userID||null===(n=(r=e).info)||void 0===n||n.call(r,"userData returned by authHandler has no userID."):null===(i=(o=e).info)||void 0===i||i.call(o,"userData returned by authHandler is falsey."),ee();let c=Q({userID:u.userID,roomID:a,clientID:s}),h={connectTimestamp:Date.now()};await this._state.storage.put(c,h);let p=this._roomDO.idFromName(a),f=this._roomDO.get(p),y=new Request(t);var v;y.headers.set(m,(v=JSON.stringify(u),encodeURIComponent(v).replace(/%(3A|3B|2C|2F|22|3F|7B|7D|5B|5D|40|3C|3E|3D|2B|23|24|26|60|7C|5E|20)/g,((e,t)=>String.fromCharCode(parseInt(t,16))))));let w=await f.fetch(y),g=new Headers(w.headers);return this._isMiniflare||g.set("Sec-WebSocket-Protocol",l),new Response(w.body,{status:w.status,statusText:w.statusText,webSocket:w.webSocket,headers:g})}))}async authInvalidateForUser(e,t,{userID:n}){var r;return null!==(r=e.debug)&&void 0!==r&&r.call(e,`authInvalidateForUser ${n} waiting for lock.`),this._lock.withWrite((async()=>{var r;null===(r=e.debug)||void 0===r||r.call(e,"got lock.");let i=(await this._state.storage.list({prefix:(a=n,`${Y}${encodeURIComponent(a)}/`)})).keys();var a;return this._forwardInvalidateRequest(e,"authInvalidateForUser",t,[...i])}))}async authInvalidateForRoom(e,t,{roomID:n}){var r;return null!==(r=e.debug)&&void 0!==r&&r.call(e,`authInvalidateForRoom ${n} waiting for lock.`),this._lock.withWrite((async()=>{var r,i,a;null!==(r=e.debug)&&void 0!==r&&r.call(e,"got lock."),null===(i=e.debug)||void 0===i||i.call(e,`Sending authInvalidateForRoom request to ${n}`);let s=this._roomDO.idFromName(n),o=await this._roomDO.get(s).fetch(t);return o.ok||null!==(a=e.debug)&&void 0!==a&&a.call(e,`Received error response from ${n}. ${o.status} ${await o.text}`),o}))}async authInvalidateAll(e,t){var n;return null!==(n=e.debug)&&void 0!==n&&n.call(e,"authInvalidateAll waiting for lock."),this._lock.withWrite((async()=>{var n;null===(n=e.debug)||void 0===n||n.call(e,"got lock.");let r=(await this._state.storage.list({prefix:Y})).keys();return this._forwardInvalidateRequest(e,"authInvalidateAll",t,[...r])}))}async authRevalidateConnections(e){var t,n,r,i;null===(t=e.info)||void 0===t||t.call(e,"Starting auth revalidation.");let a=this._authApiKey;if(void 0===a)return null!==(n=e.info)&&void 0!==n&&n.call(e,"Returning Unauthorized because REFLECT_AUTH_API_KEY is not defined in env."),new Response("Unauthorized",{status:401});let s=await this._state.storage.list({prefix:Y}),o=new Map;for(let t of s.keys()){let n=X(t);if(!n){var l;null===(l=e.error)||void 0===l||l.call(e,"Failed to parse connection key",t);continue}let{roomID:r}=n,i=o.get(r);i||(i=new Set,o.set(r,i)),i.add(t)}null===(r=e.info)||void 0===r||r.call(e,`Revalidating ${s.size} ConnectionRecords across ${o.size} rooms.`);let u=0;for(let[t,n]of o){var c;null!==(c=e.debug)&&void 0!==c&&c.call(e,`revalidating connections for ${t} waiting for lock.`),await this._lock.withWrite((async()=>{var r;null===(r=e.debug)||void 0===r||r.call(e,"got lock.");let i,s=this._roomDO.idFromName(t),o=await this._roomDO.get(s).fetch(new Request(`https://unused-reflect-room-do.dev${$}`,{headers:J(a)}));try{let e=await o.json();k(e,A),i=e}catch(t){var l;null===(l=e.error)||void 0===l||l.call(e,`Bad ${$} response from roomDO`,t)}if(i){let r=new Set(i.map((({userID:e,clientID:n})=>Q({roomID:t,userID:e,clientID:n})))),a=[...n].filter((e=>!r.has(e)));try{u+=await this._state.storage.delete(a)}catch(n){var c;null===(c=e.info)||void 0===c||c.call(e,"Failed to delete connections for roomID",t)}}}))}return null!==(i=e.info)&&void 0!==i&&i.call(e,`Revalidated ${s.size} ConnectionRecords, deleted ${u} ConnectionRecords.`),new Response("Complete",{status:200})}async _forwardInvalidateRequest(e,t,n,r){var i;let a=r.map((t=>{var n;let r=X(t);return r||null!==(n=e.error)&&void 0!==n&&n.call(e,"Failed to parse connection key",t),r})),s=new Set;for(let e of a)e&&s.add(e.roomID);let o=[...s],l=[];null===(i=e.debug)||void 0===i||i.call(e,`Sending ${t} requests to ${o.length} rooms`);for(let e of o){let t=this._roomDO.idFromName(e),r=this._roomDO.get(t);l.push(r.fetch(n))}let u=[];for(let t=0;t<l.length;t++){var c;let n=await l[t];n.ok||(u.push(n),null===(c=e.debug)||void 0===c||c.call(e,`Received error response from ${o[t]}. ${n.status} ${await n.text}`))}return 0===u.length?new Response("Success",{status:200}):u[0]}}{constructor(e,i){super({roomDO:i.roomDO,state:e,authHandler:t,authApiKey:i.REFLECT_AUTH_API_KEY,logSink:Le(n(i)),logLevel:r(i)})}}}}var Fe=class{constructor(e){Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_messages",[]),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_apiKey",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_service",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_host",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_interval",void 0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_timerID",0),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_flushLock",new K),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/defineProperty'");throw e.code="MODULE_NOT_FOUND",e}())(this,"_signal",void 0);let{apiKey:t,service:n,host:r,interval:i=1e4,signal:a}=e;this._apiKey=t,this._service=n,this._host=r,this._interval=i,this._signal=a,a&&a.addEventListener("abort",(()=>{this._timerID&&clearTimeout(this._timerID)}))}log(e,...t){var n;(null===(n=this._signal)||void 0===n?void 0:n.aborted)||(this._messages.push(function(e,t){let n={date:Date.now(),message:He(e),status:t};return"error"===t&&(n.error={origin:"logger"}),n}(t,e)),"error"===e?this.flush():this._startTimer())}_startTimer(){var e;(null===(e=this._signal)||void 0===e?void 0:e.aborted)||this._timerID||(this._timerID=setTimeout((()=>{this._timerID=0,this.flush()}),this._interval))}flush(){return this._flushLock.withLock((async()=>{var e;if(null!==(e=this._signal)&&void 0!==e&&e.aborted)return;let{length:t}=this._messages;if(0===t)return;let n=this._messages;this._messages=[];let r=n.map((e=>JSON.stringify(e))).join("\n"),i=new URL("https://http-intake.logs.datadoghq.com/api/v2/logs");i.searchParams.set("ddsource","worker"),this._service&&i.searchParams.set("service",this._service),this._host&&i.searchParams.set("host",this._host);let a=!1;try{a=(await fetch(i.toString(),{headers:{"DD-API-KEY":this._apiKey},method:"POST",body:r,signal:this._signal})).ok}catch(e){}a||this._messages.splice(0,0,...n),this._messages.length&&this._startTimer()}))}};function He(e){return Array.isArray(e)&&1===e.length?He(e[0]):e}var Ze={log(e,...t){console[e](...t)}},$e=class extends class{constructor(e,t="info"){this.debug=void 0,this.info=void 0,this.error=void 0;let n=t=>(...n)=>e.log(t,...n);switch(t){case"debug":this.debug=n("debug");case"info":this.info=n("info");case"error":this.error=n("error")}}}{constructor(e="info",t=Ze){super(t,e),this.xt=e,this.bt=t}addContext(e,t){let n=void 0===t?e:`${e}=${t}`,r={log:(e,...t)=>{this.bt.log(e,n,...t)}};return new $e(this.xt,r)}};function ze(){let e,t;return{promise:new Promise(((n,r)=>{e=n,t=r})),resolve:e,reject:t}}var Ge=class{constructor(){this.He=null}async lock(){let e=this.He,{promise:t,resolve:n}=ze();return this.He=t,await e,n}withLock(e){return Ve(this.lock(),e)}},qe=class{constructor(){this.Ne=new Ge,this.te=null,this.ne=[]}read(){return this.Ne.withLock((async()=>{await this.te;let{promise:e,resolve:t}=ze();return this.ne.push(e),t}))}withRead(e){return Ve(this.read(),e)}async write(){return await this.Ne.withLock((async()=>{await this.te,await Promise.all(this.ne);let{promise:e,resolve:t}=ze();return this.te=e,this.ne=[],t}))}withWrite(e){return Ve(this.write(),e)}};async function Ve(e,t){let n=await e;try{return await t()}finally{n()}}function We(e,t="Assertion failed"){if(!e)throw new Error(t)}function Ke(e){Je(e,"string")}function Be(e){Je(e,"number")}function Je(e,t){typeof e!==t&&Xe(e,t)}function Ye(e){null===e&&Xe(e,"object"),Je(e,"object")}function Qe(e){Array.isArray(e)||Xe(e,"array")}function Xe(e,t){throw new Error(function(e,t){let n="Invalid type: ";return n+=null==e?e:`${typeof e} \`${e}\``,n+`, expected ${t}`}(e,t))}function et(e){if(void 0===e)throw new Error("Expected non undefined value")}var tt=Object.prototype.hasOwnProperty,nt=Object.hasOwn||((e,t)=>tt.call(e,t));function rt(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;switch(typeof e){case"boolean":case"number":case"string":return!1}if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!rt(e[n],t[n]))return!1;return!0}if(null===e||null===t||Array.isArray(t))return!1;let n=0;for(let r in e)if(nt(e,r)){if(!rt(e[r],t[r]))return!1;n++}let r=0;for(let e in t)nt(t,e)&&r++;return n===r}function it(e){return at(e,[])}function at(e,t){switch(typeof e){case"boolean":case"number":case"string":case"undefined":return e;case"object":{if(null===e)return null;if(t.includes(e))throw new Error("Cyclic object");if(t.push(e),Array.isArray(e)){let n=e.map((e=>at(e,t)));return t.pop(),n}let n={};for(let r in e)if(nt(e,r)){let i=e[r];void 0!==i&&(n[r]=at(i,t))}return t.pop(),n}default:throw new Error("Invalid type: "+typeof e)}}function st(e){switch(typeof e){case"string":return 5+e.length;case"number":return function(e){return e===(0|e)}(e)?e<=-(2**30)||e>=2**30-1?6:5:9;case"boolean":return 1;case"object":if(null===e)return 1;if(Array.isArray(e)){let t=6;for(let n of e)t+=st(n);return t}{let t=e,n=1;for(let e in t)if(nt(t,e)){let r=t[e];void 0!==r&&(n+=st(e)+st(r))}return n+4+1}}throw new Error("invalid value")}function ot(e){0}async function lt(e){let t=await fetch(e),n=t.status,r=200===n?"":await t.text();return{response:t,httpRequestInfo:{httpStatusCode:n,errorMessage:r}}}var ut=async e=>(await lt(e)).httpRequestInfo,ct=class extends Error{constructor(e){super("Failed to push"),this.name="PushError",this.causedBy=e}};function dt(e){return"object"==typeof e&&null!==e&&"ClientStateNotFound"===e.error}function ht(e){if("object"!=typeof e||null===e)throw new Error("PullResponse must be an object");if(dt(e))return;let t=e;void 0!==t.cookie&&ot(t.cookie),Be(t.lastMutationID),function(e){Qe(e);for(let t of e)ft(t)}(t.patch)}var pt=async e=>{let{httpRequestInfo:t,response:n}=await lt(e);return 200!==t.httpStatusCode?{httpRequestInfo:t}:{response:await n.json(),httpRequestInfo:t}};function ft(e){switch(Ye(e),e.op){case"put":Ke(e.key),ot(e.value);break;case"del":Ke(e.key);break;case"clear":break;default:throw new Error(`unknown patch op \`${e.op}\`, expected one of \`put\`, \`del\`, \`clear\``)}}var mt=class extends Error{constructor(e){super("Failed to pull"),this.name="PullError",this.causedBy=e}};function yt(e){return void 0!==e.indexName}function vt(e){return"string"==typeof e?[e]:e}function wt(e){if(!e)return{};let t,n,r,i;return e.start&&(({key:t,exclusive:n}=e.start),e.indexName?"string"==typeof t?i=t:(i=t[0],r=t[1]):r=t),{prefix:e.prefix,startSecondaryKey:i,startKey:r,startExclusive:n,limit:e.limit,indexName:e.indexName}}var gt=class extends Error{constructor(){super("Transaction is closed")}};function bt(e){if(e.closed)throw new gt}async function _t(e){let t=[];var n,r=!1,i=!1;try{for(var a,s=o(e);r=!(a=await s.next()).done;r=!1){let e=a.value;t.push(e)}}catch(e){i=!0,n=e}finally{try{r&&null!=s.return&&await s.return()}finally{if(i)throw n}}return t}var Ot=new TextEncoder;new TextDecoder;var kt=/^[0-9a-v]{32}$/,Dt=/^t\/[0-9a-v]{30}$/;async function xt(e){let t=function(e){return Ot.encode(e)}(JSON.stringify(e)),n=await crypto.subtle.digest("SHA-512",t);return function(e){let t=0,n=0,r=0,i="",{length:a}=e;for(;t<a;){let s=e[t];n>3?(r=s&255>>n,n=(n+5)%8,r=r<<n|(t+1<a?e[t+1]:0)>>8-n,t++):(r=s>>8-(n+5)&31,n=(n+5)%8,0===n&&t++),i+="0123456789abcdefghijklmnopqrstuv"[r]}return i}(new Uint8Array(n,0,20))}var It="00000000000000000000000000000000",Et=function(e){let t=0;return()=>e+(t++).toString().padStart(32-e.length,"0")}("t/");function Ut(e){return"string"==typeof e&&Dt.test(e)}function Nt(e){if(Dt.test(e))throw new Error("Unexpected temp hash")}function Ct(e){if(!function(e){return"string"==typeof e&&(kt.test(e)||Dt.test(e))}(e))throw new Error(`Invalid hash: '${e}'`)}function St(e,t){let n=0;for(;n<e;){let r=n+(e-n>>1);t(r)?e=r:n=r+1}return n}function jt(e){return At(e)?e[1].map((e=>e[1])):[]}async function Mt(e,t,n){let r=await n.getNode(t);if(zt(r))return r;let{entries:i}=r,a=Tt(e,i);return a===i.length&&a--,Mt(e,i[a][1],n)}function Tt(e,t){return St(t.length,(n=>e<=t[n][0]))}function Pt(e,t,n){return e!==t.length&&t[e][0]===n}function At(e){return e[0]>0}var Lt=class{constructor(e,t,n){this.entries=e,this.hash=t,this.isMutable=n}maxKey(){return this.entries[this.entries.length-1][0]}toChunkData(){return[this.level,this.entries]}},Rt=class extends Lt{constructor(){super(...arguments),this.level=0}async set(e,t,n){let r,i=Tt(e,this.entries);return r=Pt(i,this.entries,e)?1:0,this.De(n,i,r,[e,t])}De(e,t,n,...r){if(this.isMutable)return this.entries.splice(t,n,...r),e.updateNode(this),this;let i=Ft(this.entries,t,n,...r);return e.newDataNodeImpl(i)}async del(e,t){let n=Tt(e,this.entries);return Pt(n,this.entries,e)?this.De(t,n,1):this}keys(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){for(let e of t.entries)yield e[0]}))()}entriesIter(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){for(let e of t.entries)yield e}))()}};function Ft(e,t,n,...r){let i=e.slice(0,t);for(let e=0;e<r.length;e++)i.push(r[e]);for(let r=t+n;r<e.length;r++)i.push(e[r]);return i}function*Ht(...e){for(let t of e)yield*t}var Zt=class extends Lt{constructor(e,t,n,r){super(e,t,r),this.level=n}async set(e,t,n){let r=Tt(e,this.entries);r===this.entries.length&&r--;let i=this.entries[r][1],a=await(await n.getNode(i)).set(e,t,n),s=n.childNodeSize(a);return s>n.maxSize||s<n.minSize?this.ke(n,r,a):this.Pe(n,r,[a.maxKey(),a.hash])}async ke(e,t,n){let r,i,a,s=this.level-1,o=this.entries;if(t>0){let s=o[t-1][1];r=Ht((await e.getNode(s)).entries,n.entries),i=t-1,a=2}else if(t<o.length-1){let s=o[t+1][1],l=await e.getNode(s);r=Ht(n.entries,l.entries),i=t,a=2}else r=n.entries,i=t,a=1;let l=Gt(r,e.getEntrySize,e.minSize-e.chunkHeaderSize,e.maxSize-e.chunkHeaderSize),u=[];for(let t of l){let n=e.newNodeImpl(t,s);u.push([n.maxKey(),n.hash])}if(this.isMutable)return this.entries.splice(i,a,...u),e.updateNode(this),this;let c=Ft(o,i,a,...u);return e.newInternalNodeImpl(c,this.level)}Pe(e,t,n){if(this.isMutable)return this.entries.splice(t,1,n),e.updateNode(this),this;let r=Ft(this.entries,t,1,n);return e.newInternalNodeImpl(r,this.level)}async del(e,t){let n=Tt(e,this.entries);if(n===this.entries.length)return this;let r=this.entries[n][1],i=await t.getNode(r),a=i.hash,s=await i.del(e,t);if(s.hash===a)return this;if(0===s.entries.length){let e=Ft(this.entries,n,1);return t.newInternalNodeImpl(e,this.level)}return 0===n&&1===this.entries.length?s:t.childNodeSize(s)>t.minSize?this.Pe(t,n,[s.maxKey(),s.hash]):this.ke(t,n,s)}keys(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){for(let n of t.entries)yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o((yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getNode(n[1]))).keys(e)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}entriesIter(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){for(let n of t.entries)yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o((yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getNode(n[1]))).entriesIter(e)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}async getChildren(e,t,n){let r=[];for(let i=e;i<t&&i<this.entries.length;i++)r.push(n.getNode(this.entries[i][1]));return Promise.all(r)}async getCompositeChildren(e,t,n){let{level:r}=this;if(0===t)return new Zt([],Et(),r-1,!0);let i=await this.getChildren(e,e+t,n);if(r>1){let e=[];for(let t of i)e.push(...t.entries);return new Zt(e,Et(),r-1,!0)}We(1===r);let a=[];for(let e of i)a.push(...e.entries);return new Rt(a,Et(),!0)}};function $t(e,t,n,r){return 0===n?new Rt(e,t,r):new Zt(e,t,n,r)}function zt(e){return 0===e.level}function Gt(e,t,n,r){let i=[],a=[],s=0,o=[];for(let l of e){let e=t(l);e>=r?(o.length>0&&(i.push(o),a.push(s)),i.push([l]),a.push(e),s=0,o=[]):s+e>=n?(o.push(l),i.push(o),a.push(s+e),s=0,o=[]):(s+=e,o.push(l))}return s>0&&(a.length>0&&s+a[a.length-1]<=r?i[i.length-1].push(...o):i.push(o)),i}var qt=[0,[]],Vt=new Rt([],It,!1);function*Wt(e,t){let n,r=0,i=0;function a(e,t){-1===e[3]&&(e[3]=t)}function s(){return[r,0,0,-1]}for(;r<e.length&&i<t.length;)e[r][0]===t[i][0]?(rt(e[r][1],t[i][1])?n&&(a(n,0),yield n,n=void 0):(n||(n=s()),n[2]++,n[1]++,a(n,i)),r++,i++):e[r][0]<t[i][0]?(n||(n=s()),n[1]++,r++):(n||(n=s()),n[2]++,a(n,i),i++);i<t.length&&(n||(n=s()),n[2]+=t.length-i,a(n,i)),r<e.length&&(n||(n=s()),n[1]+=e.length-r),n&&(a(n,0),yield n)}var Kt=class{constructor(e,t=It,n=st,r=11){this.Ee=new Map,this.rootHash=t,this.p=e,this.getEntrySize=n,this.chunkHeaderSize=r}async getNode(e){if(e===It)return Vt;let t=this.Ee.get(e);if(t)return t;let{data:n}=await this.p.mustGetChunk(e),r=$t(n[1],e,n[0],!1);return this.Ee.set(e,r),r}async get(e){let t=await Mt(e,this.rootHash,this),n=Tt(e,t.entries);if(Pt(n,t.entries,e))return t.entries[n][1]}async has(e){let t=await Mt(e,this.rootHash,this);return Pt(Tt(e,t.entries),t.entries,e)}async isEmpty(){return 0===(await this.getNode(this.rootHash)).entries.length}scan(e){return Qt(this.rootHash,e,(async e=>{let t=await this.getNode(e);if(t)return t.toChunkData();let{data:n}=await this.p.mustGetChunk(e);return n}))}keys(){var e=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o((yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getNode(e.rootHash))).keys(e)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}entries(){var e=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o((yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getNode(e.rootHash))).entriesIter(e)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}[Symbol.asyncIterator](){return this.entries()}diff(e){var t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){let[n,r]=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(Promise.all([t.getNode(t.rootHash),e.getNode(e.rootHash)]));yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Bt(r,n,e,t)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}};function Bt(e,t,n,r){return Jt.apply(this,arguments)}function Jt(){return(Jt=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t,n,r){if(e.level>t.level){let i=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getCompositeChildren(0,e.entries.length,n));return void(yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Bt(i,t,n,r)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())))}if(t.level>e.level){let i=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(t.getCompositeChildren(0,t.entries.length,r));return void(yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Bt(e,i,n,r)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())))}if(0===e.level&&0===t.level)return void(yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Yt(e.entries,t.entries)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())));let i=Wt(e.entries,t.entries);for(let a of i){let[i,s]=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(Promise.all([e.getCompositeChildren(a[0],a[1],n),t.getCompositeChildren(a[3],a[2],r)]));yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Bt(i,s,n,r)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}}))).apply(this,arguments)}function*Yt(e,t){let n=e.length,r=t.length,i=0,a=0;for(;i<n&&a<r;){let n=e[i][0],r=t[a][0];n===r?(rt(e[i][1],t[a][1])||(yield{op:"change",key:n,oldValue:e[i][1],newValue:t[a][1]}),i++,a++):n<r?(yield{op:"del",key:n,oldValue:e[i][1]},i++):(yield{op:"add",key:r,newValue:t[a][1]},a++)}for(;i<n;i++)yield{op:"del",key:e[i][0],oldValue:e[i][1]};for(;a<r;a++)yield{op:"add",key:t[a][0],newValue:t[a][1]}}function Qt(e,t,n){return Xt.apply(this,arguments)}function Xt(){return(Xt=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t,n){if(e===It)return;let r=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(n(e)),i=r[1],a=0;if(t&&(a=Tt(t,i)),At(r))for(;a<i.length;a++)yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(Qt(i[a][1],t,n)),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())),t="";else for(;a<i.length;a++)yield i[a]}))).apply(this,arguments)}async function en(e,t){let n=[],r="add"===t?e=>({op:"add",key:e[0],newValue:e[1]}):e=>({op:"del",key:e[0],oldValue:e[1]});var i,a=!1,s=!1;try{for(var l,u=o(e.entries());a=!(l=await u.next()).done;a=!1){let e=l.value;n.push(r(e))}}catch(e){s=!0,i=e}finally{try{a&&null!=u.return&&await u.return()}finally{if(s)throw i}}return n}var tn=class extends Kt{constructor(e,t=It,n=8192,r=16384,i,a){super(e,t,i,a),this.s=new qe,this.N=new Map,this.minSize=n,this.maxSize=r}async getNode(e){return this.N.get(e)||super.getNode(e)}U(e){We(e.isMutable),this.N.set(e.hash,e)}updateNode(e){We(e.isMutable),this.N.delete(e.hash),e.hash=Et(),this.U(e)}newInternalNodeImpl(e,t){let n=new Zt(e,Et(),t,!0);return this.U(n),n}newDataNodeImpl(e){let t=new Rt(e,Et(),!0);return this.U(t),t}newNodeImpl(e,t){let n=$t(e,Et(),t,!0);return this.U(n),n}childNodeSize(e){let t=this.chunkHeaderSize;for(let n of e.entries)t+=this.getEntrySize(n);return t}get(e){return this.s.withRead((()=>super.get(e)))}has(e){return this.s.withRead((()=>super.has(e)))}isEmpty(){return this.s.withRead((()=>super.isEmpty()))}scan(e){var t=()=>super.scan,n=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(nn(n.s,t().call(n,e))),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}keys(){var e=()=>super.keys,t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(nn(t.s,e().call(t))),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}entries(){var e=()=>super.entries,t=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(nn(t.s,e().call(t))),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}diff(e){var t=()=>super.diff,n=this;return Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(){yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(nn(n.s,t().call(n,e))),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}))()}put(e,t){return this.s.withWrite((async()=>{let n=await(await this.getNode(this.rootHash)).set(e,t,this);if(this.childNodeSize(n)>this.maxSize){let e=this.chunkHeaderSize,t=Gt(n.entries,this.getEntrySize,this.minSize-e,this.maxSize-e),{level:r}=n,i=t.map((e=>{let t=this.newNodeImpl(e,r);return[t.maxKey(),t.hash]})),a=this.newInternalNodeImpl(i,r+1);this.rootHash=a.hash}else this.rootHash=n.hash}))}del(e){return this.s.withWrite((async()=>{let t=await(await this.getNode(this.rootHash)).del(e,this),n=this.rootHash!==t.hash;return n&&(t.level>0&&1===t.entries.length?this.rootHash=t.entries[0][1]:this.rootHash=t.hash),n}))}clear(){return this.s.withWrite((async()=>{this.N.clear(),this.rootHash=It}))}flush(){let e=(t,n,r)=>{let i=this.N.get(t);if(void 0===i)return t;if(zt(i)){let e=r(i.toChunkData(),[]);return n.push(e),e.hash}let a=[];for(let t of i.entries){let i=t[1],s=e(i,n,r);s!==i&&(t[1]=s),a.push(s)}let s=r(i.toChunkData(),a);return n.push(s),s.hash};return this.s.withWrite((async()=>{let t=this.p;if(this.rootHash===It){let e=t.createChunk(qt,[]);return await t.putChunk(e),e.hash}let n=[],r=e(this.rootHash,n,t.createChunk);return await Promise.all(n.map((e=>t.putChunk(e)))),this.N.clear(),this.rootHash=r,r}))}};function nn(e,t){return rn.apply(this,arguments)}function rn(){return(rn=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t){let n=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.read());try{yield*Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/asyncGeneratorDelegate'");throw e.code="MODULE_NOT_FOUND",e}())(o(t),Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}()))}finally{n()}}))).apply(this,arguments)}async function an(e,t){return _t(t.diff(e))}var sn=class{constructor(e,t){this.s=new qe,this.meta=e,this.r=t}async withMap(e,t){return this.r||await this.s.withWrite((async()=>this.r=this.createBTree(e))),this.s.withRead((()=>t(this.r)))}},on=class extends sn{constructor(e,t){super(e,t)}createBTree(e){return new Kt(e,this.meta.valueHash)}},ln=class extends sn{constructor(e,t){super(e,t)}createBTree(e){return new tn(e,this.meta.valueHash)}flush(){return this.s.withWrite((()=>this.r?this.r.flush():this.meta.valueHash))}clear(){return this.s.withWrite((async()=>{var e;await(null==(e=this.r)?void 0:e.clear())}))}};async function un(e,t,n,r,i,a){var s;try{for(let e of function(e,t,n){let r=function(e,t){function n(e){if(!(e.startsWith("+")||e.startsWith("0")&&1!==e.length))return parseInt(e,10)}if(""===t)return e;if(!t.startsWith("/"))return;let r=t.split("/").slice(1).map((e=>e.replace(/~1/g,"/").replace(/~0/g,"~"))),i=e;for(let e of r){let t;if(Array.isArray(i)){let r=n(e);if(void 0===r)return;t=i[r]}else{if(null===i)return;"object"==typeof i&&(t=i[e])}if(void 0===t)return;i=t}return i}(t,n);if(void 0===r)throw new Error(`No value at path: ${n}`);let i=Array.isArray(r)?r:[r],a=[];for(let t of i){if("string"!=typeof t)throw new Error("Unsupported target type");a.push(cn([t,e]))}return a}(r,i,a))switch(n){case fn.Add:await t.put(e,i);break;case fn.Remove:await t.del(e)}}catch(t){null==(s=e.info)||s.call(e,"Not indexing value",i,":",t)}}function cn(e){let t=e[0],n=e[1];if(t.includes("\0"))throw new Error("Secondary key cannot contain null byte");return"\0"+t+"\0"+n}function dn(e,t){let n=cn([e,t||""]);return void 0===t?n.slice(0,n.length-1):n}function hn(e){if("\0"!==e[0])throw new Error("Invalid version");let t="\0".length,n="\0".length,r=e.indexOf("\0",t);if(-1===r)throw new Error("Invalid formatting");return[e.slice(t,r),e.slice(r+n)]}var pn,fn=((pn=fn||{})[pn.Add=0]="Add",pn[pn.Remove=1]="Remove",pn),mn=class{constructor(e,t,n,r){this.Oe=e,this.Me=t,this.K=n,this.Te=r}[Symbol.asyncIterator](){return this.values()}values(){let e=this.K.shouldDeepClone?it:e=>e;return new yn(this.re((t=>e(t[1]))))}keys(){return new yn(this.re((e=>e[0])))}entries(){let e=this.K.shouldDeepClone?it:e=>e;return new yn(this.re((t=>e(t))))}toArray(){return this.values().toArray()}re(e){return function(e,t,n,r,i){return vn.apply(this,arguments)}(e,this.Oe,this.Me,this.K,this.Te)}},yn=class{constructor(e){this.q=e}next(){return this.q.next()}[Symbol.asyncIterator](){return this.q[Symbol.asyncIterator]()}toArray(){return _t(this.q)}};function vn(){return vn=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t,n,r,i){var a;bt(r);let{limit:s=1/0}=n,{prefix:l=""}=n,u=null==(a=n.start)?void 0:a.exclusive,c=yt(n);var d,h=!1,p=!1;try{for(var f,m=o(t);h=!(f=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(m.next())).done;h=!1){let t=f.value,r=t[0];if(!(c?r[0]:r).startsWith(l))return;if(u)if(u=!0,c){if(wn(r,n.start.key))continue}else if(gn(r,n.start.key))continue;if(yield e(t),0==--s&&!c)return void i(r)}}catch(e){p=!0,d=e}finally{try{h&&null!=m.return&&(yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(m.return()))}finally{if(p)throw d}}})),vn.apply(this,arguments)}function wn(e,t){let[n,r]=vt(t),[i,a]=vt(e);return i===n&&(void 0===r||a===r)}function gn(e,t){return e===t}function bn(e,t){if(yt(e)){let[n,r]=function(e){let{prefix:t,start:n}=e,r=[null!=t?t:"",void 0];if(!n)return r;let i=vt(n.key);return i[0]>r[0]||i[0]===r[0]&&void 0!==i[1]?i:r}(e);return new mn(t(e.indexName,n,r),e,{closed:!1,shouldDeepClone:!1},(e=>{}))}let n=fr(e);return new mn(t(n),e,{closed:!1,shouldDeepClone:!1},(e=>{}))}function _n(e){let{prefix:t,start:n}=e,r="";if(void 0!==t&&(r=dn(t,void 0)),!n)return r;let{key:i}=n,[a,s]=vt(i),o=dn(a,s);return o>r?o:r}var On="main",kn=class{constructor(e){this.chunk=e}get meta(){return this.chunk.data.meta}isLocal(){return 2===this.meta.type}isSnapshot(){return 3===this.meta.type}isIndexChange(){return 1===this.meta.type}get valueHash(){return this.chunk.data.valueHash}get mutationID(){let{meta:e}=this;switch(e.type){case 1:case 3:return e.lastMutationID;case 2:return e.mutationID}}get nextMutationID(){return this.mutationID+1}get indexes(){return this.chunk.data.indexes}};async function Dn(e,t){return(await En(e,t)).filter((e=>e.isLocal()))}async function xn(e,t){let n=await Un(e,t);for(;!n.isSnapshot();){let{meta:e}=n,{basisHash:r}=e;if(null===r)throw new Error(`Commit ${n.chunk.hash} has no basis`);n=await Un(r,t)}return n}function In(e){let t=e.meta;return[t.lastMutationID,t.cookieJSON]}async function En(e,t){let n=await Un(e,t),r=[];for(;!n.isSnapshot();){let{meta:e}=n,{basisHash:i}=e;if(null===i)throw new Error(`Commit ${n.chunk.hash} has no basis`);r.push(n),n=await Un(i,t)}return r.push(n),r}async function Un(e,t){return function(e){return function(e){let{data:t}=e;jn(t);let n=new Set;for(let e of t.indexes){let{name:t}=e.definition;if(n.has(t))throw new Error(`Duplicate index ${t}`);n.add(t)}}(e),new kn(e)}(await t.mustGetChunk(e))}function Nn(e,t,n,r,i){return{meta:{type:3,basisHash:e,lastMutationID:t,cookieJSON:n},valueHash:r,indexes:i}}function Cn(e,t){return new kn(e(t,Sn(t)))}function Sn(e){let t=[e.valueHash],{meta:n}=e;switch(n.type){case 1:case 2:n.basisHash&&t.push(n.basisHash)}for(let n of e.indexes)t.push(n.valueHash);return t}function jn(e){0}var Mn=class{constructor(e,t,n){this.shouldDeepClone=!1,this.p=e,this.map=t,this.indexes=n}has(e){return this.map.has(e)}get(e){return this.map.get(e)}isEmpty(){return this.map.isEmpty()}async getMapForIndex(e){let t=this.indexes.get(e);if(void 0===t)throw new Error(`Unknown index name: ${e}`);return t.withMap(this.p,(e=>e))}get closed(){return this.p.closed}close(){this.p.close()}};function Tn(e){return{type:0,name:e}}function Pn(e){return{type:1,hash:e}}function An(e){return async function(e,t){let[,n,r]=await async function(e,t){let[n,r]=await Ln(e,t);return[n,r,new Kt(t,r.valueHash)]}(e,t),i=Fn(n);return new Mn(t,r,i)}(Tn(On),e)}async function Ln(e,t){let n;switch(e.type){case 1:n=e.hash;break;case 0:{let r=await t.getHead(e.name);if(void 0===r)throw new Error(`Unknown head: ${e.name}`);n=r;break}}return[n,await Un(n,t)]}async function Rn(e,t){let[n,r]=await Ln(e,t);return[n,r,new tn(t,r.valueHash)]}function Fn(e){let t=new Map;for(let n of e.indexes)t.set(n.definition.name,new on(n,void 0));return t}function Hn(e){let t;return()=>(void 0===t&&(t=e()),t)}var Zn=class extends Mn{constructor(e,t,n,r,i){super(e,t,i),this.shouldDeepClone=!0,this.i=e,this.m=n,this.y=r}static async newLocal(e,t,n,r,i,a){let[,s,o]=await Rn(e,i),l=s.nextMutationID,u=zn(s);return new Zn(i,o,s,{type:1,mutatorName:t,mutatorArgs:n,mutationID:l,originalHash:r,timestamp:a},u)}static async newSnapshot(e,t,n,r,i){let[,a,s]=await Rn(e,r);return new Zn(r,s,a,{type:2,lastMutationID:t,cookie:n},i)}static async newIndexChange(e,t){let[,n,r]=await Rn(e,t),i=n.mutationID,a=zn(n);return new Zn(t,r,n,{type:0,lastMutationID:i},a)}isRebase(){return 1===this.y.type&&null!==this.y.originalHash}async put(e,t,n){if(0===this.y.type)throw new Error("Not allowed");let r=Hn((()=>this.map.get(t)));await $n(e,this.indexes,this.i,t,r,n),await this.map.put(t,n)}async del(e,t){if(0===this.y.type)throw new Error("Not allowed");let n=Hn((()=>this.map.get(t)));return void 0!==n&&await $n(e,this.indexes,this.i,t,n,void 0),this.map.del(t)}async clear(){if(0===this.y.type)throw new Error("Not allowed");await this.map.clear();let e=[];for(let t of this.indexes.values())e.push(t.clear());await Promise.all(e)}async createIndex(e,t,n,r){if(1===this.y.type)throw new Error("Not allowed");let i={name:t,keyPrefix:n,jsonPointer:r},a=this.indexes.get(t);if(a){let e=a.meta.definition;if(e.name===t&&e.keyPrefix===n&&e.jsonPointer===r)return;throw new Error("Index exists with different definition")}let s=new tn(this.i);var l,u=!1,c=!1;try{for(var d,h=o(this.map.scan(n));u=!(d=await h.next()).done;u=!1){let t=d.value;await un(e,s,0,t[0],t[1],r)}}catch(e){c=!0,l=e}finally{try{u&&null!=h.return&&await h.return()}finally{if(c)throw l}}this.indexes.set(t,new ln({definition:i,valueHash:It},s))}async dropIndex(e){if(1===this.y.type)throw new Error("Not allowed");if(!this.indexes.delete(e))throw new Error(`No such index: ${e}`)}async commit(e){let[t]=await this.commitWithDiffs(e,!1);return t}async commitWithDiffs(e,t){let n=await this.map.flush(),r=[];if(t&&this.m){let e=new Kt(this.i,this.m.valueHash);r=await an(e,this.map)}let i,a=[],s=new Map;r.length>0&&s.set("",r),i=t&&this.m?Fn(this.m):new Map;for(let[e,n]of this.indexes){let r=await n.flush();if(t){let t=i.get(e),r=await n.withMap(this.i,(async e=>t?t.withMap(this.i,(t=>an(t,e))):en(e,"add")));r.length>0&&s.set(e,r)}let o={definition:n.meta.definition,valueHash:r};a.push(o)}if(t)for(let[e,t]of i)if(!this.indexes.has(e)){let n=await t.withMap(this.i,(e=>en(e,"del")));n.length>0&&s.set(e,n)}let o,l=this.m?this.m.chunk.hash:null,u=this.y;switch(u.type){case 1:{let{mutationID:e,mutatorName:t,mutatorArgs:r,originalHash:i,timestamp:s}=u;o=function(e,t,n,r,i,a,s,o,l){return Cn(e,{meta:{type:2,basisHash:t,mutationID:n,mutatorName:r,mutatorArgsJSON:i,originalHash:a,timestamp:l},valueHash:s,indexes:o})}(this.i.createChunk,l,e,t,r,i,n,a,s);break}case 2:{let{lastMutationID:e,cookie:t}=u;o=function(e,t,n,r,i,a){return Cn(e,Nn(t,n,r,i,a))}(this.i.createChunk,l,e,t,n,a);break}case 0:{let{lastMutationID:e}=u;if(void 0!==this.m){if(this.m.mutationID!==e)throw new Error("Index change must not change mutationID");if(this.m.valueHash!==n)throw new Error("Index change must not change valueHash")}o=function(e,t,n,r,i){return Cn(e,{meta:{type:1,basisHash:t,lastMutationID:n},valueHash:r,indexes:i})}(this.i.createChunk,l,e,n,a);break}}return await Promise.all([this.i.putChunk(o.chunk),this.i.setHead(e,o.chunk.hash)]),await this.i.commit(),[o.chunk.hash,s]}close(){this.i.close()}};async function $n(e,t,n,r,i,a){let s=[];for(let o of t.values())if(r.startsWith(o.meta.definition.keyPrefix)){let t=await i();await o.withMap(n,(async n=>{void 0!==t&&s.push(un(e,n,1,r,t,o.meta.definition.jsonPointer)),void 0!==a&&s.push(un(e,n,0,r,a,o.meta.definition.jsonPointer))}))}await Promise.all(s)}function zn(e){let t=new Map;for(let n of e.indexes)t.set(n.definition.name,new ln(n,void 0));return t}var Gn=class extends Error{constructor(e){super(`Chunk not found ${e}`),this.name="ChunkNotFoundError",this.hash=e}};async function qn(e,t){let n=await e.getChunk(t);if(n)return n;throw new Gn(t)}var Vn=class{constructor(){this.Ve=new Map,this.Ae=new Map}get mappings(){return this.Ae}Le(e,t){let n=this.Ve.get(e);if(void 0!==n)return n;let r=t();return this.Ve.set(e,r),r}_e(e,t=1){return this.Le(e,(()=>this.transformCommit(e,t)))}async transformCommit(e,t=1){if(this.shouldSkip(e))return e;let n=await this.getChunk(e);if(!n){if(0===t)return e;throw new Error(`Chunk ${e} not found`)}let{data:r}=n;jn();let i=await this.Dt(r);return this.Fe(e,i,r,Sn)}shouldSkip(e){return!1}shouldForceWrite(e){return!1}async mustGetChunk(e){return qn(this,e)}async Fe(e,t,n,r){if(t!==n||this.shouldForceWrite(e)){let n=await this.writeChunk(e,t,r);return this.Ae.set(e,n),n}return e}async Dt(e){let[t,n,r]=await Promise.all([this.kt(e.meta),this.Pt(e.valueHash),this.Et(e.indexes)]);return t===e.meta&&n===e.valueHash&&r===e.indexes?e:{meta:t,valueHash:n,indexes:r}}kt(e){switch(e.type){case 1:return this.Ot(e);case 2:return this.Mt(e);case 3:return this.Tt(e)}}ae(e,t){return null!==e?this._e(e,t):null}async Tt(e){let t=await this.ae(e.basisHash,0);return t===e.basisHash?e:{basisHash:t,type:e.type,lastMutationID:e.lastMutationID,cookieJSON:e.cookieJSON}}async Mt(e){let t=this.ae(e.basisHash,1),n=e.originalHash&&this._e(e.originalHash,0),r=await t,i=await n;return r===e.basisHash&&i===e.originalHash?e:{basisHash:r,type:e.type,mutationID:e.mutationID,mutatorName:e.mutatorName,mutatorArgsJSON:e.mutatorArgsJSON,originalHash:i,timestamp:e.timestamp}}async Ot(e){let t=await this.ae(e.basisHash,1);return t===e.basisHash?e:{basisHash:t,type:e.type,lastMutationID:e.lastMutationID}}Pt(e){return this.oe(e)}oe(e){return this.Le(e,(()=>this.transformBTreeNode(e)))}async transformBTreeNode(e){if(this.shouldSkip(e))return e;let{data:t}=await this.mustGetChunk(e),n=await this.transformBTreeNodeData(t);return this.Fe(e,n,t,jt)}async transformBTreeNodeData(e){let t,n=e[0],r=e[1];return t=At(e)?await this.Vt(r):await this.At(r),t===r?e:[n,t]}async transformBTreeDataEntry(e){return e}async At(e){return this.ie(e,(e=>this.transformBTreeDataEntry(e)))}async transformBTreeInternalEntry(e){let t=await this.oe(e[1]);return t===e[1]?e:[e[0],t]}async Vt(e){return this.ie(e,(e=>this.transformBTreeInternalEntry(e)))}async ie(e,t){let n=await Promise.all(e.map(t));for(let t=0;t<n.length;t++)if(e[t]!==n[t])return n;return e}Et(e){return this.ie(e,(e=>this.transformIndexRecord(e)))}async transformIndexRecord(e){let t=await this.oe(e.valueHash);return t===e.valueHash?e:{definition:e.definition,valueHash:t}}},Wn=class extends Vn{constructor(e){super(),this.dagWrite=e}getChunk(e){return this.dagWrite.getChunk(e)}async writeChunk(e,t,n){let{dagWrite:r}=this,i=r.createChunk(t,n(t));return await r.putChunk(i),i.hash}};function Kn(){let e=new Uint8Array(36);return crypto.getRandomValues(e),function(e){return Bn.map(((t,n)=>{switch(t){case 0:return(15&e[n]).toString(16);case 1:return(8+(3&e[n])).toString(16);case 3:return"4";case 2:return"-"}})).join("")}(e)}var Bn=[0,0,0,0,0,0,0,0,2,0,0,0,0,2,3,0,0,0,2,1,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0];function Jn(e){Ye(e),Be(e.httpStatusCode),Ke(e.errorMessage)}function Yn(e,t,n,r,i){let a={headers:{"Content-type":"application/json",Authorization:r,"X-Replicache-RequestID":i},body:JSON.stringify(n),method:"POST"};return e(new Request(t,a))}var Qn="sync";function Xn(e){return e instanceof Error?e:new Error(String(e))}async function er(e,t,n,r,i,a,s,o=!0){var l,u;let{pullURL:c,pullAuth:d,schemaVersion:h}=n,p=await a.withRead((async e=>{let t=await e.getHead(On);if(!t)throw new Error("Internal no main head found");return await xn(t,e)})),[,f]=In(p),m={profileID:e,clientID:t,cookie:f,lastMutationID:p.mutationID,pullVersion:0,schemaVersion:h};null==(l=s.debug)||l.call(s,"Starting pull...");let y=Date.now(),{response:v,httpRequestInfo:w}=await async function(e,t,n,r,i){try{let a=await Yn(e,t,n,r,i);return function(e){if("object"!=typeof e||null===e)throw new Error("Expected result to be an object");void 0!==e.response&&ht(e.response),Jn(e.httpRequestInfo)}(a),a}catch(e){throw new mt(Xn(e))}}(r,c,m,d,i);if(null==(u=s.debug)||u.call(s,`...Pull ${v?"complete":"failed"} in `,Date.now()-y,"ms"),!v)return{httpRequestInfo:w,syncHead:It};if(!o||dt(v))return{httpRequestInfo:w,pullResponse:v,syncHead:It};let g=await tr(s,a,f,v);if(null===g)throw new Error("Overlapping sync JsLogInfo");return{httpRequestInfo:w,pullResponse:v,syncHead:g}}async function tr(e,t,n,r){return await t.withWrite((async t=>{var i,a;let s=t,l=await s.getHead(On);if(void 0===l)throw new Error("Main head disappeared");let u=await xn(l,s),[c,d]=In(u);if(!rt(n,d))return null;if(r.lastMutationID<c)throw new Error(`Received lastMutationID ${r.lastMutationID} is < than last snapshot lastMutationID ${c}; ignoring client view`);if(0===r.patch.length&&r.lastMutationID===c&&(null!=(i=r.cookie)?i:null)===d)return It;let h=(await En(l,s)).find((e=>e.mutationID<=r.lastMutationID));if(!h)throw new Error("Internal invalid chain");let p=await Zn.newSnapshot(Pn(u.chunk.hash),r.lastMutationID,null!=(a=r.cookie)?a:null,t,zn(h));await async function(e,t,n){for(let r of n)switch(r.op){case"put":await t.put(e,r.key,r.value);break;case"del":await t.del(e,r.key);break;case"clear":await t.clear()}}(e,p,r.patch);let f=new Kt(s,h.valueHash);var m,y=!1,v=!1;try{for(var w,g=o(p.map.diff(f));y=!(w=await g.next()).done;y=!1){let n=w.value;await $n(e,p.indexes,t,n.key,(()=>Promise.resolve(n.oldValue)),n.newValue)}}catch(e){v=!0,m=e}finally{try{y&&null!=g.return&&await g.return()}finally{if(v)throw m}}return await p.commit(Qn)}))}async function nr(e,t,n){return await e.withWrite((async e=>{var r;let i=e,a=await i.getHead(Qn);if(void 0===a)throw new Error("Missing sync head");if(a!==n)throw null==(r=t.error)||r.call(t,"maybeEndPull, Wrong sync head. Expecting:",n,"got:",a),new Error("Wrong sync head");let s=await xn(a,i),o=await i.getHead(On);if(void 0===o)throw new Error("Missing main head");let l=await xn(o,i),{meta:u}=s,c=u.basisHash;if(null===s)throw new Error("Sync snapshot with no basis");if(c!==l.chunk.hash)throw new Error("Overlapping syncs");let d=await Dn(o,i),h=await Un(a,i);d=d.filter((e=>e.mutationID>h.mutationID)),d.reverse();let p=new Map;if(d.length>0){let e=[];for(let t of d){let n,r,i;if(!t.isLocal())throw new Error("pending mutation is not local");{let e=t.meta;n=e.mutatorName,r=e.mutatorArgsJSON,i=e.timestamp}e.push({id:t.mutationID,name:n,args:it(r),original:t.chunk.hash,timestamp:i})}return{syncHead:a,replayMutations:e,diffs:p}}let f=await Un(o,i),m=new Kt(i,f.valueHash),y=new Kt(i,h.valueHash),v=await an(m,y);if(v.length>0&&p.set("",v),await async function(e,t,n,r){let i=Fn(e),a=Fn(t);for(let[e,t]of i)await t.withMap(n,(async t=>{let i=a.get(e);if(void 0!==i){let s=await i.withMap(n,(async e=>an(t,e)));a.delete(e),s.length>0&&r.set(e,s)}else{let n=await en(t,"del");n.length>0&&r.set(e,n)}}));for(let[e,t]of a)await t.withMap(n,(async t=>{let n=await en(t,"add");n.length>0&&r.set(e,n)}))}(f,h,i,p),await Promise.all([e.setHead(On,a),e.removeHead(Qn)]),await e.commit(),t.debug){let[e,n]=In(l),[r,i]=In(s);t.debug("Successfully pulled new snapshot w/last_mutation_id:",r,"(prev:",e,"), cookie: ",i,"(prev:",n,"), sync head hash:",a,", main head hash:",o,", value_hash:",h.valueHash,"(prev:",l.valueHash)}return{syncHead:a,replayMutations:[],diffs:p}}))}function rr(e){return{id:e.mutationID,name:e.mutatorName,args:e.mutatorArgsJSON,timestamp:e.timestamp}}async function ir(e,t,n,r,i,a,s,o,l){var u,c;let d,h=await t.withRead((async e=>{let t=await e.getHead(On);if(!t)throw new Error("Internal no main head");return await Dn(t,e)}));if(h.reverse(),h.length>0){let t=[];for(let e of h){if(!e.isLocal())throw new Error("Internal non local pending commit");t.push(rr(e.meta))}let p={profileID:r,clientID:i,mutations:t,pushVersion:0,schemaVersion:l};null==(u=n.debug)||u.call(n,"Starting push...");let f=Date.now();d=await async function(e,t,n,r,i){try{let a=await Yn(e,t,n,r,i);return Jn(a),a}catch(e){throw new ct(Xn(e))}}(a,s,p,o,e),null==(c=n.debug)||c.call(n,"...Push complete in ",Date.now()-f,"ms")}return d}var ar="";var sr=new Map;function or(e){let t=sr.get(e);return t?(t++,sr.set(e,t)):(sr.set(e,0),t=0),`${e}-${function(){if(""===ar){let e=new Uint8Array(4);crypto.getRandomValues(e),ar=Array.from(e,(e=>e.toString(16))).join("")}return ar}()}-${t}`}var lr=0,ur=class{constructor(e,t,n,r="openReadTransaction"){this.clientID=e,this.dbtx=t,this.e=n.addContext(r).addContext("txid",lr++)}async get(e){return bt(this.dbtx),this.dbtx.get(e)}async has(e){return bt(this.dbtx),this.dbtx.has(e)}async isEmpty(){return bt(this.dbtx),this.dbtx.isEmpty()}scan(e){return dr(e,this.dbtx,cr)}};function cr(e){}function dr(e,t,n){let r=function(e,t){return t&&yt(t)?function(e,t){return mr.apply(this,arguments)}(e,t):e.map.scan(fr(t))}(t,e);return function(e,t,n,r){return new mn(e,t,n,r)}(r,null!=e?e:{},t,n)}var hr=class extends ur{constructor(e,t,n,r="openWriteTransaction"){super(e,t,n,r)}async put(e,t){bt(this.dbtx),await this.dbtx.put(this.e,e,it(t))}async del(e){return bt(this.dbtx),await this.dbtx.del(this.e,e)}async commit(e){let t=this.dbtx;bt(t);let n=t.isRebase()?Qn:On;return await t.commitWithDiffs(n,e)}},pr=class extends hr{constructor(e,t,n){super(e,t,n,"openIndexTransaction")}async createIndex(e){var t;bt(this.dbtx),await this.dbtx.createIndex(this.e,e.name,null!=(t=e.prefix)?t:"",e.jsonPointer)}async dropIndex(e){bt(this.dbtx),await this.dbtx.dropIndex(e)}};function fr(e){if(!e)return"";let{prefix:t="",start:n}=e;return n&&n.key>t?n.key:t}function mr(){return mr=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t){let n=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(e.getMapForIndex(t.indexName));var r,i=!1,a=!1;try{for(var s,l=o(n.scan(_n(t)));i=!(s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(l.next())).done;i=!1){let e=s.value;yield[hn(e[0]),e[1]]}}catch(e){a=!0,r=e}finally{try{i&&null!=l.return&&(yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(l.return()))}finally{if(a)throw r}}})),mr.apply(this,arguments)}var yr=class extends Error{constructor(e){super(e),this.name="AbortError"}};function vr(e,t){return 0===e?Promise.resolve():new Promise(((n,r)=>{let i=setTimeout((()=>{n()}),e);t&&t.addEventListener("abort",(()=>{i&&clearTimeout(i),r(new yr("Aborted"))}))}))}var wr=30,gr=6e4,br=class{constructor(e){this.$=ze(),this.t=!1,this.G=void 0,this.de=e,this.run()}close(){this.t=!0}send(){var e,t;null==(t=(e=this.de).debug)||t.call(e,"send"),this.$.resolve()}async run(){let e,t=[],n=ze(),r=0,i=this.de,{debug:a}=i,s=0;for(null==a||a("Starting connection loop");!this.t;){null==a||a(Or(t)?"Last request failed. Trying again":"Waiting for a send");let o=[this.$.promise],l=i.watchdogTimer;if(null!==l&&o.push(vr(l)),await Promise.race(o),this.t||(null!=a&&a("Waiting for debounce"),await vr(i.debounceDelay),this.t))break;if(null!=a&&a("debounced"),this.$=ze(),r>=i.maxConnections){if(null!=a&&a("Too many request in flight. Waiting until one finishes..."),await this.Lt(),this.t)break;null==a||a("...finished")}r>0||Or(t)?(s=_r(s,i,t),null==a||a(Or(t)?"Last connection errored. Sleeping for":"More than one outstanding connection ("+r+"). Sleeping for",s,"ms")):s=0;let u=Math.min(i.maxDelayMs,Math.max(i.minDelayMs,s));if(void 0!==e){let t=Date.now()-e;if(u>t&&(await Promise.race([vr(u-t),n.promise]),this.t))break}r++,(async()=>{let s,o=Date.now();try{e=o,null!=a&&a("Sending request"),s=await i.invokeSend(),null==a||a("Send returned",s)}catch(e){null!=a&&a("Send failed",e),s=!1}this.t?null==a||a("Closed after invokeSend"):(null!=a&&a("Request done",{duration:Date.now()-o,ok:s}),t.push({duration:Date.now()-o,ok:s}),kr(t)&&(n.resolve(),n=ze()),r--,this._t(),s||this.$.resolve())})()}}_t(){if(this.G){let e=this.G;this.G=void 0,e()}}Lt(){let{promise:e,resolve:t}=ze();return this.G=t,e}};function _r(e,t,n){let{length:r}=n;if(0===r)return e;let{ok:i}=n[n.length-1],{maxConnections:a,minDelayMs:s}=t;if(!i)return 0===e?s:2*e;if(r>1){let e=n[n.length-2];for(;n.length>9;)n.shift();if(i&&!e.ok)return s}return function(e){e.sort();let{length:t}=e,n=t>>1;return t%2==1?e[n]:(e[n-1]+e[n])/2}(n.filter((({ok:e})=>e)).map((({duration:e})=>e)))/a|0}function Or(e){return e.length>0&&!e[e.length-1].ok}function kr(e){return e.length>1&&!e[e.length-2].ok&&e[e.length-1].ok}var Dr=class{constructor(e,t,n){this.maxConnections=1,this.rep=e,this.invokeSend=t,this.logger=n}get maxDelayMs(){return this.rep.requestOptions.maxDelayMs}get minDelayMs(){return this.rep.requestOptions.minDelayMs}get debug(){return this.logger.debug}},xr=class extends Dr{constructor(){super(...arguments),this.debounceDelay=0}get watchdogTimer(){return this.rep.pullInterval}},Ir=class extends Dr{constructor(){super(...arguments),this.watchdogTimer=null}get debounceDelay(){return this.rep.pushDelay}},Er=new Set;function Ur(e,t,n,r){if(""===n)for(let t of r)if(e.has(t.key))return!0;for(let e of t)if(Nr(e,n,r))return!0;return!1}function Nr(e,t,n){for(let r of n)if(Cr(e,t,r.key))return!0;return!1}function Cr(e,t,n){let{indexName:r="",limit:i,prefix:a,startKey:s,startExclusive:o,startSecondaryKey:l}=e.options;if(t!==r)return!1;if(!r)return!(void 0!==i&&i<=0)&&(!a&&!s||!(a&&(!n.startsWith(a)||Sr(e,n))||s&&(o&&n<=s||n<s||Sr(e,n))));if(!a&&!s&&!l)return!0;let[u,c]=hn(n);return!(a&&!u.startsWith(a)||l&&(o&&u<=l||u<l)||s&&(o&&c<=s||c<s))}function Sr(e,t){let{inclusiveLimitKey:n}=e;return void 0!==e.options.limit&&void 0!==n&&t>n}var jr=Symbol(),Mr={durability:"relaxed"},Tr="chunks",Pr=class{constructor(e){this.t=!1,this.E=function(e){let t=indexedDB.open(e);t.onupgradeneeded=()=>{t.result.createObjectStore(Tr)};let n=Hr(t);return n.then((e=>{e.onversionchange=()=>e.close()})),n}(e)}async read(){return Rr(await this.E)}async withRead(e){let t=Rr(await this.E);try{return await e(t)}finally{t.release()}}async write(){return Lr(await this.E)}async withWrite(e){let t=Lr(await this.E);try{return await e(t)}finally{t.release()}}async close(){(await this.E).close(),this.t=!0}get closed(){return this.t}},Ar=class{constructor(e){this.t=!1,this.n=e}async has(e){return await Hr(Fr(this.n).count(e))>0}get(e){return Hr(Fr(this.n).get(e))}release(){this.t=!0}get closed(){return this.t}};function Lr(e){let t=e.transaction(Tr,"readwrite",Mr);return new class extends class{constructor(e){this.f=new Map,this._=e}async has(e){switch(this.f.get(e)){case void 0:return this._.has(e);case jr:return!1;default:return!0}}async get(e){let t=this.f.get(e);switch(t){case jr:return;case void 0:return this._.get(e);default:return t}}async put(e,t){this.f.set(e,t)}async del(e){this.f.set(e,jr)}release(){this._.release()}get closed(){return this._.closed}}{constructor(e){super(new Ar(e)),this.ze=0,this.t=!1,this.n=e,this.Ge=this.Bt()}async Bt(){let e=this.n,t=new Promise(((t,n)=>{e.onabort=()=>t(2),e.oncomplete=()=>t(1),e.onerror=()=>n(e.error)}));this.ze=await t}async commit(){if(0===this.f.size)return;let e=Fr(this.n);if(this.f.forEach(((t,n)=>{t===jr?e.delete(n):e.put(t,n)})),await this.Ge,2===this.ze)throw new Error("Transaction aborted")}release(){this.t=!0}get closed(){return this.t}}(t)}function Rr(e){let t=e.transaction(Tr,"readonly");return new Ar(t)}function Fr(e){return e.objectStore(Tr)}function Hr(e){return new Promise(((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)}))}function Zr(e){if(!Array.isArray(e))throw new Error("Meta must be an array");for(let t of e)Ke(t)}function $r(e,t,n){return zr(n(e),e,t)}function zr(e,t,n){return We(!n.includes(e),"Chunk cannot reference itself"),new class{constructor(e,t,n){this.hash=e,this.data=t,this.meta=n}}(e,t,n)}async function Gr(e,t){return zr(await xt(e),e,t)}function qr(e){throw new Error("unexpected call to compute chunk hash")}function Vr(e){return`c/${e}/d`}function Wr(e){return`c/${e}/m`}function Kr(e){return`c/${e}/r`}function Br(e){return`h/${e}`}async function Jr(e,t,n){let r=[],i=[];for(let t of e)t.old&&i.push(t.old),t.new&&r.push(t.new);let a=new Map,s=new Map;for(let e of r)await Yr(e,1,a,s,n);for(let e of i)await Yr(e,-1,a,s,n);return await Promise.all(Array.from(t.values(),(e=>Qr(e,a,s,n)))),a}async function Yr(e,t,n,r,i){if(await Qr(e,n,r,i),function(e,t,n){let r=n.get(e);return Be(r),n.set(e,r+t),0===r&&1===t||1===r&&-1===t}(e,t,n)){let a=await i.getRefs(e);if(void 0!==a){let e=a.map((e=>Yr(e,t,n,r,i)));await Promise.all(e)}}}function Qr(e,t,n,r){let i=n.get(e);return void 0===i&&(i=(async()=>{let n=await r.getRefCount(e)||0;return t.set(e,n),n})(),n.set(e,i)),i}var Xr=class{constructor(e,t,n){this.O=e,this.u=t,this.g=n}async read(){return new ei(await this.O.read(),this.g)}async withRead(e){return this.O.withRead((t=>e(new ei(t,this.g))))}async write(){return new ti(await this.O.write(),this.u,this.g)}async withWrite(e){return this.O.withWrite((t=>e(new ti(t,this.u,this.g))))}async close(){await this.O.close()}},ei=class{constructor(e,t){this.n=e,this.assertValidHash=t}async hasChunk(e){return await this.n.has(Vr(e))}async getChunk(e){let t=await this.n.get(Vr(e));if(void 0===t)return;let n,r=await this.n.get(Wr(e));return void 0!==r?(Zr(r),n=r):n=[],zr(e,t,n)}async mustGetChunk(e){return qn(this,e)}async getHead(e){let t=await this.n.get(Br(e));if(void 0!==t)return Ct(t),t}close(){this.n.release()}get closed(){return this.n.closed}},ti=class extends ei{constructor(e,t,n){super(e,n),this.le=new Set,this.ce=new Map,this.createChunk=(e,t)=>$r(e,t,this.u),this.u=t}get kvWrite(){return this.n}async putChunk(e){let{hash:t,data:n,meta:r}=e;this.assertValidHash(t);let i,a=Vr(t),s=this.n.put(a,n);if(r.length>0){for(let e of r)this.assertValidHash(e);i=this.n.put(Wr(t),r)}this.le.add(t),await s,await i}setHead(e,t){return this.F(e,t)}removeHead(e){return this.F(e,void 0)}async F(e,t){let n,r=await this.getHead(e),i=Br(e);n=void 0===t?this.n.del(i):this.n.put(i,t);let a=this.ce.get(e);void 0===a?this.ce.set(e,{new:t,old:r}):a.new=t,await n}async commit(){let e=await Jr(this.ce.values(),this.le,this);await this.Jt(e),await this.n.commit()}async getRefCount(e){let t=await this.n.get(Kr(e));if(void 0!==t){if(Be(t),t<0||t>65535||t!==(0|t))throw new Error(`Invalid ref count ${t}. We expect the value to be a Uint16`);return t}}async getRefs(e){let t=await this.n.get(Wr(e));return void 0!==t&&Zr(t),t}async Jt(e){let t=[];e.forEach(((e,n)=>{if(0===e)t.push(this.Wt(n));else{let r=Kr(n);t.push(this.n.put(r,e))}})),await Promise.all(t)}async Wt(e){await Promise.all([this.n.del(Vr(e)),this.n.del(Wr(e)),this.n.del(Kr(e))]),this.le.delete(e)}close(){this.n.release()}},ni=class{constructor(e,t,n,r,i=st){this.s=new qe,this.v=new Map,this.S=new Map,this.o=new Map,this.w=new ai(t,i,this.o),this.M=e,this.u=n,this.g=r}async read(){let e=await this.s.read();return new ri(this.v,this.S,this.w,this.M,e,this.g)}async withRead(e){let t=await this.read();try{return await e(t)}finally{t.close()}}async write(){let e=await this.s.write();return new ii(this.v,this.S,this.w,this.M,this.o,e,this.u,this.g)}async withWrite(e){let t=await this.write();try{return await e(t)}finally{t.close()}}async close(){}get refCountsSnapshot(){return new Map(this.o)}},ri=class{constructor(e,t,n,r,i,a){this.v=new Map,this.S=new Map,this.z=void 0,this.t=!1,this.v=e,this.S=t,this.w=n,this.M=r,this.R=i,this.assertValidHash=a}async hasChunk(e){return void 0!==await this.getChunk(e)}async getChunk(e){if(Ut(e))return this.S.get(e);let t=this.w.get(e);return void 0===t&&(t=await(await this.Ut()).getChunk(e),void 0!==t&&this.w.put(t)),t}async mustGetChunk(e){return qn(this,e)}async getHead(e){return this.v.get(e)}close(){var e;this.t||(this.R(),null==(e=this.z)||e.then((e=>e.close())),this.t=!0)}get closed(){return this.t}async Ut(){return this.z||(this.z=this.M.read()),this.z}},ii=class extends ri{constructor(e,t,n,r,i,a,s,o){super(e,t,n,r,a,o),this.T=new Map,this.I=new Map,this.createChunk=(e,t)=>$r(e,t,this.u),this.o=i,this.u=s}async putChunk(e){let{hash:t,meta:n}=e;if(this.assertValidHash(t),n.length>0)for(let e of n)this.assertValidHash(e);this.I.set(t,e)}async setHead(e,t){await this.F(e,t)}async removeHead(e){await this.F(e,void 0)}async F(e,t){let n=await this.getHead(e),r=this.T.get(e);void 0===r?this.T.set(e,{new:t,old:n}):r.new=t}async hasChunk(e){return this.I.has(e)||super.hasChunk(e)}async getChunk(e){return this.I.get(e)||super.getChunk(e)}async getHead(e){let t=this.T.get(e);return t?t.new:super.getHead(e)}async commit(){let e=await Jr(this.T.values(),new Set(this.I.keys()),this),t=[],n=[];e.forEach(((e,t)=>{0===e?(this.o.delete(t),this.I.delete(t),Ut(t)?this.S.delete(t):n.push(t)):this.o.set(t,e)})),this.I.forEach(((e,n)=>{Ut(n)?this.S.set(n,e):t.push(e)})),this.T.forEach(((e,t)=>{e.new?this.v.set(t,e.new):this.v.delete(t)})),this.w.updateForCommit(t,n),this.I.clear(),this.T.clear(),this.close()}async getRefCount(e){return this.o.get(e)}async getRefs(e){var t,n;let r=this.I.get(e);return r?r.meta:Ut(e)?null==(t=this.S.get(e))?void 0:t.meta:null==(n=this.w.getWithoutUpdatingLRU(e))?void 0:n.meta}},ai=class{constructor(e,t,n){this.a=new Map,this.V=0,this.B=e,this.he=t,this.o=n}get(e){let t=this.a.get(e);return t&&(this.a.delete(e),this.a.set(e,t)),null==t?void 0:t.chunk}getWithoutUpdatingLRU(e){var t;return null==(t=this.a.get(e))?void 0:t.chunk}put(e){let{hash:t}=e,n=this.a.get(t);if(n)return this.a.delete(t),void this.a.set(t,n);let r=this.o.get(t);if(void 0===r||r<1)return;let i=this.he(e.data);i>this.B||(this.V+=i,this.a.set(t,{chunk:e,size:i}),e.meta.forEach((e=>{this.o.set(e,(this.o.get(e)||0)+1)})),this.Ye())}Ye(){if(!(this.V<=this.B))for(let e of this.a){if(this.V<=this.B)break;this.delete(e[1])}}delete(e){let{hash:t}=e.chunk;this.V-=e.size,this.a.delete(t),e.chunk.meta.forEach((t=>{let n=this.o.get(t);et(n),We(n>0);let r=n-1;if(0===r){this.o.delete(t);let n=this.a.get(t);n&&(We(e.chunk.hash!==t,"Found a chunk that references itself"),this.delete(n))}else this.o.set(t,r)}))}updateForCommit(e,t){let n=[];for(let t of e){let{hash:e}=t,r=this.a.get(e);if(r)this.a.delete(e),this.a.set(e,r);else{let r=this.he(t.data);this.V+=r;let i={chunk:t,size:r};this.a.set(e,i),r>this.B&&n.push(i)}}for(let e of t){let t=this.a.get(e);t&&(this.V-=t.size,this.a.delete(e))}for(let e of n)this.delete(e);this.Ye()}},si="clients";function oi(e){Ye(e);let{heartbeatTimestampMs:t,headHash:n}=e;Be(t),Ct(n)}async function li(e){return ui(await e.getHead(si),e)}async function ui(e,t){if(!e)return new Map;let n=await t.getChunk(e);return function(e){Ye(e);let t=new Map;for(let n in e)if(nt(e,n)){let r=e[n];void 0!==r&&(oi(r),t.set(n,r))}return t}(null==n?void 0:n.data)}var ci=class extends Error{constructor(e){super(`Client state not found, id: ${e}`),this.name="ClientStateNotFoundError",this.id=e}};async function di(e,t){return!!await async function(e,t){return(await li(t)).get(e)}(e,t)}function hi(e){let t=function(e){return Object.fromEntries(e)}(e);return xt(t)}var pi=Symbol();async function fi(e,t){let[n,r]=await t.withRead((async e=>{let t=await e.getHead(si);return[await ui(t,e),t]}));return mi(e,n,r,t)}async function mi(e,t,n,r){let i=await e(t);if(i===pi)return t;let{clients:a,chunksToPut:s}=i,o=await hi(a),l=await r.withWrite((async e=>{let t=await e.getHead(si);if(t!==n)return{updateApplied:!1,clients:await ui(t,e),clientsHash:t};let r=function(e,t){return e.forEach((e=>{t.assertValidHash(e.headHash)})),Object.fromEntries(e)}(a,e),i=Array.from(a.values(),(e=>e.headHash)),l=zr(o,r,i),u=[];if(s)for(let t of s)u.push(e.putChunk(t));return await Promise.all([...u,e.putChunk(l),e.setHead(si,l.hash)]),await e.commit(),{updateApplied:!0,clients:a,clientsHash:o}}));return l.updateApplied?l.clients:mi(e,l.clients,l.clientsHash,r)}var yi=class extends Vn{constructor(e,t){super(),this.Ze=new Map,this.C=e,this.Xe=t}get fixedChunks(){return this.Ze}shouldSkip(e){return!this.C.has(e)}shouldForceWrite(e){return this.C.has(e)}async getChunk(e){let t=this.C.get(e);return We(void 0!==t),t}async writeChunk(e,t,n){let r=await this.Xe(t),i=zr(r,t,n(t));return this.Ze.set(r,i),r}},vi=class extends Wn{constructor(e,t){super(e),this.Y=t}shouldSkip(e){return!Ut(e)&&!this.Y.has(e)}shouldForceWrite(e){return this.Y.has(e)}async writeChunk(e,t,n){let r=this.Y.get(e),i=n(t),a=r?zr(r,t,i):this.dagWrite.createChunk(t,i);return await this.dagWrite.putChunk(a),a.hash}};async function wi(e,t,n,r){if(r())return;let i=n.withRead((t=>async function(e,t){if(!await di(e,t))throw new ci(e)}(e,t))),[a,s,o,l]=await async function(e){return await e.withRead((async e=>{let t=await e.getHead(On);We(t);let n=new class extends class{constructor(e){this.j=new Set,this.dagRead=e}async visitCommit(e,t=1){if(this.j.has(e))return;this.j.add(e);let n=await this.dagRead.getChunk(e);if(!n){if(0===t)return;throw new Gn(e)}let{data:r}=n;jn(),await this.visitCommitChunk(n)}async visitCommitChunk(e){let{data:t}=e;await Promise.all([this.Rt(t.meta),this.St(t.valueHash),this.It(t.indexes)])}Rt(e){switch(e.type){case 1:return this.Ct(e);case 2:return this.vt(e);case 3:return this.Ht(e)}}async se(e,t){null!==e&&await this.visitCommit(e,t)}async Ht(e){await this.se(e.basisHash,0)}async vt(e){await this.se(e.basisHash,1),null!==e.originalHash&&await this.visitCommit(e.originalHash,0)}Ct(e){return this.se(e.basisHash,1)}St(e){return this.visitBTreeNode(e)}async visitBTreeNode(e){if(e===It||this.j.has(e))return;this.j.add(e);let t=await this.dagRead.mustGetChunk(e),{data:n}=t;await this.visitBTreeNodeChunk(t)}async visitBTreeNodeChunk(e){let{data:t}=e;At(t)&&await this.Nt(e)}async Nt(e){let{data:t}=e;await Promise.all(t[1].map((e=>this.visitBTreeNode(e[1]))))}async It(e){await Promise.all(e.map((async e=>this.visitBTreeNode(e.valueHash))))}}{constructor(){super(...arguments),this.C=new Map}get gatheredChunks(){return this.C}async visitCommit(e,t){if(Ut(e))return super.visitCommit(e,t)}async visitCommitChunk(e){return this.C.set(e.hash,e),super.visitCommitChunk(e)}async visitBTreeNode(e){if(Ut(e))return super.visitBTreeNode(e)}async visitBTreeNodeChunk(e){return this.C.set(e.hash,e),super.visitBTreeNodeChunk(e)}}(e);await n.visitCommit(t);let r=await Un(t,e),i=await xn(t,e);return[n.gatheredChunks,t,r.mutationID,i.meta.lastMutationID]}))}(t);if(0===a.size)return void await i;let u=async function(e,t){let n=new yi(e,xt),r=await n.transformCommit(t),{fixedChunks:i,mappings:a}=n;return[i,a,r]}(a,s);await i;let[c,d,h]=await u;r()||(await async function(e,t,n,r,i,a){let s=t.values();await fi((e=>({clients:new Map(e).set(r,{heartbeatTimestampMs:Date.now(),headHash:n,mutationID:i,lastServerAckdMutationID:a}),chunksToPut:s})),e)}(n,c,h,e,o,l),await async function(e,t){await e.withWrite((async e=>{for(let n of[On,Qn]){let r=await e.getHead(n);if(!r){if(n===Qn)break;throw new Error(`No head found for ${n}`)}let i=await new vi(e,t).transformCommit(r);await e.setHead(n,i)}await e.commit()}))}(t,d))}function gi(e,t,n,r,i){var a;if(i.aborted)return;r=r.addContext("bgIntervalProcess",e);let s=setInterval((async()=>{var e,n,a;null==(e=r.debug)||e.call(r,"Running");try{await t()}catch(e){i.aborted?null==(n=r.debug)||n.call(r,"Error running most likely due to close.",e):null==(a=r.error)||a.call(r,"Error running.",e)}}),n);null==(a=(r=r.addContext("intervalID",s)).debug)||a.call(r,"Starting"),i.addEventListener("abort",(()=>{var e;null==(e=r.debug)||e.call(r,"Stopping"),clearInterval(s)}))}var bi;function _i(e,t,n,r,i){gi("Heartbeat",(async()=>{bi=async function(e,t){let n=await fi((t=>{let n=t.get(e);return n?{clients:new Map(t).set(e,{heartbeatTimestampMs:Date.now(),headHash:n.headHash,mutationID:n.mutationID,lastServerAckdMutationID:n.lastServerAckdMutationID})}:pi}),t);if(void 0===n.get(e))throw new ci(e);return n}(e,t);try{return await bi}catch(e){if(e instanceof ci)return void n();throw e}}),6e4,r,i)}var Oi,ki=6048e5;function Di(e,t,n,r){gi("ClientGC",(()=>(Oi=async function(e,t){return fi((t=>{let n=Date.now(),r=Array.from(t).filter((([t,r])=>t===e||n-r.heartbeatTimestampMs<=ki));return r.length===t.size?pi:{clients:new Map(r)}}),t)}(e,t),Oi)),3e5,n,r)}var xi="dbs",Ii="profileId";function Ei(e){Ye(e),Ke(e.name),Ke(e.replicacheName),Be(e.replicacheFormatVersion),Ke(e.schemaVersion),void 0!==e.lastOpenedTimestampMS&&Be(e.lastOpenedTimestampMS)}var Ui=2592e6,Ni=3e5;function Ci(e,t,n){(async function(e,t){try{await vr(Ni,t),await Si(e,t,Date.now(),Ui)}catch(e){if(e instanceof yr)return;throw e}})(e,n),gi("CollectIDBDatabases",(async()=>{await Si(e,n,Date.now(),Ui)}),432e5,t,n)}async function Si(e,t,n,r,i=ji){let a=await e.getDatabases(),s=Object.values(a),o=(await Promise.all(s.map((async e=>[e.name,await Mi(e,n,r,i)])))).filter((e=>e[1])).map((e=>e[0])),l=await Promise.allSettled(o.map((async e=>(await async function(e){await Hr(indexedDB.deleteDatabase(e))}(e),e)))),u=[],c=[];for(let e of l)"fulfilled"===e.status?u.push(e.value):c.push(e.reason);if(u.length&&!t.aborted&&await e.deleteDatabases(u),c.length)throw c[0]}function ji(e){let t=new Pr(e);return new Xr(t,qr,Nt)}async function Mi(e,t,n,r){if(e.replicacheFormatVersion>zi)return!1;if(void 0!==e.lastOpenedTimestampMS)return t-e.lastOpenedTimestampMS>=n;let i=r(e.name),a=await i.withRead(li);return await i.close(),function(e,t,n){for(let r of e.values())if(t-r.heartbeatTimestampMs<n)return!1;return!0}(a,t,n)}parseInt("1.0".split(".")[1],10);function Ti(e){Pi(e,"boolean")}function Pi(e,t){typeof e!==t&&Li(e,t)}function Ai(e){null===e&&Li(e,"object"),Pi(e,"object")}function Li(e,t){throw new Error(function(e,t){let n="Invalid type: ";return n+=null==e?e:`${typeof e} \`${e}\``,n+`, expected ${t}`}(e,t))}new URL("https://replicache-license.herokuapp.com/");async function Ri(e,t,n,r,i){var a,s;i=i.addContext("licenseActive");let o=new URL("/api/1.0/license/active",t),l={licenseKey:n,profileID:r},u=JSON.stringify(l);null==(a=i.debug)||a.call(i,`Sending ${o}`,u);let c=await(await e("post",o.toString(),u,[["Content-Type","application/json"],["Accept","application/json"]])).text();null==(s=i.debug)||s.call(i,`Got ${o}`,c),function(e){Ai(e)}(JSON.parse(c))}async function Fi(e,t,n,r){var i,a;r=r.addContext("getLicenseStatus");let s=new URL("/api/1.0/license/status",t),o={licenseKey:n},l=JSON.stringify(o);null==(i=r.debug)||i.call(r,`Sending ${s}`,l);let u=await(await e("post",s.toString(),l,[["Content-Type","application/json"],["Accept","application/json"]])).text();null==(a=r.debug)||a.call(r,`Got ${s}`,u);let c=JSON.parse(u);return function(e){Ai(e),function(e){Pi(e,"string")}(e.status),Ti(e.disable),Ti(e.pleaseUpdate)}(c),c}var Hi="This key only good for automated testing",Zi=new URL("https://replicache-license.herokuapp.com/");new URL("https://replicache-license-staging.herokuapp.com/");async function $i(e,t,n,r){let i=await async function(e,t,n,r){return fetch(t,{method:e,body:n,headers:r})}(e,t,n,r);if(200!==i.status)throw new Error(`Got ${i.status} fetching ${t}: ${await i.text()}`);return i}var zi=4;function Gi(e,t){let n=`rep:${e}:${zi}`;return t?`${n}:${t}`:n}var qi=()=>{},Vi={type:"NotFoundOnServer"},Wi={type:"NotFoundOnClient"},Ki=class{constructor(e){this.t=!1,this.me=!0,this.Z=Promise.resolve(void 0),this.tt=new Map,this.nt=0,this.rt=0,this.J=new class{constructor(e=(e=>new Pr(e))){this.H=e("replicache-dbs-v0")}putDatabase(e){return this.Qe(s(s({},e),{},{lastOpenedTimestampMS:Date.now()}))}putDatabaseForTesting(e){return this.Qe(e)}Qe(e){return this.H.withWrite((async t=>{let n=s(s({},await this.pe(t)),{},{[e.name]:e});return await t.put(xi,n),await t.commit(),n}))}clearDatabases(){return this.H.withWrite((async e=>{await e.del(xi),await e.commit()}))}deleteDatabases(e){return this.H.withWrite((async t=>{let n=s({},await this.pe(t));for(let t of e)delete n[t];await t.put(xi,n),await t.commit()}))}getDatabases(){return this.H.withRead((e=>this.pe(e)))}close(){return this.H.close()}async pe(e){let t=await e.get(xi);return t||(t={}),function(e){Ye(e);for(let[t,n]of Object.entries(e))Ke(t),Ei(n),We(t===n.name)}(t),t}async getProfileID(){return this.H.withWrite((async e=>{let t=await e.get(Ii);return void 0===t&&(t=`p${Kn().replace(/-/g,"")}`,await e.put(Ii,t),await e.commit()),Ke(t),t}))}},this.at=new AbortController,this.ot=new Ge,this.ge=!1,this.we=!1,this.onSync=null,this.onClientStateNotFound=Yi,this.getAuth=null,this.ut=async()=>{var e;this.t||"visible"===(null==(e=Ji())?void 0:e.visibilityState)&&await this.lt()},this.onOnlineChange=null,this.L=async e=>{await this.l;let t=await this.c;return this.h.withRead((async n=>{let r=await An(n),i=new ur(t,r,this.e);try{return await e(i)}catch(e){throw await this.yt(e)}}))};let{name:t,logLevel:n="info",logSinks:r=[Ze],pullURL:i="",auth:a,pushDelay:l=10,pushURL:u="",schemaVersion:c="",pullInterval:d=6e4,mutators:h={},requestOptions:p={},puller:f=pt,pusher:m=ut,licenseKey:y,experimentalKVStore:v}=e;if(this.auth=null!=a?a:"",this.pullURL=i,this.pushURL=u,void 0===t||""===t)throw new Error("name is required and must be non-empty");this.name=t,this.schemaVersion=c,this.pullInterval=d,this.pushDelay=l,this.puller=f,this.pusher=m;let w=e,{enableLicensing:g=!0,enableMutationRecovery:b=!0}=w;this.xe=g,this.it=b,w.exposeInternalAPI&&w.exposeInternalAPI({persist:()=>this.dt()});let _=1===r.length?r[0]:new class{constructor(e){this.ve=e}log(e,...t){for(let n of this.ve)n.log(e,...t)}async flush(){await Promise.all(this.ve.map((e=>{var t;return null==(t=e.flush)?void 0:t.call(e)})))}}(r);this.e=new $e(n,_).addContext("name",t),this.d=new class{constructor(e,t){this.d=new Set,this.ue=new Set,this.hasPendingSubscriptionRuns=!1,this.L=e,this.e=t}je(e){return this.d.add(e),this.Ft(e),()=>this.d.delete(e)}addSubscription(e,{onData:t,onError:n,onDone:r}){let i=new class{constructor(e,t,n,r){this.We=!0,this.Ue=void 0,this.D=Er,this.k=[],this.Be=e,this.Je=t,this.onError=n,this.onDone=r}invoke(e,t,n){return this.Be(e)}matches(e){for(let[t,n]of e)if(Ur(this.D,this.k,t,n))return!0;return!1}updateDeps(e,t){this.D=e,this.k=t}onData(e){(this.We||!rt(e,this.Ue))&&(this.Ue=e,this.We=!1,this.Je(e))}}(e,t,n,r);return this.je(i)}addWatch(e,t){let n=new class{constructor(e,t){var n,r;this.onError=void 0,this.onDone=void 0,this.Ke=e,this.P=null!=(n=t.prefix)?n:"",this.qe=null!=(r=t.initialValuesInFirstDiff)&&r}onData(e){void 0!==e&&this.Ke(e)}async invoke(e,t,n){let r;if(0===t){if(!this.qe)return;We(void 0===n);let t=[];var i,a=!1,s=!1;try{for(var l,u=o(e.scan({prefix:this.P}).entries());a=!(l=await u.next()).done;a=!1){let e=l.value;t.push({op:"add",key:e[0],newValue:e[1]})}}catch(e){s=!0,i=e}finally{try{a&&null!=u.return&&await u.return()}finally{if(s)throw i}}r=t}else{We(n);let e=n.get("");if(void 0===e)return[];r=e}if(""===this.P)return r;let c=[],{length:d}=r,h=this.P,p=e=>h<=r[e].key;for(let e=St(d,p);e<d&&r[e].key.startsWith(this.P);e++)c.push(r[e]);return c.length>0?c:void 0}matches(e){let t=e.get("");return void 0!==t&&function(e,t){if(""===t)return!0;let n=St(e.length,(n=>t<=e[n].key));return n<e.length&&e[n].key.startsWith(t)}(t,this.P)}updateDeps(e,t){}}(e,null!=t?t:{});return this.je(n)}clear(){var e;for(let t of this.d)null==(e=t.onDone)||e.call(t);this.d.clear()}async fire(e){let t=function*(e,t){for(let n of e)n.matches(t)&&(yield n)}(this.d,e);await this.$e(t,1,e)}async $e(e,t,n){var r,i;let a=[...e];if(0===a.length)return;let s=await this.L((e=>Promise.allSettled(a.map((async r=>{let i=new class{constructor(e){this.D=new Set,this.k=[],this.n=e}get clientID(){return this.n.clientID}isEmpty(){return this.k.push({options:{}}),this.n.isEmpty()}get(e){return this.D.add(e),this.n.get(e)}has(e){return this.D.add(e),this.n.has(e)}scan(e){let t={options:wt(e),inclusiveLimitKey:void 0};return this.k.push(t),dr(e,this.n.dbtx,(e=>{t.inclusiveLimitKey=e}))}get keys(){return this.D}get scans(){return this.k}}(e);try{return await r.invoke(i,t,n)}finally{r.updateDeps(i.keys,i.scans)}})))));for(let e=0;e<a.length;e++){let t=a[e],n=s[e];"fulfilled"===n.status?t.onData(n.value):t.onError?t.onError(n.reason):null==(i=(r=this.e).error)||i.call(r,n.reason)}}async Ft(e){if(this.ue.add(e),!this.hasPendingSubscriptionRuns){this.hasPendingSubscriptionRuns=!0,await Promise.resolve(),this.hasPendingSubscriptionRuns=!1;let e=[...this.ue];this.ue.clear(),await this.$e(e,0,void 0)}}}(this.L,this.e);let O=v||new Pr(this.idbName);this.b=new Xr(O,qr,Nt),this.h=new ni(this.b,104857600,this.jt(),Ct);let k=ze();this.l=k.promise,this.x=y;let D=ze();this.Kt=D.promise;let x=ze();this.qt=x.promise;let{minDelayMs:I=wr,maxDelayMs:E=gr}=p;this.st={maxDelayMs:E,minDelayMs:I},this.ye=new br(new xr(this,(()=>this.$t()),this.e.addContext("PULL"))),this.X=new br(new Ir(this,(()=>this.Gt()),this.e.addContext("PUSH"))),this.mutate=this.zt(h);let U=ze();this.fe=U.promise;let N=ze();this.c=N.promise,this.Yt(U.resolve,N.resolve,k.resolve,D.resolve,x.resolve)}get idbName(){return Gi(this.name,this.schemaVersion)}get et(){return{name:this.idbName,replicacheName:this.name,replicacheFormatVersion:zi,schemaVersion:this.schemaVersion}}get requestOptions(){return this.st}jt(){return Et}async Yt(e,t,n,r,i){var a;await Bi.get(this.name),await this.J.getProfileID().then(e),await this.J.putDatabase(this.et);let[s,o,l]=await async function(e){let t=Kn(),n=await fi((async n=>{let r;for(let e of n.values())(!r||r.heartbeatTimestampMs<e.heartbeatTimestampMs)&&(r=e);let i,a=[];if(r){let t=r;i=await e.withRead((async e=>{let n=await xn(t.headHash,e);return Nn(n.meta.basisHash,0,n.meta.cookieJSON,n.valueHash,n.indexes)}))}else{let e=await Gr(qt,[]);a.push(e),i=Nn(null,0,null,e.hash,[])}let s=await Gr(i,Sn(i));return a.push(s),{clients:new Map(n).set(t,{heartbeatTimestampMs:Date.now(),headHash:s.hash,mutationID:0,lastServerAckdMutationID:0}),chunksToPut:a}}),e),r=n.get(t);return et(r),[t,r,n]}(this.b);t(s),await this.h.withWrite((async e=>{await e.setHead(On,o.headHash),await e.commit()})),n(),this.Z=this.Zt(),await this.Z,await this.Xt(r),this.pull(),this.Qt();let{signal:u}=this.at;_i(s,this.b,(()=>{this.W(s,Wi)}),this.e,u),Di(s,this.b,this.e,u),Ci(this.J,this.e,u),function(e,t,n){let r=setInterval(e,t);n.addEventListener("abort",(()=>{clearInterval(r)}))}((()=>this.be()),3e5,u),this.be(l),null==(a=Ji())||a.addEventListener("visibilitychange",this.ut),await this.en(i,this.e,u)}async lt(){let e=await this.c,t=await this.b.withRead((t=>di(e,t)));return t||this.W(e,Wi),!t}async Xt(e){var t,n,r,i,a,s,o,l,u,c;if(this.xe)if(this.x){if(null==(n=(t=this.e).info)||n.call(t,`Replicache license key: ${this.x}`),this.x===Hi)return null==(i=(r=this.e).info)||i.call(r,"Skipping license check for TEST_LICENSE_KEY. You may ONLY use this key for automated (e.g., unit/CI) testing. See https://replicache.dev for more information."),void e(!0);try{let t=await Fi($i,Zi,this.x,this.e);if(t.pleaseUpdate&&(null==(s=(a=this.e).error)||s.call(a,"You are using an old version of Replicache that uses deprecated licensing features. Please update Replicache else it may stop working.")),"VALID"!==t.status)return void await this.ct(this.e,`status: ${t.status}`,t.disable,e);null==(l=(o=this.e).info)||l.call(o,"License is valid.")}catch(e){null==(c=(u=this.e).error)||c.call(u,`Error checking license: ${e}`)}e(!0)}else await this.ct(this.e,"license key ReplicacheOptions.licenseKey is not set",!0,e);else e(!0)}async ct(e,t,n,r){var i,a;null==(i=e.error)||i.call(e,`** REPLICACHE LICENSE NOT VALID ** Replicache license key '${this.x}' is not valid (${t}). Please run 'npx replicache get-license' to get a license key or contact hello@replicache.dev for help.`),n&&(await this.close(),null==(a=e.error)||a.call(e,"** REPLICACHE DISABLED **")),r(!1)}async en(e,t,n){if(!this.xe||!this.x||this.x===Hi)return void e(!1);let r=async()=>{var e,n;try{await Ri($i,Zi,this.x,await this.profileID,t)}catch(t){null==(n=(e=this.e).info)||n.call(e,`Error sending license active ping: ${t}`)}};await r(),e(!0),gi("LicenseActive",r,864e5,t,n)}get profileID(){return this.fe}get clientID(){return this.c}get online(){return this.me}get closed(){return this.t}async close(){var e;this.t=!0;let{promise:t,resolve:n}=ze();Bi.set(this.name,t),this.at.abort(),null==(e=Ji())||e.removeEventListener("visibilitychange",this.ut),await this.l;let r=[this.h.close(),this.b.close(),this.J.close()];this.ye.close(),this.X.close(),this.d.clear(),await Promise.all(r),Bi.delete(this.name),n()}async Zt(){if(!this.t)return await this.l,await function(e,t){return e.withRead((async e=>{let n=await e.getHead(t);if(void 0===n)throw new Error(`No head found for ${t}`);return n}))}(this.h,On)}async Re(e,t){let n=await this.Z;void 0!==e&&e!==n&&(this.Z=Promise.resolve(e),await this.d.fire(t))}async createIndex(e){await this.ht((t=>t.createIndex(e)))}async dropIndex(e){await this.ht((t=>t.dropIndex(e)))}async ht(e){await this.l;let t=await this.c;await this.h.withWrite((async n=>{let r=await Zn.newIndexChange(Tn(On),n),i=new pr(t,r,this.e);await e(i);let[a,s]=await i.commit(!0);We(!s.has("")),await this.Re(a,s)}))}async Se(e){if(this.t)return;let{syncHead:t}=e,{requestID:n}=e;await this.l;let r=this.e.addContext("maybeEndPull").addContext("request_id",n),{replayMutations:i,diffs:a}=await nr(this.h,r,t);if(!i||0===i.length)return await this.Re(t,a),void this.pt();for(let e of i)t=await this.tn(t,e.original,e.name,e.args,e.timestamp);await this.Se(s(s({},e),{},{syncHead:t}))}async tn(e,t,n,r,i){var a,s;let o=this.tt.get(n);return o||(null==(s=(a=this.e).error)||s.call(a,`Unknown mutator ${n}`),o=async()=>{}),(await this.mt(n,o,r,i,{basis:e,original:t},!0)).ref}async $t(){return!!this.ft()||this.ot.withLock((()=>this.Q((async()=>{try{this.A(0,1);let e=await this.nn();if(!e.ok)return!1;e.syncHead!==It&&await this.Se(e)}finally{this.A(0,-1)}return!0}),"Pull")))}ft(){return""===this.pullURL&&this.puller===pt}async Q(e,t){var n,r,i,a,s;let o=!0;try{return await e()}catch(e){return e instanceof ct||e instanceof mt?(o=!1,null==(r=(n=this.e).info)||r.call(n,`${t} threw:\n`,e,"\nwith cause:\n",e.causedBy)):null==(a=(i=this.e).info)||a.call(i,`${t} threw:\n`,e),!1}finally{this.me!==o&&(this.me=o,null==(s=this.onOnlineChange)||s.call(this,o),o&&this.be())}}async ee(e,t,n,r=qi,i=qi){var a,s,o,l;let u,c=0;do{let{httpRequestInfo:o,result:l}=await e();if(u=l,!o)return{result:l,authFailure:!1};let d,{errorMessage:h,httpStatusCode:p}=o;if((h||p>=400)&&(null==(s=(a=this.e).error)||s.call(a,`Got error response from server (${n}) doing ${t}: ${p}`+(h?`: ${h}`:""))),401!==p)return{result:l,authFailure:!1};if(!this.getAuth)return{result:l,authFailure:!0};try{await r(),d=await this.getAuth()}finally{await i()}if(null==d)return{result:l,authFailure:!0};this.auth=d,c++}while(c<8);return null==(l=(o=this.e).info)||l.call(o,"Tried to reauthenticate too many times"),{result:u,authFailure:!0}}Ie(){return""===this.pushURL&&this.pusher===ut}async Gt(){return!!this.Ie()||this.Q((async()=>{let{result:e}=await this.ee((async()=>{await this.l;let e=await this.fe,t=await this.c,n=or(t),r=this.e.addContext("push").addContext("request_id",n);try{this.A(1,0);let i=await ir(n,this.h,r,e,t,this.pusher,this.pushURL,this.auth,this.schemaVersion);return{result:i,httpRequestInfo:i}}finally{this.A(-1,0)}}),"push",this.pushURL);return void 0===e||200===e.httpStatusCode}),"Push")}Qt(){this.X.send()}pull(){this.ye.send()}async poke(e){await this.l;let t=await this.c,n=or(t),r=this.e.addContext("handlePullResponse").addContext("request_id",n);if(dt(e.pullResponse))return void this.W(t,Vi);let i=await tr(r,this.h,e.baseCookie,e.pullResponse);if(null===i)throw new Error("unexpected base cookie for poke: "+JSON.stringify(e));await this.Se({requestID:n,syncHead:i,ok:!0})}async nn(){let{result:{beginPullResponse:e,requestID:t}}=await this.ee((async()=>{await this.l;let e=await this.profileID,t=await this.c,n=or(t),r=this.e.addContext("beginPull").addContext("request_id",n),i={pullAuth:this.auth,pullURL:this.pullURL,schemaVersion:this.schemaVersion,puller:this.puller},a=await er(e,t,i,i.puller,n,this.h,r);return{result:{beginPullResponse:a,requestID:n},httpRequestInfo:a.httpRequestInfo}}),"pull",this.pullURL,(()=>this.A(0,-1)),(()=>this.A(0,1)));if(dt(e.pullResponse)){let e=await this.c;this.W(e,Vi)}let{syncHead:n,httpRequestInfo:r}=e;return{requestID:t,syncHead:n,ok:200===r.httpStatusCode}}async dt(){var e,t;if(this.t)return;await this.l;let n=await this.clientID;try{await this.ot.withLock((()=>wi(n,this.h,this.b,(()=>this.closed))))}catch(r){if(r instanceof ci)this.W(n,Wi);else{if(!this.t)throw r;null==(t=(e=this.e).debug)||t.call(e,"Exception persisting during close",r)}}}W(e,t){var n,r,i;null==(r=(n=this.e).error)||r.call(n,`Client state not found, clientID: ${e}`),null==(i=this.onClientStateNotFound)||i.call(this,t)}pt(){this.ge||(this.ge=!0,(async()=>{await function(e){return new Promise((t=>{"function"==typeof requestIdleCallback?requestIdleCallback((()=>t()),{timeout:e}):setTimeout((()=>t()),e)}))}(1e3),await this.dt(),this.ge=!1})())}A(e,t){this.nt+=e,this.rt+=t;let n=e+t,r=this.nt+this.rt;if(1===n&&1===r||0===r){let e=r>0;Promise.resolve().then((()=>{var t;return null==(t=this.onSync)?void 0:t.call(this,e)}))}}subscribe(e,t){return this.d.addSubscription(e,t)}experimentalWatch(e,t){return this.d.addWatch(e,t)}async query(e){return this.L(e)}rn(e,t){return this.tt.set(e,t),async n=>(await this.mt(e,t,n,performance.now(),void 0,!1)).result}zt(e){let t=Object.create(null);for(let n in e)t[n]=this.rn(n,e[n]);return t}async mt(e,t,n,r,i,a){this.d.hasPendingSubscriptionRuns&&await Promise.resolve(),await this.l;let s=await this.c;return await this.h.withWrite((async o=>{let l,u=null;void 0===i?l=Tn(On):(await async function(e,t,n,r){let i=await t.getHead(Qn);if(i!==e.basis)throw new Error(`WrongSyncHeadJSLogInfo: sync head is ${i}, transaction basis is ${e.basis}`);let[,a]=await Ln(Pn(e.original),t);if(!a.isLocal())throw new Error("Internal programmer error: Commit is not a local commit");{let e=a.meta;if(e.mutatorName!==n)throw new Error(`Inconsistent mutator: original: ${e.mutatorName}, request: ${n}`)}let[,s]=await Ln(Pn(e.basis),t);if(s.nextMutationID!==a.mutationID)throw new Error(`Inconsistent mutation ID: original: ${a.mutationID}, next: ${s.nextMutationID}`)}(i,o,e),l=Pn(i.basis),u=i.original);let c=await Zn.newLocal(l,e,it(null!=n?n:null),u,o,r),d=new hr(s,c,this.e);try{let e=await t(d,n),[r,i]=await d.commit(!a);return a||(this.X.send(),await this.Re(r,i),this.pt()),{result:e,ref:r}}catch(e){throw await this.yt(e)}}))}async yt(e){return e instanceof Gn&&await this.lt()?new ci(await this.c):e}async be(e){var t,n,r,i,a,s;if(!this.it||this.we||!this.online||this.closed||this.Ie())return!1;let o="Recovering mutations.";null==(n=(t=this.e).debug)||n.call(t,"Start:",o);try{this.we=!0,await this.l,await this.gt(this.et,this.b,e);for(let e of Object.values(await this.J.getDatabases())){if(this.closed)return null==(i=(r=this.e).debug)||i.call(r,"Exiting early due to close:",o),!0;e.name===this.idbName||e.replicacheName!==this.name||e.replicacheFormatVersion!==zi||await this.gt(e)}}catch(e){this.Ce(e,o)}finally{null==(s=(a=this.e).debug)||s.call(a,"End:",o),this.we=!1}return!0}async gt(e,t,n){var r,i,a,s,o,l;let u,c=`Recovering mutations from db ${e.name}.`;null==(i=(r=this.e).debug)||i.call(r,"Start:",c);try{if(!t){let n=new Pr(e.name);t=u=new Xr(n,qr,Nt)}let r=n||await t.withRead((e=>li(e))),i=new Set;for(;r;){let n;for(let[o,l]of r){if(this.closed)return void(null==(s=(a=this.e).debug)||s.call(a,"Exiting early due to close:",c));if(!i.has(o)&&(i.add(o),n=await this.sn(l,o,t,e),n))break}r=n}}catch(e){this.Ce(e,c)}finally{var d;await(null===(d=u)||void 0===d?void 0:d.close()),null==(l=(o=this.e).debug)||l.call(o,"End:",c)}}async sn(e,t,n,r){var i,a,o,l,u,c,d,h,p,f,m,y,v,w,g,b;let _=await this.c;if(_===t||e.lastServerAckdMutationID>=e.mutationID)return;let O,k=`Recovering mutations for ${t}.`;null==(a=(i=this.e).debug)||a.call(i,"Start:",k);try{var D;let i=O=new ni(n,10485760,qr,Ct);if(await i.withWrite((async t=>{await t.setHead(On,e.headHash),await t.commit()})),this.Ie())return void(null==(l=(o=this.e).debug)||l.call(o,`Cannot recover mutations for client ${t} because push is disabled.`));let{pusher:a,pushURL:I}=this,E=or(t),U="recoveringMutationsPush",N=this.e.addContext(U).addContext("request_id",E);if(!await this.Q((async()=>{let{result:e}=await this.ee((async()=>{et(i);let e=await ir(E,i,N,await this.profileID,t,a,I,this.auth,r.schemaVersion);return{result:e,httpRequestInfo:e}}),U,this.pushURL);return!!e&&200===e.httpStatusCode}),U))return void(null==(c=(u=this.e).debug)||c.call(u,`Failed to recover mutations for client ${t} due to a push error.`));if(this.ft())return void(null==(h=(d=this.e).debug)||h.call(d,`Cannot confirm mutations were recovered for client ${t} because pull is disabled.`));let C,{puller:S,pullURL:j}=this,M=or(t),T="recoveringMutationsPull",P=this.e.addContext(T).addContext("request_id",M);return await this.Q((async()=>{let{result:e}=await this.ee((async()=>{let e={pullAuth:this.auth,pullURL:j,schemaVersion:r.schemaVersion,puller:S},n=await er(await this.profileID,t,e,e.puller,M,i,P,!1);return{result:n,httpRequestInfo:n.httpRequestInfo}}),T,this.pullURL);return C=e.pullResponse,!!C&&200===e.httpRequestInfo.httpStatusCode}),T)?(C&&dt(C)?null==(y=(m=this.e).debug)||y.call(m,`Client ${_} cannot recover mutations for client ${t}. The client no longer exists on the server.`):null==(w=(v=this.e).debug)||w.call(v,`Client ${_} recovered mutations for client ${t}.  Details`,{mutationID:e.mutationID,lastServerAckdMutationID:e.lastServerAckdMutationID,lastMutationID:null===(D=C)||void 0===D?void 0:D.lastMutationID}),await fi((e=>{et(C);let n=e.get(t);if(!n)return pi;if(dt(C)){let n=new Map(e);return n.delete(t),{clients:n}}return n.lastServerAckdMutationID>=C.lastMutationID?pi:{clients:new Map(e).set(t,s(s({},n),{},{lastServerAckdMutationID:C.lastMutationID}))}}),n)):void(null==(f=(p=this.e).debug)||f.call(p,`Failed to recover mutations for client ${t} due to a pull error.`))}catch(e){return void this.Ce(e,k)}finally{var x;await(null===(x=O)||void 0===x?void 0:x.close()),null==(b=(g=this.e).debug)||b.call(g,"End:",k)}}Ce(e,t){var n,r,i,a;this.closed?null==(r=(n=this.e).debug)||r.call(n,`Mutation recovery error likely due to close during:\n${t}\nError:\n`,e):null==(a=(i=this.e).error)||a.call(i,`Mutation recovery error during:\n${t}\nError:\n`,e)}},Bi=new Map;function Ji(){return typeof document<"u"?document:void 0}function Yi(){typeof location<"u"&&location.reload()}function Qi(e){var t;return(null==(t=e[Symbol.asyncIterator])?void 0:t.call(e))||e[Symbol.iterator]()}function Xi(e,t,n){return ea.apply(this,arguments)}function ea(){return ea=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t,n){let r=Qi(e),i=Qi(t),a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(r.next()),s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(i.next());for(;;){if(a.done){if(s.done)return;yield s.value,s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(i.next());continue}if(s.done){yield a.value,a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(r.next());continue}let e=n(a.value,s.value);0===e?(yield s.value,a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(r.next()),s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(i.next())):e<0?(yield a.value,a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(r.next())):(yield s.value,s=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(i.next()))}})),ea.apply(this,arguments)}function ta(e,t){return na.apply(this,arguments)}function na(){return na=Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/wrapAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())((function*(e,t){var n,r=!1,i=!1;try{for(var a,s=o(e);r=!(a=yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(s.next())).done;r=!1){let e=a.value;t(e)&&(yield e)}}catch(e){i=!0,n=e}finally{try{r&&null!=s.return&&(yield Object(function(){var e=new Error("Cannot find module '/Users/cindy/code/replicache/trunk-mini/node_modules/next/dist/compiled/@babel/runtime/helpers/esm/awaitAsyncGenerator'");throw e.code="MODULE_NOT_FOUND",e}())(s.return()))}finally{if(i)throw n}}})),na.apply(this,arguments)}},(e,t,n)=>{n.r(t),n.d(t,{serverMutators:()=>l,clientMutators:()=>u});var r=n(3),i=n(4),a=n(7),s=n(10);function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}const l={initClientState:i.initClientState,setCursor:i.setCursor,createItem:a.putItem,deleteItem:a.deleteItem,updateItemTitle:a.updateItemTitle,updateItemContent:a.updateItemContent,updateItemArrows:a.updateItemArrows,updateItemSourceURL:a.updateItemSourceURL,createArrow:s.putArrow,updateItemAddSingleArrow:a.updateItemAddSingleArrow,deleteArrow:s.deleteArrow,updateItemArrowsDeleteArrow:a.updateItemArrowsDeleteArrow,setUsername:i.setUsername,setAvatarURL:i.setAvatarURL,setTrunkIDs:i.setTrunkIDs,updateItemCreatedBy:a.updateItemCreatedBy,updateArrowCreatedBy:s.updateArrowCreatedBy,updateItemWebSourceURL:a.updateItemWebSourceURL,updateItemPublicationDate:a.updateItemPublicationDate,nop:async e=>{}},u=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){(0,r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},l)},(e,t,n)=>{function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.r(t),n.d(t,{default:()=>r})},(e,t,n)=>{n.r(t),n.d(t,{userInfoSchema:()=>o,supabaseUserInfoSchema:()=>l,clientStateSchema:()=>u,initClientState:()=>c,getClientState:()=>d,putClientState:()=>h,setUsername:()=>p,setTrunkIDs:()=>f,setAvatarURL:()=>m,setCursor:()=>y,overShape:()=>v,selectShape:()=>w,selectItem:()=>g,randUserInfo:()=>b,clientStatePrefix:()=>O});var r=n(5),i=n(6);const a=["#f94144","#f3722c","#f8961e","#f9844a","#f9c74f","#90be6d","#43aa8b","#4d908e","#577590","#277da1"],s=[["🐶","Puppy"],["🐱","Kitty"],["🐭","Mouse"],["🐹","Hamster"],["🐰","Bunny"],["🦊","Fox"],["🐻","Bear"],["🐼","Panda"],["🐨","Koala"],["🐯","Tiger"],["🦁","Lion"],["🐮","Cow"],["🐷","Piggy"],["🐵","Monkey"],["🐣","Chick"]],o=i.z.object({avatar:i.z.string(),name:i.z.string(),color:i.z.string()}),l=i.z.object({email:i.z.string(),username:i.z.string(),avatarURL:i.z.string(),trunkIDs:i.z.string()}),u=i.z.object({cursor:i.z.object({x:i.z.number(),y:i.z.number()}),overID:i.z.string(),selectedID:i.z.string(),userInfo:o,selectedItemID:i.z.string(),supabaseUserInfo:l});async function c(e,{id:t,defaultUserInfo:n,defaultSupabaseUserInfo:r}){await e.has(_(t))||await h(e,{id:t,clientState:{cursor:{x:0,y:0},overID:"",selectedID:"",userInfo:n,selectedItemID:"",supabaseUserInfo:r}})}async function d(e,t){const n=await e.get(_(t));if(!n)throw new Error("Expected clientState to be initialized already: "+t);return u.parse(n)}function h(e,{id:t,clientState:n}){return e.put(_(t),n)}async function p(e,{id:t,username:n}){const r=await d(e,t);r.supabaseUserInfo.username=n,await h(e,{id:t,clientState:r})}async function f(e,{id:t,trunkIDs:n}){const r=await d(e,t);r.supabaseUserInfo.trunkIDs=n,await h(e,{id:t,clientState:r})}async function m(e,{id:t,avatarURL:n}){const r=await d(e,t);r.supabaseUserInfo.avatarURL=n,await h(e,{id:t,clientState:r})}async function y(e,{id:t,x:n,y:r}){const i=await d(e,t);i.cursor.x=n,i.cursor.y=r,await h(e,{id:t,clientState:i})}async function v(e,{clientID:t,shapeID:n}){const r=await d(e,t);r.overID=n,await h(e,{id:t,clientState:r})}async function w(e,{clientID:t,shapeID:n}){const r=await d(e,t);r.selectedID=n,await h(e,{id:t,clientState:r})}async function g(e,{clientID:t,itemID:n}){const r=await d(e,t);r.selectedItemID=n,await h(e,{id:t,clientState:r})}function b(){const[e,t]=s[(0,r.randInt)(0,s.length-1)];return{avatar:e,name:t,color:a[(0,r.randInt)(0,a.length-1)]}}function _(e){return`${O}${e}`}const O="client-state-"},(e,t,n)=>{function r(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1)+e)}n.r(t),n.d(t,{randInt:()=>r})},(e,t,n)=>{n.r(t),n.d(t,{DIRTY:()=>E,EMPTY_PATH:()=>O,INVALID:()=>I,OK:()=>U,ParseStatus:()=>x,Schema:()=>P,ZodAny:()=>W,ZodArray:()=>Y,ZodBigInt:()=>$,ZodBoolean:()=>z,ZodDate:()=>G,ZodDefault:()=>be,ZodDiscriminatedUnion:()=>ne,ZodEffects:()=>ve,ZodEnum:()=>fe,ZodError:()=>f,ZodFirstPartyTypeKind:()=>pe,ZodFunction:()=>ue,ZodIntersection:()=>ie,ZodIssueCode:()=>h,ZodLazy:()=>ce,ZodLiteral:()=>de,ZodMap:()=>oe,ZodNaN:()=>_e,ZodNativeEnum:()=>me,ZodNever:()=>B,ZodNull:()=>V,ZodNullable:()=>ge,ZodNumber:()=>Z,ZodObject:()=>ee,ZodOptional:()=>we,ZodParsedType:()=>w,ZodPromise:()=>ye,ZodRecord:()=>se,ZodSchema:()=>P,ZodSet:()=>le,ZodString:()=>F,ZodTransformer:()=>ve,ZodTuple:()=>ae,ZodType:()=>P,ZodUndefined:()=>q,ZodUnion:()=>te,ZodUnknown:()=>K,ZodVoid:()=>J,addIssueToContext:()=>k,any:()=>Me,array:()=>Le,bigint:()=>Ue,boolean:()=>Ne,custom:()=>Oe,date:()=>Ce,default:()=>st,defaultErrorMap:()=>m,discriminatedUnion:()=>Ze,effect:()=>Xe,enum:()=>Je,function:()=>We,getParsedType:()=>b,instanceof:()=>De,intersection:()=>$e,isAborted:()=>N,isAsync:()=>j,isDirty:()=>C,isValid:()=>S,late:()=>ke,lazy:()=>Ke,literal:()=>Be,makeIssue:()=>_,map:()=>qe,nan:()=>Ee,nativeEnum:()=>Ye,never:()=>Pe,null:()=>je,nullable:()=>tt,number:()=>Ie,object:()=>Re,objectUtil:()=>H,oboolean:()=>at,onumber:()=>it,optional:()=>et,ostring:()=>rt,overrideErrorMap:()=>y,preprocess:()=>nt,promise:()=>Qe,quotelessJson:()=>p,record:()=>Ge,set:()=>Ve,setErrorMap:()=>v,strictObject:()=>Fe,string:()=>xe,transformer:()=>Xe,tuple:()=>ze,undefined:()=>Se,union:()=>He,unknown:()=>Te,void:()=>Ae,z:()=>st});var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var a,s=function(){return s=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},s.apply(this,arguments)};function o(e,t,n,r){return new(n||(n=Promise))((function(i,a){function s(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}l((r=r.apply(e,t||[])).next())}))}function l(e,t){var n,r,i,a,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}function u(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function c(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,a=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}return s}function d(e,t,n){if(n||2===arguments.length)for(var r,i=0,a=t.length;i<a;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}!function(e){e.assertNever=function(e){throw new Error},e.arrayToEnum=function(e){var t,n,r={};try{for(var i=u(e),a=i.next();!a.done;a=i.next()){var s=a.value;r[s]=s}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return r},e.getValidEnumValues=function(t){var n,r,i=e.objectKeys(t).filter((function(e){return"number"!=typeof t[t[e]]})),a={};try{for(var s=u(i),o=s.next();!o.done;o=s.next()){var l=o.value;a[l]=t[l]}}catch(e){n={error:e}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return e.objectValues(a)},e.objectValues=function(t){return e.objectKeys(t).map((function(e){return t[e]}))},e.objectKeys="function"==typeof Object.keys?function(e){return Object.keys(e)}:function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=function(e,t){var n,r;try{for(var i=u(e),a=i.next();!a.done;a=i.next()){var s=a.value;if(t(s))return s}}catch(e){n={error:e}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}},e.isInteger="function"==typeof Number.isInteger?function(e){return Number.isInteger(e)}:function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}}(a||(a={}));var h=a.arrayToEnum(["invalid_type","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of"]),p=function(e){return JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:")},f=function(e){function t(t){var n=this.constructor,r=e.call(this)||this;r.issues=[],r.format=function(){var e={_errors:[]},t=function(n){var r,i;try{for(var a=u(n.issues),s=a.next();!s.done;s=a.next()){var o=s.value;if("invalid_union"===o.code)o.unionErrors.map(t);else if("invalid_return_type"===o.code)t(o.returnTypeError);else if("invalid_arguments"===o.code)t(o.argumentsError);else if(0===o.path.length)e._errors.push(o.message);else for(var l=e,c=0;c<o.path.length;){var d=o.path[c];if(c===o.path.length-1)l[d]=l[d]||{_errors:[]},l[d]._errors.push(o.message);else if("string"==typeof d)l[d]=l[d]||{_errors:[]};else if("number"==typeof d){var h=[];h._errors=[],l[d]=l[d]||h}l=l[d],c++}}}catch(e){r={error:e}}finally{try{s&&!s.done&&(i=a.return)&&i.call(a)}finally{if(r)throw r.error}}};return t(r),e},r.addIssue=function(e){r.issues=d(d([],c(r.issues),!1),[e],!1)},r.addIssues=function(e){void 0===e&&(e=[]),r.issues=d(d([],c(r.issues),!1),c(e),!1)};var i=n.prototype;return Object.setPrototypeOf?Object.setPrototypeOf(r,i):r.__proto__=i,r.name="ZodError",r.issues=t,r}return i(t,e),Object.defineProperty(t.prototype,"errors",{get:function(){return this.issues},enumerable:!1,configurable:!0}),t.prototype.toString=function(){return this.message},Object.defineProperty(t.prototype,"message",{get:function(){return JSON.stringify(this.issues,null,2)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isEmpty",{get:function(){return 0===this.issues.length},enumerable:!1,configurable:!0}),t.prototype.flatten=function(e){var t,n;void 0===e&&(e=function(e){return e.message});var r={},i=[];try{for(var a=u(this.issues),s=a.next();!s.done;s=a.next()){var o=s.value;o.path.length>0?(r[o.path[0]]=r[o.path[0]]||[],r[o.path[0]].push(e(o))):i.push(e(o))}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return{formErrors:i,fieldErrors:r}},Object.defineProperty(t.prototype,"formErrors",{get:function(){return this.flatten()},enumerable:!1,configurable:!0}),t.create=function(e){return new t(e)},t}(Error),m=function(e,t){var n;switch(e.code){case h.invalid_type:n="undefined"===e.received?"Required":"Expected ".concat(e.expected,", received ").concat(e.received);break;case h.unrecognized_keys:n="Unrecognized key(s) in object: ".concat(e.keys.map((function(e){return"'".concat(e,"'")})).join(", "));break;case h.invalid_union:n="Invalid input";break;case h.invalid_union_discriminator:n="Invalid discriminator value. Expected ".concat(e.options.map((function(e){return"string"==typeof e?"'".concat(e,"'"):e})).join(" | "));break;case h.invalid_enum_value:n="Invalid enum value. Expected ".concat(e.options.map((function(e){return"string"==typeof e?"'".concat(e,"'"):e})).join(" | "));break;case h.invalid_arguments:n="Invalid function arguments";break;case h.invalid_return_type:n="Invalid function return type";break;case h.invalid_date:n="Invalid date";break;case h.invalid_string:n="regex"!==e.validation?"Invalid ".concat(e.validation):"Invalid";break;case h.too_small:n="array"===e.type?"Array must contain ".concat(e.inclusive?"at least":"more than"," ").concat(e.minimum," element(s)"):"string"===e.type?"String must contain ".concat(e.inclusive?"at least":"over"," ").concat(e.minimum," character(s)"):"number"===e.type?"Number must be greater than ".concat(e.inclusive?"or equal to ":"").concat(e.minimum):"Invalid input";break;case h.too_big:n="array"===e.type?"Array must contain ".concat(e.inclusive?"at most":"less than"," ").concat(e.maximum," element(s)"):"string"===e.type?"String must contain ".concat(e.inclusive?"at most":"under"," ").concat(e.maximum," character(s)"):"number"===e.type?"Number must be less than ".concat(e.inclusive?"or equal to ":"").concat(e.maximum):"Invalid input";break;case h.custom:n="Invalid input";break;case h.invalid_intersection_types:n="Intersection results could not be merged";break;case h.not_multiple_of:n="Number must be a multiple of ".concat(e.multipleOf);break;default:n=t.defaultError,a.assertNever(e)}return{message:n}},y=m,v=function(e){y=e},w=a.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]);function g(e,t,n){return n&&n.set(e,t),t}var b=function(e,t){if(t&&t.has(e))return t.get(e);switch(typeof e){case"undefined":return g(e,w.undefined,t);case"string":return g(e,w.string,t);case"number":return g(e,isNaN(e)?w.nan:w.number,t);case"boolean":return g(e,w.boolean,t);case"function":return g(e,w.function,t);case"bigint":return g(e,w.bigint,t);case"object":return Array.isArray(e)?g(e,w.array,t):null===e?g(e,w.null,t):e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?g(e,w.promise,t):"undefined"!=typeof Map&&e instanceof Map?g(e,w.map,t):"undefined"!=typeof Set&&e instanceof Set?g(e,w.set,t):"undefined"!=typeof Date&&e instanceof Date?g(e,w.date,t):g(e,w.object,t);default:return g(e,w.unknown,t)}},_=function(e){var t,n,r=e.data,i=e.path,a=e.errorMaps,o=e.issueData,l=d(d([],c(i),!1),c(o.path||[]),!1),h=s(s({},o),{path:l}),p="",f=a.filter((function(e){return!!e})).slice().reverse();try{for(var m=u(f),y=m.next();!y.done;y=m.next()){p=(0,y.value)(h,{data:r,defaultError:p}).message}}catch(e){t={error:e}}finally{try{y&&!y.done&&(n=m.return)&&n.call(m)}finally{if(t)throw t.error}}return s(s({},o),{path:l,message:o.message||p})},O=[];function k(e,t){var n=_({issueData:t,data:e.data,path:e.path,errorMaps:[e.contextualErrorMap,e.schemaErrorMap,y,m].filter((function(e){return!!e}))});e.issues.push(n)}var D,x=function(){function e(){this.value="valid"}return e.prototype.dirty=function(){"valid"===this.value&&(this.value="dirty")},e.prototype.abort=function(){"aborted"!==this.value&&(this.value="aborted")},e.mergeArray=function(e,t){var n,r,i=[];try{for(var a=u(t),s=a.next();!s.done;s=a.next()){var o=s.value;if("aborted"===o.status)return I;"dirty"===o.status&&e.dirty(),i.push(o.value)}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}return{status:e.value,value:i}},e.mergeObjectAsync=function(t,n){return o(this,void 0,void 0,(function(){var r,i,a,s,o,c,d,h,p,f;return l(this,(function(l){switch(l.label){case 0:r=[],l.label=1;case 1:l.trys.push([1,7,8,9]),i=u(n),a=i.next(),l.label=2;case 2:return a.done?[3,6]:(s=a.value,c=(o=r).push,f={},[4,s.key]);case 3:return f.key=l.sent(),[4,s.value];case 4:c.apply(o,[(f.value=l.sent(),f)]),l.label=5;case 5:return a=i.next(),[3,2];case 6:return[3,9];case 7:return d=l.sent(),h={error:d},[3,9];case 8:try{a&&!a.done&&(p=i.return)&&p.call(i)}finally{if(h)throw h.error}return[7];case 9:return[2,e.mergeObjectSync(t,r)]}}))}))},e.mergeObjectSync=function(e,t){var n,r,i={};try{for(var a=u(t),s=a.next();!s.done;s=a.next()){var o=s.value,l=o.key,c=o.value;if("aborted"===l.status)return I;if("aborted"===c.status)return I;"dirty"===l.status&&e.dirty(),"dirty"===c.status&&e.dirty(),(void 0!==c.value||o.alwaysSet)&&(i[l.value]=c.value)}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}return{status:e.value,value:i}},e}(),I=Object.freeze({status:"aborted"}),E=function(e){return{status:"dirty",value:e}},U=function(e){return{status:"valid",value:e}},N=function(e){return"aborted"===e.status},C=function(e){return"dirty"===e.status},S=function(e){return"valid"===e.status},j=function(e){return void 0!==typeof Promise&&e instanceof Promise};!function(e){e.errToObj=function(e){return"string"==typeof e?{message:e}:e||{}},e.toString=function(e){return"string"==typeof e?e:null==e?void 0:e.message}}(D||(D={}));var M=function(e,t){if(S(t))return{success:!0,data:t.value};if(!e.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,error:new f(e.issues)}};function T(e){if(!e)return{};var t=e.errorMap,n=e.invalid_type_error,r=e.required_error,i=e.description;if(t&&(n||r))throw new Error('Can\'t use "invalid" or "required" in conjunction with custom error map.');if(t)return{errorMap:t,description:i};return{errorMap:function(t,n){return"invalid_type"!==t.code?{message:n.defaultError}:void 0===n.data&&r?{message:r}:e.invalid_type_error?{message:e.invalid_type_error}:{message:n.defaultError}},description:i}}var P=function(){function e(e){this.spa=this.safeParseAsync,this.superRefine=this._refinement,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.default=this.default.bind(this),this.describe=this.describe.bind(this),this.isOptional=this.isOptional.bind(this),this.isNullable=this.isNullable.bind(this)}return Object.defineProperty(e.prototype,"description",{get:function(){return this._def.description},enumerable:!1,configurable:!0}),e.prototype._processInputParams=function(e){return{status:new x,ctx:s(s({},e.parent),{data:e.data,parsedType:b(e.data,e.parent.typeCache),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent})}},e.prototype._parseSync=function(e){var t=this._parse(e);if(j(t))throw new Error("Synchronous parse encountered promise.");return t},e.prototype._parseAsync=function(e){var t=this._parse(e);return Promise.resolve(t)},e.prototype.parse=function(e,t){var n=this.safeParse(e,t);if(n.success)return n.data;throw n.error},e.prototype.safeParse=function(e,t){var n,r={path:(null==t?void 0:t.path)||[],issues:[],contextualErrorMap:null==t?void 0:t.errorMap,schemaErrorMap:this._def.errorMap,async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,typeCache:"undefined"!=typeof Map?new Map:void 0,parent:null,data:e,parsedType:b(e)},i=this._parseSync({data:e,path:r.path,parent:r});return M(r,i)},e.prototype.parseAsync=function(e,t){return o(this,void 0,void 0,(function(){var n;return l(this,(function(r){switch(r.label){case 0:return[4,this.safeParseAsync(e,t)];case 1:if((n=r.sent()).success)return[2,n.data];throw n.error}}))}))},e.prototype.safeParseAsync=function(e,t){return o(this,void 0,void 0,(function(){var n,r,i;return l(this,(function(a){switch(a.label){case 0:return n={path:(null==t?void 0:t.path)||[],issues:[],contextualErrorMap:null==t?void 0:t.errorMap,schemaErrorMap:this._def.errorMap,async:!0,typeCache:"undefined"!=typeof Map?new Map:void 0,parent:null,data:e,parsedType:b(e)},r=this._parse({data:e,path:[],parent:n}),[4,j(r)?r:Promise.resolve(r)];case 1:return i=a.sent(),[2,M(n,i)]}}))}))},e.prototype.refine=function(e,t){return this._refinement((function(n,r){var i=e(n),a=function(){return r.addIssue(s({code:h.custom},function(e){return"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t}(n)))};return"undefined"!=typeof Promise&&i instanceof Promise?i.then((function(e){return!!e||(a(),!1)})):!!i||(a(),!1)}))},e.prototype.refinement=function(e,t){return this._refinement((function(n,r){return!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1)}))},e.prototype._refinement=function(e){return new ve({schema:this,typeName:pe.ZodEffects,effect:{type:"refinement",refinement:e}})},e.prototype.optional=function(){return we.create(this)},e.prototype.nullable=function(){return ge.create(this)},e.prototype.nullish=function(){return this.optional().nullable()},e.prototype.array=function(){return Y.create(this)},e.prototype.promise=function(){return ye.create(this)},e.prototype.or=function(e){return te.create([this,e])},e.prototype.and=function(e){return ie.create(this,e)},e.prototype.transform=function(e){return new ve({schema:this,typeName:pe.ZodEffects,effect:{type:"transform",transform:e}})},e.prototype.default=function(e){return new be({innerType:this,defaultValue:"function"==typeof e?e:function(){return e},typeName:pe.ZodDefault})},e.prototype.describe=function(e){return new(0,this.constructor)(s(s({},this._def),{description:e}))},e.prototype.isOptional=function(){return this.safeParse(void 0).success},e.prototype.isNullable=function(){return this.safeParse(null).success},e}(),A=/^c[^\s-]{8,}$/i,L=/^([a-f0-9]{8}-[a-f0-9]{4}-[1-5][a-f0-9]{3}-[a-f0-9]{4}-[a-f0-9]{12}|00000000-0000-0000-0000-000000000000)$/i,R=/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i,F=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._regex=function(e,n,r){return t.refinement((function(t){return e.test(t)}),s({validation:n,code:h.invalid_string},D.errToObj(r)))},t.nonempty=function(e){return t.min(1,D.errToObj(e))},t}return i(t,e),t.prototype._parse=function(e){var t,n,r=this._processInputParams(e),i=r.status,a=r.ctx;if(a.parsedType!==w.string)return k(a,{code:h.invalid_type,expected:w.string,received:a.parsedType}),I;try{for(var s=u(this._def.checks),o=s.next();!o.done;o=s.next()){var l=o.value;if("min"===l.kind)a.data.length<l.value&&(k(a,{code:h.too_small,minimum:l.value,type:"string",inclusive:!0,message:l.message}),i.dirty());else if("max"===l.kind)a.data.length>l.value&&(k(a,{code:h.too_big,maximum:l.value,type:"string",inclusive:!0,message:l.message}),i.dirty());else if("email"===l.kind)R.test(a.data)||(k(a,{validation:"email",code:h.invalid_string,message:l.message}),i.dirty());else if("uuid"===l.kind)L.test(a.data)||(k(a,{validation:"uuid",code:h.invalid_string,message:l.message}),i.dirty());else if("cuid"===l.kind)A.test(a.data)||(k(a,{validation:"cuid",code:h.invalid_string,message:l.message}),i.dirty());else if("url"===l.kind)try{new URL(a.data)}catch(e){k(a,{validation:"url",code:h.invalid_string,message:l.message}),i.dirty()}else if("regex"===l.kind){l.regex.lastIndex=0,l.regex.test(a.data)||(k(a,{validation:"regex",code:h.invalid_string,message:l.message}),i.dirty())}}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}return{status:i.value,value:a.data}},t.prototype._addCheck=function(e){return new t(s(s({},this._def),{checks:d(d([],c(this._def.checks),!1),[e],!1)}))},t.prototype.email=function(e){return this._addCheck(s({kind:"email"},D.errToObj(e)))},t.prototype.url=function(e){return this._addCheck(s({kind:"url"},D.errToObj(e)))},t.prototype.uuid=function(e){return this._addCheck(s({kind:"uuid"},D.errToObj(e)))},t.prototype.cuid=function(e){return this._addCheck(s({kind:"cuid"},D.errToObj(e)))},t.prototype.regex=function(e,t){return this._addCheck(s({kind:"regex",regex:e},D.errToObj(t)))},t.prototype.min=function(e,t){return this._addCheck(s({kind:"min",value:e},D.errToObj(t)))},t.prototype.max=function(e,t){return this._addCheck(s({kind:"max",value:e},D.errToObj(t)))},t.prototype.length=function(e,t){return this.min(e,t).max(e,t)},Object.defineProperty(t.prototype,"isEmail",{get:function(){return!!this._def.checks.find((function(e){return"email"===e.kind}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isURL",{get:function(){return!!this._def.checks.find((function(e){return"url"===e.kind}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isUUID",{get:function(){return!!this._def.checks.find((function(e){return"uuid"===e.kind}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isCUID",{get:function(){return!!this._def.checks.find((function(e){return"cuid"===e.kind}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"minLength",{get:function(){var e=-1/0;return this._def.checks.map((function(t){"min"===t.kind&&(null===e||t.value>e)&&(e=t.value)})),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxLength",{get:function(){var e=null;return this._def.checks.map((function(t){"max"===t.kind&&(null===e||t.value<e)&&(e=t.value)})),e},enumerable:!1,configurable:!0}),t.create=function(e){return new t(s({checks:[],typeName:pe.ZodString},T(e)))},t}(P);var H,Z=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.min=t.gte,t.max=t.lte,t.step=t.multipleOf,t}return i(t,e),t.prototype._parse=function(e){var t,n,r,i,s,o,l,c=this._processInputParams(e),d=c.status,p=c.ctx;if(p.parsedType!==w.number)return k(p,{code:h.invalid_type,expected:w.number,received:p.parsedType}),I;try{for(var f=u(this._def.checks),m=f.next();!m.done;m=f.next()){var y=m.value;if("int"===y.kind)a.isInteger(p.data)||(k(p,{code:h.invalid_type,expected:"integer",received:"float",message:y.message}),d.dirty());else if("min"===y.kind){(y.inclusive?p.data<y.value:p.data<=y.value)&&(k(p,{code:h.too_small,minimum:y.value,type:"number",inclusive:y.inclusive,message:y.message}),d.dirty())}else if("max"===y.kind){(y.inclusive?p.data>y.value:p.data>=y.value)&&(k(p,{code:h.too_big,maximum:y.value,type:"number",inclusive:y.inclusive,message:y.message}),d.dirty())}else"multipleOf"===y.kind?0!=(r=p.data,i=y.value,s=void 0,o=void 0,l=void 0,s=(r.toString().split(".")[1]||"").length,o=(i.toString().split(".")[1]||"").length,l=s>o?s:o,parseInt(r.toFixed(l).replace(".",""))%parseInt(i.toFixed(l).replace(".",""))/Math.pow(10,l))&&(k(p,{code:h.not_multiple_of,multipleOf:y.value,message:y.message}),d.dirty()):a.assertNever(y)}}catch(e){t={error:e}}finally{try{m&&!m.done&&(n=f.return)&&n.call(f)}finally{if(t)throw t.error}}return{status:d.value,value:p.data}},t.prototype.gte=function(e,t){return this.setLimit("min",e,!0,D.toString(t))},t.prototype.gt=function(e,t){return this.setLimit("min",e,!1,D.toString(t))},t.prototype.lte=function(e,t){return this.setLimit("max",e,!0,D.toString(t))},t.prototype.lt=function(e,t){return this.setLimit("max",e,!1,D.toString(t))},t.prototype.setLimit=function(e,n,r,i){return new t(s(s({},this._def),{checks:d(d([],c(this._def.checks),!1),[{kind:e,value:n,inclusive:r,message:D.toString(i)}],!1)}))},t.prototype._addCheck=function(e){return new t(s(s({},this._def),{checks:d(d([],c(this._def.checks),!1),[e],!1)}))},t.prototype.int=function(e){return this._addCheck({kind:"int",message:D.toString(e)})},t.prototype.positive=function(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:D.toString(e)})},t.prototype.negative=function(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:D.toString(e)})},t.prototype.nonpositive=function(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:D.toString(e)})},t.prototype.nonnegative=function(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:D.toString(e)})},t.prototype.multipleOf=function(e,t){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(t)})},Object.defineProperty(t.prototype,"minValue",{get:function(){var e,t,n=null;try{for(var r=u(this._def.checks),i=r.next();!i.done;i=r.next()){var a=i.value;"min"===a.kind&&(null===n||a.value>n)&&(n=a.value)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxValue",{get:function(){var e,t,n=null;try{for(var r=u(this._def.checks),i=r.next();!i.done;i=r.next()){var a=i.value;"max"===a.kind&&(null===n||a.value<n)&&(n=a.value)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isInt",{get:function(){return!!this._def.checks.find((function(e){return"int"===e.kind}))},enumerable:!1,configurable:!0}),t.create=function(e){return new t(s({checks:[],typeName:pe.ZodNumber},T(e)))},t}(P),$=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return t.parsedType!==w.bigint?(k(t,{code:h.invalid_type,expected:w.bigint,received:t.parsedType}),I):U(t.data)},t.create=function(e){return new t(s({typeName:pe.ZodBigInt},T(e)))},t}(P),z=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return t.parsedType!==w.boolean?(k(t,{code:h.invalid_type,expected:w.boolean,received:t.parsedType}),I):U(t.data)},t.create=function(e){return new t(s({typeName:pe.ZodBoolean},T(e)))},t}(P),G=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e),n=t.status,r=t.ctx;return r.parsedType!==w.date?(k(r,{code:h.invalid_type,expected:w.date,received:r.parsedType}),I):isNaN(r.data.getTime())?(k(r,{code:h.invalid_date}),I):{status:n.value,value:new Date(r.data.getTime())}},t.create=function(e){return new t(s({typeName:pe.ZodDate},T(e)))},t}(P),q=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return t.parsedType!==w.undefined?(k(t,{code:h.invalid_type,expected:w.undefined,received:t.parsedType}),I):U(t.data)},t.create=function(e){return new t(s({typeName:pe.ZodUndefined},T(e)))},t}(P),V=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return t.parsedType!==w.null?(k(t,{code:h.invalid_type,expected:w.null,received:t.parsedType}),I):U(t.data)},t.create=function(e){return new t(s({typeName:pe.ZodNull},T(e)))},t}(P),W=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._any=!0,t}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return U(t.data)},t.create=function(e){return new t(s({typeName:pe.ZodAny},T(e)))},t}(P),K=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._unknown=!0,t}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return U(t.data)},t.create=function(e){return new t(s({typeName:pe.ZodUnknown},T(e)))},t}(P),B=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return k(t,{code:h.invalid_type,expected:w.never,received:t.parsedType}),I},t.create=function(e){return new t(s({typeName:pe.ZodNever},T(e)))},t}(P),J=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return t.parsedType!==w.undefined?(k(t,{code:h.invalid_type,expected:w.void,received:t.parsedType}),I):U(t.data)},t.create=function(e){return new t(s({typeName:pe.ZodVoid},T(e)))},t}(P),Y=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e),n=t.status,r=t.ctx,i=this._def;if(r.parsedType!==w.array)return k(r,{code:h.invalid_type,expected:w.array,received:r.parsedType}),I;if(null!==i.minLength&&r.data.length<i.minLength.value&&(k(r,{code:h.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,message:i.minLength.message}),n.dirty()),null!==i.maxLength&&r.data.length>i.maxLength.value&&(k(r,{code:h.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,message:i.maxLength.message}),n.dirty()),r.async)return Promise.all(r.data.map((function(e,t){return i.type._parseAsync({parent:r,path:d(d([],c(r.path),!1),[t],!1),data:e})}))).then((function(e){return x.mergeArray(n,e)}));var a=r.data.map((function(e,t){return i.type._parseSync({parent:r,path:d(d([],c(r.path),!1),[t],!1),data:e})}));return x.mergeArray(n,a)},Object.defineProperty(t.prototype,"element",{get:function(){return this._def.type},enumerable:!1,configurable:!0}),t.prototype.min=function(e,n){return new t(s(s({},this._def),{minLength:{value:e,message:D.toString(n)}}))},t.prototype.max=function(e,n){return new t(s(s({},this._def),{maxLength:{value:e,message:D.toString(n)}}))},t.prototype.length=function(e,t){return this.min(e,t).max(e,t)},t.prototype.nonempty=function(e){return this.min(1,e)},t.create=function(e,n){return new t(s({type:e,minLength:null,maxLength:null,typeName:pe.ZodArray},T(n)))},t}(P);!function(e){e.mergeShapes=function(e,t){return s(s({},e),t)}}(H||(H={}));var Q=function(e){return function(t){return new ee(s(s({},e),{shape:function(){return s(s({},e.shape()),t)}}))}};function X(e){if(e instanceof ee){var t={};for(var n in e.shape){var r=e.shape[n];t[n]=we.create(X(r))}return new ee(s(s({},e._def),{shape:function(){return t}}))}return e instanceof Y?Y.create(X(e.element)):e instanceof we?we.create(X(e.unwrap())):e instanceof ge?ge.create(X(e.unwrap())):e instanceof ae?ae.create(e.items.map((function(e){return X(e)}))):e}var ee=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._cached=null,t.nonstrict=t.passthrough,t.augment=Q(t._def),t.extend=Q(t._def),t}return i(t,e),t.prototype._getCached=function(){if(null!==this._cached)return this._cached;var e=this._def.shape(),t=a.objectKeys(e);return this._cached={shape:e,keys:t}},t.prototype._parse=function(e){var t,n,r,i,s,p,f=this,m=this._processInputParams(e),y=m.status,v=m.ctx;if(v.parsedType!==w.object)return k(v,{code:h.invalid_type,expected:w.object,received:v.parsedType}),I;var g=this._getCached(),b=g.shape,_=g.keys,O=a.objectKeys(v.data).filter((function(e){return!_.includes(e)})),D=[];try{for(var E=u(_),U=E.next();!U.done;U=E.next()){var N=b[T=U.value],C=v.data[T];D.push({key:{status:"valid",value:T},value:N._parse({parent:v,data:C,path:d(d([],c(v.path),!1),[T],!1)}),alwaysSet:T in v.data})}}catch(e){t={error:e}}finally{try{U&&!U.done&&(n=E.return)&&n.call(E)}finally{if(t)throw t.error}}if(this._def.catchall instanceof B){var S=this._def.unknownKeys;if("passthrough"===S)try{for(var j=u(O),M=j.next();!M.done;M=j.next()){var T=M.value;D.push({key:{status:"valid",value:T},value:{status:"valid",value:v.data[T]}})}}catch(e){r={error:e}}finally{try{M&&!M.done&&(i=j.return)&&i.call(j)}finally{if(r)throw r.error}}else if("strict"===S)O.length>0&&(k(v,{code:h.unrecognized_keys,keys:O}),y.dirty());else if("strip"!==S)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{var P=this._def.catchall;try{for(var A=u(O),L=A.next();!L.done;L=A.next()){T=L.value,C=v.data[T];D.push({key:{status:"valid",value:T},value:P._parse({parent:v,path:d(d([],c(v.path),!1),[T],!1),data:C}),alwaysSet:T in v.data})}}catch(e){s={error:e}}finally{try{L&&!L.done&&(p=A.return)&&p.call(A)}finally{if(s)throw s.error}}}return v.async?Promise.resolve().then((function(){return o(f,void 0,void 0,(function(){var e,t,n,r,i,a,s,o,c,d,h;return l(this,(function(l){switch(l.label){case 0:e=[],l.label=1;case 1:l.trys.push([1,7,8,9]),t=u(D),n=t.next(),l.label=2;case 2:return n.done?[3,6]:[4,(r=n.value).key];case 3:return i=l.sent(),s=(a=e).push,h={key:i},[4,r.value];case 4:s.apply(a,[(h.value=l.sent(),h.alwaysSet=r.alwaysSet,h)]),l.label=5;case 5:return n=t.next(),[3,2];case 6:return[3,9];case 7:return o=l.sent(),c={error:o},[3,9];case 8:try{n&&!n.done&&(d=t.return)&&d.call(t)}finally{if(c)throw c.error}return[7];case 9:return[2,e]}}))}))})).then((function(e){return x.mergeObjectSync(y,e)})):x.mergeObjectSync(y,D)},Object.defineProperty(t.prototype,"shape",{get:function(){return this._def.shape()},enumerable:!1,configurable:!0}),t.prototype.strict=function(e){var n=this;return D.errToObj,new t(s(s(s({},this._def),{unknownKeys:"strict"}),void 0!==e?{errorMap:function(t,r){var i,a,s,o,l=null!==(s=null===(a=(i=n._def).errorMap)||void 0===a?void 0:a.call(i,t,r).message)&&void 0!==s?s:r.defaultError;return"unrecognized_keys"===t.code?{message:null!==(o=D.errToObj(e).message)&&void 0!==o?o:l}:{message:l}}}:{}))},t.prototype.strip=function(){return new t(s(s({},this._def),{unknownKeys:"strip"}))},t.prototype.passthrough=function(){return new t(s(s({},this._def),{unknownKeys:"passthrough"}))},t.prototype.setKey=function(e,t){var n;return this.augment(((n={})[e]=t,n))},t.prototype.merge=function(e){var n=this;return new t({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:function(){return H.mergeShapes(n._def.shape(),e._def.shape())},typeName:pe.ZodObject})},t.prototype.catchall=function(e){return new t(s(s({},this._def),{catchall:e}))},t.prototype.pick=function(e){var n=this,r={};return a.objectKeys(e).map((function(e){r[e]=n.shape[e]})),new t(s(s({},this._def),{shape:function(){return r}}))},t.prototype.omit=function(e){var n=this,r={};return a.objectKeys(this.shape).map((function(t){-1===a.objectKeys(e).indexOf(t)&&(r[t]=n.shape[t])})),new t(s(s({},this._def),{shape:function(){return r}}))},t.prototype.deepPartial=function(){return X(this)},t.prototype.partial=function(e){var n=this,r={};if(e)return a.objectKeys(this.shape).map((function(t){-1===a.objectKeys(e).indexOf(t)?r[t]=n.shape[t]:r[t]=n.shape[t].optional()})),new t(s(s({},this._def),{shape:function(){return r}}));for(var i in this.shape){var o=this.shape[i];r[i]=o.optional()}return new t(s(s({},this._def),{shape:function(){return r}}))},t.prototype.required=function(){var e={};for(var n in this.shape){for(var r=this.shape[n];r instanceof we;)r=r._def.innerType;e[n]=r}return new t(s(s({},this._def),{shape:function(){return e}}))},t.create=function(e,n){return new t(s({shape:function(){return e},unknownKeys:"strip",catchall:B.create(),typeName:pe.ZodObject},T(n)))},t.strictCreate=function(e,n){return new t(s({shape:function(){return e},unknownKeys:"strict",catchall:B.create(),typeName:pe.ZodObject},T(n)))},t.lazycreate=function(e,n){return new t(s({shape:e,unknownKeys:"strip",catchall:B.create(),typeName:pe.ZodObject},T(n)))},t}(P),te=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this,n=this._processInputParams(e).ctx,r=this._def.options;function i(e){var t,r,i,a,s;try{for(var o=u(e),l=o.next();!l.done;l=o.next()){if("valid"===(y=l.value).result.status)return y.result}}catch(e){t={error:e}}finally{try{l&&!l.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}try{for(var p=u(e),m=p.next();!m.done;m=p.next()){var y;if("dirty"===(y=m.value).result.status)return(s=n.issues).push.apply(s,d([],c(y.ctx.issues),!1)),y.result}}catch(e){i={error:e}}finally{try{m&&!m.done&&(a=p.return)&&a.call(p)}finally{if(i)throw i.error}}var v=e.map((function(e){return new f(e.ctx.issues)}));return k(n,{code:h.invalid_union,unionErrors:v}),I}return n.async?Promise.all(r.map((function(e){return o(t,void 0,void 0,(function(){var t,r;return l(this,(function(i){switch(i.label){case 0:return t=s(s({},n),{issues:[],parent:null}),r={},[4,e._parseAsync({data:n.data,path:n.path,parent:t})];case 1:return[2,(r.result=i.sent(),r.ctx=t,r)]}}))}))}))).then(i):i(r.map((function(e){var t=s(s({},n),{issues:[],parent:null});return{result:e._parseSync({data:n.data,path:n.path,parent:t}),ctx:t}})))},Object.defineProperty(t.prototype,"options",{get:function(){return this._def.options},enumerable:!1,configurable:!0}),t.create=function(e,n){return new t(s({options:e,typeName:pe.ZodUnion},T(n)))},t}(P),ne=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;if(t.parsedType!==w.object)return k(t,{code:h.invalid_type,expected:w.object,received:t.parsedType}),I;var n=this.discriminator,r=t.data[n],i=this.options.get(r);return i?t.async?i._parseAsync({data:t.data,path:t.path,parent:t}):i._parseSync({data:t.data,path:t.path,parent:t}):(k(t,{code:h.invalid_union_discriminator,options:this.validDiscriminatorValues,path:[n]}),I)},Object.defineProperty(t.prototype,"discriminator",{get:function(){return this._def.discriminator},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"validDiscriminatorValues",{get:function(){return Array.from(this.options.keys())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._def.options},enumerable:!1,configurable:!0}),t.create=function(e,n,r){var i=new Map;try{n.forEach((function(t){var n=t.shape[e].value;i.set(n,t)}))}catch(e){throw new Error("The discriminator value could not be extracted from all the provided schemas")}if(i.size!==n.length)throw new Error("Some of the discriminator values are not unique");return new t(s({typeName:pe.ZodDiscriminatedUnion,discriminator:e,options:i},T(r)))},t}(P);function re(e,t){var n,r,i=b(e),o=b(t);if(e===t)return{valid:!0,data:e};if(i===w.object&&o===w.object){var l=a.objectKeys(t),c=a.objectKeys(e).filter((function(e){return-1!==l.indexOf(e)})),d=s(s({},e),t);try{for(var h=u(c),p=h.next();!p.done;p=h.next()){var f=p.value;if(!(v=re(e[f],t[f])).valid)return{valid:!1};d[f]=v.data}}catch(e){n={error:e}}finally{try{p&&!p.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}return{valid:!0,data:d}}if(i===w.array&&o===w.array){if(e.length!==t.length)return{valid:!1};for(var m=[],y=0;y<e.length;y++){var v;if(!(v=re(e[y],t[y])).valid)return{valid:!1};m.push(v.data)}return{valid:!0,data:m}}return i===w.date&&o===w.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}var ie=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e),n=t.status,r=t.ctx,i=function(e,t){if(N(e)||N(t))return I;var i=re(e.value,t.value);return i.valid?((C(e)||C(t))&&n.dirty(),{status:n.value,value:i.data}):(k(r,{code:h.invalid_intersection_types}),I)};return r.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then((function(e){var t=c(e,2),n=t[0],r=t[1];return i(n,r)})):i(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))},t.create=function(e,n,r){return new t(s({left:e,right:n,typeName:pe.ZodIntersection},T(r)))},t}(P),ae=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this,n=this._processInputParams(e),r=n.status,i=n.ctx;if(i.parsedType!==w.array)return k(i,{code:h.invalid_type,expected:w.array,received:i.parsedType}),I;if(i.data.length<this._def.items.length)return k(i,{code:h.too_small,minimum:this._def.items.length,inclusive:!0,type:"array"}),I;!this._def.rest&&i.data.length>this._def.items.length&&(k(i,{code:h.too_big,maximum:this._def.items.length,inclusive:!0,type:"array"}),r.dirty());var a=i.data.map((function(e,n){var r=t._def.items[n]||t._def.rest;return r?r._parse({data:e,path:d(d([],c(i.path),!1),[n],!1),parent:i}):null})).filter((function(e){return!!e}));return i.async?Promise.all(a).then((function(e){return x.mergeArray(r,e)})):x.mergeArray(r,a)},Object.defineProperty(t.prototype,"items",{get:function(){return this._def.items},enumerable:!1,configurable:!0}),t.prototype.rest=function(e){return new t(s(s({},this._def),{rest:e}))},t.create=function(e,n){return new t(s({items:e,typeName:pe.ZodTuple,rest:null},T(n)))},t}(P),se=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"keySchema",{get:function(){return this._def.keyType},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"valueSchema",{get:function(){return this._def.valueType},enumerable:!1,configurable:!0}),t.prototype._parse=function(e){var t=this._processInputParams(e),n=t.status,r=t.ctx;if(r.parsedType!==w.object)return k(r,{code:h.invalid_type,expected:w.object,received:r.parsedType}),I;var i=[],a=this._def.keyType,s=this._def.valueType;for(var o in r.data)i.push({key:a._parse({data:o,path:d(d([],c(r.path),!1),[o],!1),parent:r}),value:s._parse({data:r.data[o],path:d(d([],c(r.path),!1),[o],!1),parent:r})});return r.async?x.mergeObjectAsync(n,i):x.mergeObjectSync(n,i)},Object.defineProperty(t.prototype,"element",{get:function(){return this._def.valueType},enumerable:!1,configurable:!0}),t.create=function(e,n,r){return new t(n instanceof P?s({keyType:e,valueType:n,typeName:pe.ZodRecord},T(r)):s({keyType:F.create(),valueType:e,typeName:pe.ZodRecord},T(n)))},t}(P),oe=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t,n,r=this,i=this._processInputParams(e),a=i.status,s=i.ctx;if(s.parsedType!==w.map)return k(s,{code:h.invalid_type,expected:w.map,received:s.parsedType}),I;var p=this._def.keyType,f=this._def.valueType,m=d([],c(s.data.entries()),!1).map((function(e,t){var n=c(e,2),r=n[0],i=n[1];return{key:p._parse({data:r,path:d(d([],c(s.path),!1),[t,"key"],!1),parent:s}),value:f._parse({data:i,path:d(d([],c(s.path),!1),[t,"value"],!1),parent:s})}}));if(s.async){var y=new Map;return Promise.resolve().then((function(){return o(r,void 0,void 0,(function(){var e,t,n,r,i,s,o,c;return l(this,(function(l){switch(l.label){case 0:l.trys.push([0,6,7,8]),e=u(m),t=e.next(),l.label=1;case 1:return t.done?[3,5]:[4,(n=t.value).key];case 2:return r=l.sent(),[4,n.value];case 3:if(i=l.sent(),"aborted"===r.status||"aborted"===i.status)return[2,I];"dirty"!==r.status&&"dirty"!==i.status||a.dirty(),y.set(r.value,i.value),l.label=4;case 4:return t=e.next(),[3,1];case 5:return[3,8];case 6:return s=l.sent(),o={error:s},[3,8];case 7:try{t&&!t.done&&(c=e.return)&&c.call(e)}finally{if(o)throw o.error}return[7];case 8:return[2,{status:a.value,value:y}]}}))}))}))}var v=new Map;try{for(var g=u(m),b=g.next();!b.done;b=g.next()){var _=b.value,O=_.key,D=_.value;if("aborted"===O.status||"aborted"===D.status)return I;"dirty"!==O.status&&"dirty"!==D.status||a.dirty(),v.set(O.value,D.value)}}catch(e){t={error:e}}finally{try{b&&!b.done&&(n=g.return)&&n.call(g)}finally{if(t)throw t.error}}return{status:a.value,value:v}},t.create=function(e,n,r){return new t(s({valueType:n,keyType:e,typeName:pe.ZodMap},T(r)))},t}(P),le=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e),n=t.status,r=t.ctx;if(r.parsedType!==w.set)return k(r,{code:h.invalid_type,expected:w.set,received:r.parsedType}),I;var i=this._def;null!==i.minSize&&r.data.size<i.minSize.value&&(k(r,{code:h.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,message:i.minSize.message}),n.dirty()),null!==i.maxSize&&r.data.size>i.maxSize.value&&(k(r,{code:h.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,message:i.maxSize.message}),n.dirty());var a=this._def.valueType;function s(e){var t,r,i=new Set;try{for(var a=u(e),s=a.next();!s.done;s=a.next()){var o=s.value;if("aborted"===o.status)return I;"dirty"===o.status&&n.dirty(),i.add(o.value)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return{status:n.value,value:i}}var o=d([],c(r.data.values()),!1).map((function(e,t){return a._parse({data:e,path:d(d([],c(r.path),!1),[t],!1),parent:r})}));return r.async?Promise.all(o).then((function(e){return s(e)})):s(o)},t.prototype.min=function(e,n){return new t(s(s({},this._def),{minSize:{value:e,message:D.toString(n)}}))},t.prototype.max=function(e,n){return new t(s(s({},this._def),{maxSize:{value:e,message:D.toString(n)}}))},t.prototype.size=function(e,t){return this.min(e,t).max(e,t)},t.prototype.nonempty=function(e){return this.min(1,e)},t.create=function(e,n){return new t(s({valueType:e,minSize:null,maxSize:null,typeName:pe.ZodSet},T(n)))},t}(P),ue=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.validate=t.implement,t}return i(t,e),t.prototype._parse=function(e){var t=this,n=this._processInputParams(e).ctx;if(n.parsedType!==w.function)return k(n,{code:h.invalid_type,expected:w.function,received:n.parsedType}),I;function r(e,t){return _({data:e,path:n.path,errorMaps:[n.contextualErrorMap,n.schemaErrorMap,y,m].filter((function(e){return!!e})),issueData:{code:h.invalid_arguments,argumentsError:t}})}function i(e,t){return _({data:e,path:n.path,errorMaps:[n.contextualErrorMap,n.schemaErrorMap,y,m].filter((function(e){return!!e})),issueData:{code:h.invalid_return_type,returnTypeError:t}})}var a={errorMap:n.contextualErrorMap},s=n.data;return this._def.returns instanceof ye?U((function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return o(t,void 0,void 0,(function(){var t,n,o;return l(this,(function(l){switch(l.label){case 0:return t=new f([]),[4,this._def.args.parseAsync(e,a).catch((function(n){throw t.addIssue(r(e,n)),t}))];case 1:return n=l.sent(),[4,s.apply(void 0,d([],c(n),!1))];case 2:return o=l.sent(),[4,this._def.returns._def.type.parseAsync(o,a).catch((function(e){throw t.addIssue(i(o,e)),t}))];case 3:return[2,l.sent()]}}))}))})):U((function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var o=t._def.args.safeParse(e,a);if(!o.success)throw new f([r(e,o.error)]);var l=s.apply(void 0,d([],c(o.data),!1)),u=t._def.returns.safeParse(l,a);if(!u.success)throw new f([i(l,u.error)]);return u.data}))},t.prototype.parameters=function(){return this._def.args},t.prototype.returnType=function(){return this._def.returns},t.prototype.args=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new t(s(s({},this._def),{args:ae.create(e).rest(K.create())}))},t.prototype.returns=function(e){return new t(s(s({},this._def),{returns:e}))},t.prototype.implement=function(e){return this.parse(e)},t.prototype.strictImplement=function(e){return this.parse(e)},t.create=function(e,n,r){return new t(s({args:e?e.rest(K.create()):ae.create([]).rest(K.create()),returns:n||K.create(),typeName:pe.ZodFunction},T(r)))},t}(P),ce=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"schema",{get:function(){return this._def.getter()},enumerable:!1,configurable:!0}),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return this._def.getter()._parse({data:t.data,path:t.path,parent:t})},t.create=function(e,n){return new t(s({getter:e,typeName:pe.ZodLazy},T(n)))},t}(P),de=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e),n=t.status,r=t.ctx;return r.data!==this._def.value?(k(r,{code:h.invalid_type,expected:b(this._def.value),received:r.parsedType}),I):{status:n.value,value:r.data}},Object.defineProperty(t.prototype,"value",{get:function(){return this._def.value},enumerable:!1,configurable:!0}),t.create=function(e,n){return new t(s({value:e,typeName:pe.ZodLiteral},T(n)))},t}(P);function he(e){return new fe({values:e,typeName:pe.ZodEnum})}var pe,fe=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return-1===this._def.values.indexOf(t.data)?(k(t,{code:h.invalid_enum_value,options:this._def.values}),I):U(t.data)},Object.defineProperty(t.prototype,"options",{get:function(){return this._def.values},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"enum",{get:function(){var e,t,n={};try{for(var r=u(this._def.values),i=r.next();!i.done;i=r.next()){var a=i.value;n[a]=a}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Values",{get:function(){var e,t,n={};try{for(var r=u(this._def.values),i=r.next();!i.done;i=r.next()){var a=i.value;n[a]=a}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Enum",{get:function(){var e,t,n={};try{for(var r=u(this._def.values),i=r.next();!i.done;i=r.next()){var a=i.value;n[a]=a}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),t.create=he,t}(P),me=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx,n=a.getValidEnumValues(this._def.values);return-1===n.indexOf(t.data)?(k(t,{code:h.invalid_enum_value,options:a.objectValues(n)}),I):U(t.data)},Object.defineProperty(t.prototype,"enum",{get:function(){return this._def.values},enumerable:!1,configurable:!0}),t.create=function(e,n){return new t(s({values:e,typeName:pe.ZodNativeEnum},T(n)))},t}(P),ye=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this,n=this._processInputParams(e).ctx;if(n.parsedType!==w.promise&&!1===n.async)return k(n,{code:h.invalid_type,expected:w.promise,received:n.parsedType}),I;var r=n.parsedType===w.promise?n.data:Promise.resolve(n.data);return U(r.then((function(e){return t._def.type.parseAsync(e,{path:n.path,errorMap:n.contextualErrorMap})})))},t.create=function(e,n){return new t(s({type:e,typeName:pe.ZodPromise},T(n)))},t}(P),ve=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype.innerType=function(){return this._def.schema},t.prototype._parse=function(e){var t=this,n=this._processInputParams(e),r=n.status,i=n.ctx,s=this._def.effect||null;if("preprocess"===s.type){var o=s.transform(i.data);return i.async?Promise.resolve(o).then((function(e){return t._def.schema._parseAsync({data:e,path:i.path,parent:i})})):this._def.schema._parseSync({data:o,path:i.path,parent:i})}if("refinement"===s.type){var l={addIssue:function(e){k(i,e),e.fatal?r.abort():r.dirty()},get path(){return i.path}};l.addIssue=l.addIssue.bind(l);var u=function(e){var t=s.refinement(e,l);if(i.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===i.async){var c=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});return"aborted"===c.status?I:("dirty"===c.status&&r.dirty(),u(c.value),{status:r.value,value:c.value})}return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then((function(e){return"aborted"===e.status?I:("dirty"===e.status&&r.dirty(),u(e.value).then((function(){return{status:r.value,value:e.value}})))}))}if("transform"===s.type){if(!1===i.async){var d=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});if(!S(d))return d;var h=s.transform(d.value);if(h instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return U(h)}return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then((function(e){return S(e)?Promise.resolve(s.transform(e.value)).then(U):e}))}a.assertNever(s)},t.create=function(e,n,r){return new t(s({schema:e,typeName:pe.ZodEffects,effect:n},T(r)))},t.createWithPreprocess=function(e,n,r){return new t(s({schema:n,effect:{type:"preprocess",transform:e},typeName:pe.ZodEffects},T(r)))},t}(P),we=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return t.parsedType===w.undefined?U(void 0):this._def.innerType._parse({data:t.data,path:t.path,parent:t})},t.prototype.unwrap=function(){return this._def.innerType},t.create=function(e,n){return new t(s({innerType:e,typeName:pe.ZodOptional},T(n)))},t}(P),ge=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx;return t.parsedType===w.null?U(null):this._def.innerType._parse({data:t.data,path:t.path,parent:t})},t.prototype.unwrap=function(){return this._def.innerType},t.create=function(e,n){return new t(s({innerType:e,typeName:pe.ZodNullable},T(n)))},t}(P),be=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e).ctx,n=t.data;return t.parsedType===w.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})},t.prototype.removeDefault=function(){return this._def.innerType},t.create=function(e,t){return new we(s({innerType:e,typeName:pe.ZodOptional},T(t)))},t}(P),_e=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._parse=function(e){var t=this._processInputParams(e),n=t.status,r=t.ctx;return r.parsedType!==w.nan?(k(r,{code:h.invalid_type,expected:w.nan,received:r.parsedType}),I):{status:n.value,value:r.data}},t.create=function(e){return new t(s({typeName:pe.ZodNaN},T(e)))},t}(P),Oe=function(e,t){return e?W.create().refine(e,t):W.create()},ke={object:ee.lazycreate};!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodPromise="ZodPromise"}(pe||(pe={}));var De=function(e,t){return void 0===t&&(t={message:"Input not instance of ".concat(e.name)}),Oe((function(t){return t instanceof e}),t)},xe=F.create,Ie=Z.create,Ee=_e.create,Ue=$.create,Ne=z.create,Ce=G.create,Se=q.create,je=V.create,Me=W.create,Te=K.create,Pe=B.create,Ae=J.create,Le=Y.create,Re=ee.create,Fe=ee.strictCreate,He=te.create,Ze=ne.create,$e=ie.create,ze=ae.create,Ge=se.create,qe=oe.create,Ve=le.create,We=ue.create,Ke=ce.create,Be=de.create,Je=fe.create,Ye=me.create,Qe=ye.create,Xe=ve.create,et=we.create,tt=ge.create,nt=ve.createWithPreprocess,rt=function(){return xe().optional()},it=function(){return Ie().optional()},at=function(){return Ne().optional()},st=Object.freeze({__proto__:null,ZodParsedType:w,getParsedType:b,makeIssue:_,EMPTY_PATH:O,addIssueToContext:k,ParseStatus:x,INVALID:I,DIRTY:E,OK:U,isAborted:N,isDirty:C,isValid:S,isAsync:j,ZodType:P,ZodString:F,ZodNumber:Z,ZodBigInt:$,ZodBoolean:z,ZodDate:G,ZodUndefined:q,ZodNull:V,ZodAny:W,ZodUnknown:K,ZodNever:B,ZodVoid:J,ZodArray:Y,get objectUtil(){return H},ZodObject:ee,ZodUnion:te,ZodDiscriminatedUnion:ne,ZodIntersection:ie,ZodTuple:ae,ZodRecord:se,ZodMap:oe,ZodSet:le,ZodFunction:ue,ZodLazy:ce,ZodLiteral:de,ZodEnum:fe,ZodNativeEnum:me,ZodPromise:ye,ZodEffects:ve,ZodTransformer:ve,ZodOptional:we,ZodNullable:ge,ZodDefault:be,ZodNaN:_e,custom:Oe,Schema:P,ZodSchema:P,late:ke,get ZodFirstPartyTypeKind(){return pe},any:Me,array:Le,bigint:Ue,boolean:Ne,date:Ce,discriminatedUnion:Ze,effect:Xe,enum:Je,function:We,instanceof:De,intersection:$e,lazy:Ke,literal:Be,map:qe,nan:Ee,nativeEnum:Ye,never:Pe,null:je,nullable:tt,number:Ie,object:Re,oboolean:at,onumber:it,optional:et,ostring:rt,preprocess:nt,promise:Qe,record:Ge,set:Ve,strictObject:Fe,string:xe,transformer:Xe,tuple:ze,undefined:Se,union:He,unknown:Te,void:Ae,ZodIssueCode:h,quotelessJson:p,ZodError:f,defaultErrorMap:m,get overrideErrorMap(){return y},setErrorMap:v})},(e,t,n)=>{n.r(t),n.d(t,{itemSchema:()=>l,getItem:()=>u,putItem:()=>c,deleteItem:()=>d,updateItemCreatedBy:()=>h,updateItemWebSourceURL:()=>p,updateItemPublicationDate:()=>f,updateItemTitle:()=>m,updateItemContent:()=>y,updateItemArrows:()=>v,updateItemAddSingleArrow:()=>w,updateItemArrowsDeleteArrow:()=>g,updateItemSourceURL:()=>b,itemPrefix:()=>O,randomItem:()=>k});var r=n(3),i=n(8),a=n(6);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){(0,r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const l=a.z.object({type:a.z.literal("item"),createdAt:a.z.string(),createdBy:a.z.string(),title:a.z.string(),content:a.z.string(),arrows:a.z.string(),highlight:a.z.string(),sourceURL:a.z.string(),webSourceURL:a.z.string(),publicationDate:a.z.string(),updatedAt:a.z.string()});async function u(e,t){const n=await e.get(_(t));if(!n)return console.log(`Specified item ${t} not found.`),null;let r={webSourceURL:"",publicationDate:"",updatedAt:(new Date).toISOString()};if(n.hasOwnProperty("webSourceURL")){const e=n;r.webSourceURL=e.webSourceURL}if(n.hasOwnProperty("publicationDate")){const e=n;r.publicationDate=e.publicationDate}if(n.hasOwnProperty("updatedAt")){const e=n;r.updatedAt=e.updatedAt}const i=n;return l.parse(o(o({},i),r))}function c(e,{id:t,item:n}){return e.put(_(t),n)}async function d(e,t){await e.del(_(t))}async function h(e,{id:t,createdBy:n}){const r=await u(e,t),i={createdBy:n,updatedAt:(new Date).toISOString()};return e.put(_(t),o(o({},r),i))}async function p(e,{id:t,webSourceURL:n}){const r=await u(e,t),i={webSourceURL:n,updatedAt:(new Date).toISOString()};return e.put(_(t),o(o({},r),i))}async function f(e,{id:t,publicationDate:n}){const r=await u(e,t),i={publicationDate:n,updatedAt:(new Date).toISOString()};return e.put(_(t),o(o({},r),i))}async function m(e,{id:t,title:n}){const r=await u(e,t),i={title:n,updatedAt:(new Date).toISOString()};return e.put(_(t),o(o({},r),i))}async function y(e,{id:t,content:n}){const r=await u(e,t),i={content:n,updatedAt:(new Date).toISOString()};return e.put(_(t),o(o({},r),i))}async function v(e,{id:t,arrows:n}){const r=await u(e,t),i={arrows:JSON.stringify(n),updatedAt:(new Date).toISOString()};return e.put(_(t),o(o({},r),i))}async function w(e,{id:t,arrow:n}){const r=await u(e,t);let i=r?JSON.parse(r.arrows):[];i.push(n);const a={arrows:JSON.stringify(i),updatedAt:(new Date).toISOString()},s=o(o({},r),a);return e.put(_(t),s)}async function g(e,{itemID:t,arrowID:n}){const r=await u(e,t);let i=r?JSON.parse(r.arrows):[];i=i.filter((e=>e.arrowID!==n));const a={arrows:JSON.stringify(i),updatedAt:(new Date).toISOString()},s=o(o({},r),a);return e.put(_(t),s)}async function b(e,{id:t,sourceURL:n}){const r=await u(e,t),i={sourceURL:n,updatedAt:(new Date).toISOString()};return e.put(_(t),o(o({},r),i))}function _(e){return`${O}${e}`}const O="item-";function k(){return{id:(0,i.nanoid)(),item:{type:"item",createdAt:(new Date).toISOString(),createdBy:"",title:"Untitled",content:"",arrows:"[]",highlight:"",sourceURL:"",webSourceURL:"",publicationDate:"",updatedAt:(new Date).toISOString()}}}},(e,t,n)=>{n.r(t),n.d(t,{nanoid:()=>o,customAlphabet:()=>s,customRandom:()=>a,urlAlphabet:()=>r.urlAlphabet,random:()=>i});var r=n(9);let i=e=>crypto.getRandomValues(new Uint8Array(e)),a=(e,t,n)=>{let r=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*r*t/e.length);return(a=t)=>{let s="";for(;;){let t=n(i),o=i;for(;o--;)if(s+=e[t[o]&r]||"",s.length===a)return s}}},s=(e,t=21)=>a(e,t,i),o=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let r=63&n[e];t+=r<36?r.toString(36):r<62?(r-26).toString(36).toUpperCase():r<63?"_":"-"}return t}},(e,t,n)=>{n.r(t),n.d(t,{urlAlphabet:()=>r});let r="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"},(e,t,n)=>{n.r(t),n.d(t,{arrowSchema:()=>l,getArrow:()=>u,putArrow:()=>c,deleteArrow:()=>d,updateArrowCreatedBy:()=>h,arrowPrefix:()=>f,randomArrow:()=>m});var r=n(3),i=n(8),a=n(6);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){(0,r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const l=a.z.object({type:a.z.literal("arrow"),createdAt:a.z.string(),createdBy:a.z.string(),frontItemID:a.z.string(),backItemID:a.z.string(),content:a.z.string(),highlight:a.z.string(),official:a.z.boolean(),to:a.z.number(),from:a.z.number(),parentItemID:a.z.string(),kind:a.z.string()});async function u(e,t){const n=await e.get(p(t));return n?l.parse(n):(console.log(`Specified arrow ${t} not found.`),null)}function c(e,{id:t,arrow:n}){return e.put(p(t),n)}async function d(e,t){await e.del(p(t))}async function h(e,{id:t,createdBy:n}){const r=await u(e,t);return e.put(p(t),o(o({},r),{},{createdBy:n}))}function p(e){return`${f}${e}`}const f="arrow-";function m(){return{id:(0,i.nanoid)(),arrow:{type:"arrow",createdAt:(new Date).toISOString(),createdBy:"",frontItemID:"",backItemID:"",content:"<p></p>",highlight:"<p></p>",official:!1,to:0,from:0,parentItemID:"",kind:""}}}}],t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};(()=>{n.r(r),n.d(r,{default:()=>i,RoomDO:()=>a,AuthDO:()=>s});var e=n(1),t=n(2);const{worker:i,RoomDO:a,AuthDO:s}=(0,e.createReflectServer)({mutators:t.serverMutators,authHandler:async(e,t)=>{const n=JSON.parse(e);if(!n)throw Error("Empty auth");if(n.roomID!==t)throw new Error("incorrect roomID");if(!n.userID||"string"!=typeof n.userID)throw new Error("Missing userID");return{userID:n.userID}},getLogSinks:function(){return[e.consoleLogSink]},getLogLevel:()=>"info"})})()})();